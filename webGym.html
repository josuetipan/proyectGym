<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Gym ‚Ä¢ Dashboard</title>
    <style>
      :root {
        --bg: #f5f5f5; /* Fondo gris claro */
        --panel: #f0f0f0; /* Panel gris medio */
        --muted: #e8e8e8; /* Elementos secundarios gris medio */
        --text: #000000; /* Texto principal negro puro */
        --sub: #000000; /* Texto secundario negro puro */
        --brand: #da83e0; /* Rosa/magenta principal */
        --accent: #da83e0; /* Acentos en rosa */
        --warn: #ffa726; /* Naranja para advertencias */
        --danger: #ef5350; /* Rojo para errores */
        --ok: #66bb6a; /* Verde para √©xito */
        --card: #ffffff; /* Tarjetas blancas */
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        --radius: 8px;
        --gradient: linear-gradient(135deg, #da83e0 0%, #c973cf 100%);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: #f5f5f5;
        color: var(--text);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
      }
      a {
        color: var(--text);
        text-decoration: none;
      }
      .hidden {
        display: none !important;
      }
      .btn {
        border: 0;
        cursor: pointer;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        background: #333333;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        font-size: 0.9rem;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        background: #222222;
      }
      .btn.primary {
        background: var(--gradient);
        color: white;
        font-weight: 700;
      }
      .btn.primary:hover {
        background: linear-gradient(135deg, #c973cf 0%, #b863b5 100%);
      }
      .btn.success {
        background: var(--ok);
        color: white;
      }
      .btn.warn {
        background: var(--warn);
        color: white;
      }
      .btn.danger {
        background: var(--danger);
        color: white;
      }
      .btn.ghost {
        background: transparent;
        border: 2px solid var(--brand);
        color: var(--text);
      }
      .btn.ghost:hover {
        background: var(--brand);
        color: white;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        background: #e0e0e0 !important;
        color: #999 !important;
        border-color: #ccc !important;
      }
      .btn:disabled:hover {
        transform: none !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      }
      .pill {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        background: #e0e0e0;
        color: var(--text);
        border: 1px solid #d0d0d0;
        font-weight: 500;
      }
      .layout {
        display: grid;
        grid-template-columns: auto 1fr;
        min-height: 100dvh;
        width: 100vw;
      }
      .sidebar {
        background: rgba(240, 240, 240, 0.95);
        backdrop-filter: blur(20px);
        border-right: 1px solid #d0d0d0;
        padding: 1rem;
        position: fixed;
        top: 0;
        left: 0;
        height: 100dvh;
        width: 240px;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        transition: all 0.3s ease;
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
        width: 240px;
      }
      .sidebar.closed {
        width: 60px;
        padding: 0.5rem;
        transform: translateX(0);
      }
      .sidebar.closed .brand {
        flex-direction: column;
        gap: 0.5rem;
        align-items: center;
      }
      .sidebar.closed .brand .logo {
        width: 40px;
        height: 40px;
      }
      .sidebar.closed .brand .logo img {
        width: 40px !important;
        height: 40px !important;
      }
      .sidebar.closed nav,
      .sidebar.closed .sep,
      .sidebar.closed .btn {
        display: none;
      }
      .sidebar.closed .menu-toggle {
        display: flex;
      }
      .menu-toggle {
        background: none;
        border: none;
        color: var(--text);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .menu-toggle:hover {
        background: rgba(218, 131, 224, 0.1);
        color: var(--brand);
      }
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
      }
      .sidebar-overlay.open {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--muted);
      }
      .brand .logo {
        width: 200px;
        height: 50px;
        border-radius: 0px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        color: white;
        font-size: 1.2rem;
        box-shadow: 0 8px 24px rgba(218, 131, 224, 0.014);
      }
      .brand h1 {
        font-size: 1.3rem;
        margin: 0;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 800;
      }
      nav {
        display: grid;
        gap: 0.5rem;
      }
      nav button {
        width: 100%;
        padding: 0.75rem 1rem;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        color: var(--text);
        text-align: left;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
      }
      nav button:hover {
        background: rgba(218, 131, 224, 0.1);
        border-color: var(--brand);
      }
      .content {
        padding: 2rem;
        background: #f5f5f5;
        margin-left: 60px;
        transition: margin-left 0.3s ease;
        width: calc(100vw - 60px);
      }
      .sidebar.open + .content {
        margin-left: 60px;
        width: calc(100vw - 60px);
      }
      @media (min-width: 768px) {
        .sidebar {
          position: sticky;
          transform: translateX(0);
          width: auto;
        }
        .content {
          margin-left: 0;
          width: 100%;
        }
        .sidebar .menu-toggle {
          display: none;
        }
      }
      .sidebar .menu-toggle:hover {
        background: rgba(218, 131, 224, 0.1);
        color: var(--brand);
      }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        background: #f0f0f0;
        border-radius: var(--radius);
        border: 1px solid #d0d0d0;
        box-shadow: var(--shadow);
      }
      .card {
        background: var(--card);
        border: 1px solid #e0e0e0;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        transition: all 0.2s ease;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: var(--brand);
        background: #f8f8f8;
      }
      .grid {
        display: grid;
        gap: 1.5rem;
      }
      .grid.cols-2 {
        grid-template-columns: 1fr 1fr;
      }
      .grid.cols-2.qr-layout {
        grid-template-columns: 0.6fr 1.4fr;
      }
      .grid.cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .grid.cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      .grid.cols-5 {
        grid-template-columns: repeat(5, 1fr);
      }
      @media (max-width: 1100px) {
        .grid.cols-3,
        .grid.cols-4,
        .grid.cols-5 {
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (max-width: 800px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: static;
          height: auto;
        }
        .grid.cols-2,
        .grid.cols-3,
        .grid.cols-4,
        .grid.cols-5 {
          grid-template-columns: 1fr;
        }
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e0e0e0;
      }
      th,
      td {
        padding: 1rem;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
        font-size: 0.95rem;
      }
      thead th {
        font-size: 0.85rem;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 700;
        background: #e0e0e0;
      }
      tbody tr:hover {
        background: rgba(218, 131, 224, 0.08);
      }
      .input,
      .select,
      .date {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #e8e8e8;
        color: var(--text);
        font-size: 0.9rem;
        transition: all 0.2s ease;
      }
      .input:focus,
      .select:focus,
      .date:focus {
        outline: none;
        border-color: var(--brand);
        background: #d8d8d8;
        box-shadow: 0 0 0 3px rgba(218, 131, 224, 0.1);
      }
      .row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .kpi {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .avatar {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        background: var(--panel);
        border: 2px solid var(--brand);
        object-fit: cover;
        box-shadow: 0 8px 24px rgba(218, 131, 224, 0.2);
      }
      .section-title {
        margin: 0 0 1.5rem 0;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        color: var(--text);
        font-weight: 700;
      }
      .section-title::before {
        content: "";
        width: 4px;
        height: 24px;
        background: var(--gradient);
        border-radius: 2px;
      }
      .muted {
        color: var(--sub);
      }
      .badge {
        padding: 0.3rem 0.8rem;
        border-radius: 999px;
        border: 1px solid;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .tag-success {
        background: rgba(102, 187, 106, 0.1);
        color: #66bb6a;
        border-color: #66bb6a;
      }
      .tag-warn {
        background: rgba(255, 167, 38, 0.1);
        color: #ffa726;
        border-color: #ffa726;
      }
      .tag-danger {
        background: rgba(239, 83, 80, 0.1);
        color: #ef5350;
        border-color: #ef5350;
      }
      .mini {
        font-size: 0.9rem;
      }
      .toolbar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .video {
        width: 100%;
        border-radius: 16px;
        background: var(--panel);
        min-height: 250px;
        border: 2px solid var(--muted);
      }
      .footer {
        padding: 2rem;
        color: var(--sub);
        text-align: center;
        margin-top: 2rem;
        border-top: 1px solid var(--muted);
      }
      .login {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        background: linear-gradient(
          135deg,
          #ffffff 0%,
          #f8f9fa 50%,
          #ffffff 100%
        );
        border-radius: 0;
        box-shadow: none;
        border: none;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .login::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 30% 20%,
            rgba(218, 131, 224, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 70% 80%,
            rgba(255, 107, 157, 0.05) 0%,
            transparent 50%
          );
        pointer-events: none;
      }

      .login-container {
        width: 100%;
        max-width: 100%;
        padding: 6rem 4rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 0;
        border: 2px solid rgba(218, 131, 224, 0.2);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 8rem;
        min-height: 100vh;
      }

      .login-left {
        flex: 1;
        text-align: center;
      }

      .login-right {
        flex: 1;
        max-width: 600px;
        padding: 2rem;
      }
      .brand-lg {
        justify-content: center;
        margin-bottom: 2.5rem;
        text-align: center;
      }
      .brand-lg .logo {
        width: 100%;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 4rem;
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        border: none;
      }
      .brand-lg h1 {
        font-size: 4.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--brand) 0%, #ff6b9d 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 1.5rem 0;
        text-shadow: 0 2px 10px rgba(218, 131, 224, 0.2);
      }
      .brand-lg .muted {
        font-size: 1.8rem;
        color: #2c3e50;
        font-weight: 500;
      }

      /* Efectos hover para inputs del login */
      .login input:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(218, 131, 224, 0.2);
        outline: none;
        background: rgba(255, 255, 255, 1);
      }

      .login input:hover {
        border-color: var(--brand);
        box-shadow: 0 4px 20px rgba(218, 131, 224, 0.2);
        background: rgba(255, 255, 255, 1);
      }

      .login button:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(218, 131, 224, 0.5);
        background: linear-gradient(135deg, #ff6b9d 0%, var(--brand) 100%);
      }

      .login button:active {
        transform: translateY(-1px);
      }

      /* Estilos para placeholders */
      .login input::placeholder {
        color: #7f8c8d;
        opacity: 0.8;
      }

      .login input:focus::placeholder {
        color: var(--brand);
        opacity: 0.6;
      }
      .sep {
        height: 2px;
        background: var(--gradient);
        margin: 1.5rem 0;
        border-radius: 1px;
      }

      /* Efectos adicionales */
      .card h4 {
        color: var(--text);
        margin: 0 0 1rem 0;
        font-weight: 600;
      }

      /* Animaciones */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card {
        animation: fadeIn 0.5s ease-out;
      }

      /* Scrollbar personalizado */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #e8e8e8;
      }
      ::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* Estilos para submen√∫s */
      .menu-group-btn {
        transition: all 0.3s ease;
        background: #333333;
        color: white;
      }

      .menu-group-btn:hover {
        background: #333333;
        color: white;
      }

      .menu-arrow {
        transition: transform 0.3s ease;
      }

      .submenu-btn {
        background: #333333;
        border: 1px solid #444444;
        transition: all 0.2s ease;
        color: white;
        text-align: left;
        justify-content: flex-start;
        padding-left: 1rem;
        margin-left: 0;
        width: 100%;
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        margin-bottom: 0.2rem;
      }

      .submenu-btn:hover {
        background: #333333;
        transform: translateX(5px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .submenu-btn.primary {
        background: var(--brand);
        color: white;
        font-weight: 600;
        border-color: var(--brand);
      }

      .submenu {
        transition: all 0.3s ease;
        border-left: 2px solid var(--muted);
        margin-left: 0;
        padding-left: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <section id="loginView" class="login card">
      <div class="login-container">
        <div class="login-left">
          <div class="brand brand-lg">
            <div class="logo">
              <img
                src="https://i.postimg.cc/gJ1CkzFn/imagen-2025-08-10-181755691-removebg-preview.png"
                alt="Admin Gym Logo"
                style="width: 300px; height: 300px; object-fit: contain"
              />
            </div>
          </div>

          <div style="text-align: center">
            <h2
              style="
                margin: 0 0 0rem 0;
                color: #2c3e50;
                font-weight: 700;
                font-size: 2.5rem;
              "
            >
              Bienvenido
            </h2>
            <p
              style="
                margin: 0;
                color: #34495e;
                font-size: 1.5rem;
                font-weight: 400;
                line-height: 1.8;
              "
            >
              Accede a tu panel de administraci√≥n<br />
              y gestiona tu gimnasio de manera eficiente<br />
              con herramientas modernas y profesionales
            </p>
          </div>
        </div>

        <div
          class="login-right"
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          "
        >
          <div style="text-align: center; margin-bottom: 3rem">
            <h3
              style="
                margin: 0 0 1rem 0;
                color: #2c3e50;
                font-weight: 700;
                font-size: 1.8rem;
              "
            >
              Iniciar Sesi√≥n
            </h3>
            <p
              style="
                margin: 0;
                color: #34495e;
                font-size: 1rem;
                font-weight: 400;
              "
            >
              Ingresa tus credenciales para continuar
            </p>
          </div>

          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 1.5rem;
              width: 100%;
              max-width: 350px;
            "
          >
            <div style="position: relative; width: 100%">
              <input
                id="loginEmail"
                class="input"
                type="email"
                placeholder="Correo electr√≥nico"
                value="admin@gym.com"
                style="
                  width: 100%;
                  padding: 1rem 1rem 1rem 3rem;
                  border-radius: 12px;
                  border: 2px solid rgba(218, 131, 224, 0.3);
                  background: rgba(255, 255, 255, 0.9);
                  font-size: 1rem;
                  color: #2c3e50;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                  backdrop-filter: blur(10px);
                "
              />
              <svg
                style="
                  position: absolute;
                  left: 1rem;
                  top: 50%;
                  transform: translateY(-50%);
                  width: 20px;
                  height: 20px;
                  color: var(--brand);
                "
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"
                ></path>
              </svg>
            </div>

            <div style="position: relative; width: 100%">
              <input
                id="loginPass"
                class="input"
                type="password"
                placeholder="Contrase√±a"
                value="admin123"
                style="
                  width: 100%;
                  padding: 1rem 1rem 1rem 3rem;
                  border-radius: 12px;
                  border: 2px solid rgba(218, 131, 224, 0.3);
                  background: rgba(255, 255, 255, 0.9);
                  font-size: 1rem;
                  color: #2c3e50;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                  backdrop-filter: blur(10px);
                "
              />
              <svg
                style="
                  position: absolute;
                  left: 1rem;
                  top: 50%;
                  transform: translateY(-50%);
                  width: 20px;
                  height: 20px;
                  color: var(--brand);
                "
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                ></path>
              </svg>
            </div>

            <button
              class="btn primary"
              onclick="doLogin()"
              style="
                width: 100%;
                padding: 1rem 2rem;
                border-radius: 12px;
                font-size: 1.1rem;
                font-weight: 600;
                background: linear-gradient(
                  135deg,
                  var(--brand) 0%,
                  #ff6b9d 100%
                );
                border: none;
                box-shadow: 0 8px 25px rgba(218, 131, 224, 0.4);
                transition: all 0.3s ease;
                margin-top: 0.5rem;
                color: white;
              "
            >
              Iniciar Sesi√≥n
            </button>
          </div>

          <div
            style="
              text-align: center;
              margin-top: 2rem;
              padding: 1.5rem;
              background: rgba(255, 255, 255, 0.8);
              border-radius: 12px;
              border: 1px solid rgba(218, 131, 224, 0.2);
              backdrop-filter: blur(10px);
              width: 100%;
              max-width: 350px;
            "
          >
            <p
              style="
                margin: 0;
                color: #34495e;
                font-size: 0.95rem;
                font-weight: 500;
              "
            >
              <strong style="color: var(--brand)">Demo:</strong> admin@gym.com /
              admin123
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- APP LAYOUT -->
    <section id="appView" class="hidden">
      <div class="sidebar-overlay" onclick="closeSidebar()"></div>
      <div class="layout">
        <aside class="sidebar closed">
          <div class="brand">
            <div class="logo">
              <img
                src="https://i.postimg.cc/gJ1CkzFn/imagen-2025-08-10-181755691-removebg-preview.png"
                alt="GYM Admin"
                style="width: 80px; height: 60px"
              />
            </div>
            <button class="menu-toggle" onclick="toggleSidebar()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M3 12H21M3 6H21M3 18H21"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
          <nav id="menu"></nav>
          <div class="sep"></div>
          <button class="btn ghost" onclick="logout()">Cerrar sesi√≥n</button>
        </aside>

        <main class="content">
          <div
            class="topbar"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="row kpi">
              <span class="pill" id="todayInfo"></span>
            </div>

            <div
              class="row kpi"
              style="display: flex; align-items: center; gap: 1rem"
            >
              <!-- Selector de Sucursal -->
              <div class="sucursal-selector" style="position: relative">
                <button
                  class="sucursal-btn"
                  onclick="toggleSucursalDropdown()"
                  style="
                    background: var(--panel);
                    border: 1px solid var(--muted);
                    border-radius: 8px;
                    padding: 0.5rem 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    cursor: pointer;
                    color: var(--text);
                    font-weight: 600;
                    transition: all 0.2s ease;
                    min-width: 150px;
                  "
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21 10C21 17 12 23 12 23S3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <circle
                      cx="12"
                      cy="10"
                      r="3"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span id="sucursalActual">Matriz</span>
                  <svg
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M6 9L12 15L18 9"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
                <div
                  id="sucursalDropdown"
                  class="sucursal-dropdown"
                  style="
                    position: absolute;
                    top: 100%;
                    right: 0;
                    background: white;
                    border: 1px solid var(--muted);
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    min-width: 200px;
                    z-index: 1000;
                    display: none;
                    margin-top: 0.5rem;
                  "
                >
                  <div style="padding: 0.5rem">
                    <div
                      style="
                        font-size: 0.8rem;
                        color: var(--sub);
                        padding: 0.5rem;
                        border-bottom: 1px solid var(--muted);
                        margin-bottom: 0.5rem;
                      "
                    >
                      Seleccionar Sucursal
                    </div>
                    <div class="sucursal-options">
                      <div
                        class="sucursal-option"
                        onclick="cambiarSucursal('Matriz')"
                        style="
                          display: flex;
                          align-items: center;
                          gap: 0.5rem;
                          padding: 0.8rem;
                          border-radius: 6px;
                          cursor: pointer;
                          transition: all 0.2s ease;
                        "
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M21 10C21 17 12 23 12 23S3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                          <circle
                            cx="12"
                            cy="10"
                            r="3"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                        <span>Matriz</span>
                      </div>
                      <div
                        class="sucursal-option"
                        onclick="cambiarSucursal('Ponciano')"
                        style="
                          display: flex;
                          align-items: center;
                          gap: 0.5rem;
                          padding: 0.8rem;
                          border-radius: 6px;
                          cursor: pointer;
                          transition: all 0.2s ease;
                        "
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M21 10C21 17 12 23 12 23S3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                          <circle
                            cx="12"
                            cy="10"
                            r="3"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                        <span>Ponciano</span>
                      </div>
                      <div
                        class="sucursal-option"
                        onclick="cambiarSucursal('QT')"
                        style="
                          display: flex;
                          align-items: center;
                          gap: 0.5rem;
                          padding: 0.8rem;
                          border-radius: 6px;
                          cursor: pointer;
                          transition: all 0.2s ease;
                        "
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M21 10C21 17 12 23 12 23S3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                          <circle
                            cx="12"
                            cy="10"
                            r="3"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                        <span>QT</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Bot√≥n Recargar Datos -->
              <button
                onclick="limpiarDatosYRecargar()"
                style="
                  background: var(--danger);
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 0.8rem;
                "
                title="Limpiar datos y recargar (para ver nuevos clientes)"
              >
                üîÑ Recargar Datos
              </button>
            </div>
          </div>

          <!-- DASHBOARD TABS RENDER -->
          <div id="viewRoot" class="grid"></div>

          <footer class="footer muted mini">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1200px;
                margin: 0 auto;
              "
            >
              <div>Dashboard Gym ‚Ä¢ Sistema de Administraci√≥n</div>
              <div style="display: flex; gap: 1rem; align-items: center">
                <span style="color: var(--text)">‚óè</span>
                <span>Datos locales</span>
                <span style="color: var(--text)">‚óè</span>
                <span>Sin backend</span>
              </div>
            </div>
          </footer>
        </main>
      </div>
    </section>

    <!-- Modal Nuevo Cargo -->
    <div
      id="modalCargo"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          border-radius: 12px;
          padding: 1rem;
          width: 90%;
          max-width: 350px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h3
            style="
              margin: 0;
              color: var(--text);
              font-size: 1.3rem;
              font-weight: 700;
            "
          >
            Nuevo Cargo
          </h3>
          <button
            onclick="cerrarModalCargo()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--sub);
            "
          >
            &times;
          </button>
        </div>

        <form id="formCargo">
          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Fecha</label
            >
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <input
                type="datetime-local"
                id="cargoFecha"
                style="
                  flex: 1;
                  padding: 0.8rem;
                  border: 1px solid var(--muted);
                  border-radius: 6px;
                  background: white;
                "
              />
              <button
                type="button"
                style="
                  background: var(--panel);
                  border: 1px solid var(--muted);
                  border-radius: 6px;
                  padding: 0.8rem;
                  cursor: pointer;
                "
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M3 3H21V7H3V3ZM3 9H21V21H3V9Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Detalle</label
            >
            <input
              type="text"
              id="cargoDetalle"
              placeholder="Ingrese los detalles del Cargo..."
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            />
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Monto</label
            >
            <div style="display: flex; align-items: center">
              <button
                type="button"
                style="
                  background: var(--panel);
                  border: 1px solid var(--muted);
                  border-right: none;
                  border-radius: 6px 0 0 6px;
                  padding: 0.8rem;
                  font-weight: 600;
                  color: var(--text);
                "
              >
                $
              </button>
              <input
                type="number"
                id="cargoMonto"
                placeholder="Ingrese el monto..."
                step="0.01"
                style="
                  flex: 1;
                  padding: 0.8rem;
                  border: 1px solid var(--muted);
                  border-radius: 0 6px 6px 0;
                  background: white;
                "
              />
            </div>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Sucursal</label
            >
            <select
              id="cargoSucursal"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            >
              <option value="Matriz">Matriz</option>
              <option value="Ponciano">Ponciano</option>
              <option value="QT">QT</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Notas</label
            >
            <textarea
              id="cargoNotas"
              placeholder="Detalle del Cargo"
              rows="3"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
                resize: vertical;
              "
            ></textarea>
          </div>

          <div style="margin-bottom: 1.5rem">
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="cargoRegistrarPago"
                style="margin: 0"
              />
              <span style="color: var(--text)"
                >Registrar un pago por el mismo monto.</span
              >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                style="color: var(--sub)"
              >
                <path
                  d="M9.09 9C9.3251 8.33167 9.78918 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.30197 14.92 10C14.92 12 11.92 13 11.92 13M12 17H12.01"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </label>
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 1rem">
            <button
              type="button"
              onclick="cerrarModalCargo()"
              style="
                background: var(--panel);
                color: var(--text);
                border: 1px solid var(--muted);
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 6L6 18M6 6L18 18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Cancelar
            </button>
            <button
              type="submit"
              style="
                background: var(--ok);
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Nuevo Pago -->
    <div
      id="modalPago"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          border-radius: 12px;
          padding: 1.5rem;
          width: 90%;
          max-width: 500px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h3
            style="
              margin: 0;
              color: var(--text);
              font-size: 1.3rem;
              font-weight: 700;
            "
          >
            Nuevo Pago
          </h3>
          <button
            onclick="cerrarModalPago()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--sub);
            "
          >
            &times;
          </button>
        </div>

        <form id="formPago">
          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Fecha</label
            >
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <input
                type="datetime-local"
                id="pagoFecha"
                style="
                  flex: 1;
                  padding: 0.8rem;
                  border: 1px solid var(--muted);
                  border-radius: 6px;
                  background: white;
                "
              />
              <button
                type="button"
                style="
                  background: var(--panel);
                  border: 1px solid var(--muted);
                  border-radius: 6px;
                  padding: 0.8rem;
                  cursor: pointer;
                "
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M3 3H21V7H3V3ZM3 9H21V21H3V9Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Detalle</label
            >
            <input
              type="text"
              id="pagoDetalle"
              placeholder="Ingrese los detalles del Pago..."
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            />
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Monto</label
            >
            <div style="display: flex; align-items: center">
              <button
                type="button"
                style="
                  background: var(--panel);
                  border: 1px solid var(--muted);
                  border-right: none;
                  border-radius: 6px 0 0 6px;
                  padding: 0.8rem;
                  font-weight: 600;
                  color: var(--text);
                "
              >
                $
              </button>
              <input
                type="number"
                id="pagoMonto"
                placeholder="Ingrese el monto..."
                step="0.01"
                style="
                  flex: 1;
                  padding: 0.8rem;
                  border: 1px solid var(--muted);
                  border-radius: 0 6px 6px 0;
                  background: white;
                "
              />
            </div>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >M√©todo de Pago</label
            >
            <select
              id="pagoMetodo"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            >
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Dep√≥sito">Dep√≥sito</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Sucursal</label
            >
            <select
              id="pagoSucursal"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            >
              <option value="Matriz">Matriz</option>
              <option value="Ponciano">Ponciano</option>
              <option value="QT">QT</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Notas</label
            >
            <textarea
              id="pagoNotas"
              placeholder="Detalle del Pago"
              rows="3"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
                resize: vertical;
              "
            ></textarea>
          </div>

          <div style="margin-bottom: 1.5rem">
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="pagoEsProducto"
                style="width: 16px; height: 16px"
              />
              <span style="color: var(--text); font-weight: 500"
                >Es el pago de un producto ?</span
              >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                style="color: var(--sub)"
              >
                <path
                  d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3M12 17h.01"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </label>
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 1rem">
            <button
              type="button"
              onclick="cerrarModalPago()"
              style="
                background: var(--panel);
                color: var(--text);
                border: 1px solid var(--muted);
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 6L6 18M6 6L18 18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Cancelar
            </button>
            <button
              type="submit"
              style="
                background: var(--ok);
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Nueva Membres√≠a -->
    <div
      id="modalMembresia"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          border-radius: 12px;
          padding: 1rem;
          width: 90%;
          max-width: 350px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h3
            style="
              margin: 0;
              color: var(--text);
              font-size: 1.3rem;
              font-weight: 700;
            "
          >
            Nueva Membres√≠a
          </h3>
          <button
            onclick="cerrarModalMembresia()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--sub);
            "
          >
            &times;
          </button>
        </div>

        <form id="formMembresia">
          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Actividad</label
            >
            <select
              id="membresiaActividad"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            >
              <option value="">Seleccionar actividad...</option>
              <option value="Plan Anual">Plan Anual</option>
              <option value="Plan Mensual">Plan Mensual</option>
              <option value="Plan Trimestral">Plan Trimestral</option>
              <option value="Plan Semanal">Plan Semanal</option>
              <option value="Plan Diario">Plan Diario</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Fecha de Inicio</label
            >
            <input
              type="date"
              id="membresiaFechaInicio"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            />
          </div>

          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                margin-bottom: 0.5rem;
                color: var(--text);
                font-weight: 600;
              "
              >Descuento</label
            >
            <select
              id="membresiaDescuento"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            >
              <option value="">Seleccionar descuento...</option>
              <option value="Todas">Todas</option>
              <option value="Sin descuento">Sin descuento</option>
              <option value="10%">10%</option>
              <option value="20%">20%</option>
              <option value="30%">30%</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem">
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                color: var(--text);
                font-weight: 600;
              "
            >
              <input
                type="checkbox"
                id="membresiaCambioApp"
                style="width: 18px; height: 18px; margin: 0; cursor: pointer"
              />
              Cambio en la app
            </label>
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 1rem">
            <button
              type="button"
              onclick="cerrarModalMembresia()"
              style="
                background: var(--panel);
                color: var(--text);
                border: 1px solid var(--muted);
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 6L6 18M6 6L18 18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Cancelar
            </button>
            <button
              type="submit"
              style="
                background: var(--ok);
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 5V19M5 12H19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Agregar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Enviar WhatsApp -->
    <div
      id="modalWhatsApp"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          border-radius: 12px;
          padding: 1.5rem;
          width: 90%;
          max-width: 600px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h3
            style="
              margin: 0;
              color: var(--text);
              font-size: 1.3rem;
              font-weight: 700;
            "
          >
            Enviar WhatsApp
          </h3>
          <button
            onclick="cerrarModalWhatsApp()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--sub);
            "
          >
            &times;
          </button>
        </div>

        <!-- Instrucciones -->
        <div
          style="
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
          "
        >
          <div
            style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text)"
          >
            Instrucciones:
          </div>
          <div
            style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.3rem"
          >
            ‚Ä¢ Coloc√° siempre el c√≥digo de pa√≠s al inicio
          </div>
          <div
            style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.3rem"
          >
            ‚Ä¢ No te olvides de quitar el 0 y el 15.
          </div>
          <div
            style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.3rem"
          >
            ‚Ä¢ Ejemplos: Argentina (5493425672626), Chile (56945220978)
          </div>
          <a
            href="#"
            style="color: #007bff; text-decoration: none; font-size: 0.9rem"
            >Leer m√°s</a
          >
        </div>

        <!-- Aviso importante -->
        <div
          style="
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
          "
        >
          <div style="font-weight: 700; color: #856404; margin-bottom: 0.3rem">
            Importante
          </div>
          <div style="font-size: 0.9rem; color: #856404">
            Por pol√≠ticas de privacidad de WhatsApp recorda agendar a esta
            persona previamente para que pueda recibir correctamente los
            mensajes.
          </div>
        </div>

        <form id="formWhatsApp">
          <div style="display: flex; align-items: center; margin-bottom: 1rem">
            <label style="width: 100px; font-weight: 600; color: var(--text)"
              >Tel√©fono:</label
            >
            <input
              type="text"
              id="whatsappTelefono"
              placeholder="Ej: 593991234567"
              style="
                flex: 1;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            />
          </div>

          <div style="display: flex; align-items: center; margin-bottom: 1rem">
            <label style="width: 100px; font-weight: 600; color: var(--text)"
              >Plantilla:</label
            >
            <select
              id="whatsappPlantilla"
              style="
                flex: 1;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
              "
            >
              <option value="deudor">Usuario Deudor</option>
              <option value="recordatorio">Recordatorio de Pago</option>
              <option value="bienvenida">Bienvenida</option>
              <option value="membresia">Renovaci√≥n de Membres√≠a</option>
              <option value="personalizado">Mensaje Personalizado</option>
            </select>
          </div>

          <div style="margin-bottom: 1.5rem">
            <label
              style="
                display: block;
                font-weight: 600;
                color: var(--text);
                margin-bottom: 0.5rem;
              "
              >Mensaje:</label
            >
            <textarea
              id="whatsappMensaje"
              rows="8"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--muted);
                border-radius: 6px;
                background: white;
                resize: vertical;
              "
            ></textarea>
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 1rem">
            <button
              type="button"
              onclick="cerrarModalWhatsApp()"
              style="
                background: var(--panel);
                color: var(--text);
                border: 1px solid var(--muted);
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18 6L6 18M6 6L18 18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Cerrar
            </button>
            <button
              type="button"
              onclick="abrirWhatsApp()"
              style="
                background: #25d366;
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"
                />
              </svg>
              Abrir WhatsApp
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Renovar Membres√≠a -->
    <div
      id="modalRenovarMembresia"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          border-radius: 12px;
          padding: 1.5rem;
          width: 90%;
          max-width: 500px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h3
            style="
              margin: 0;
              color: var(--text);
              font-size: 1.3rem;
              font-weight: 700;
            "
          >
            Renovar Membres√≠a
          </h3>
          <button
            onclick="cerrarModalRenovarMembresia()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--sub);
            "
          >
            &times;
          </button>
        </div>

        <div id="contenidoModalRenovar">
          <!-- El contenido se llenar√° din√°micamente -->
        </div>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
          "
        >
          <button
            onclick="cerrarModalRenovarMembresia()"
            style="
              background: var(--panel);
              color: var(--text);
              border: 1px solid var(--muted);
              padding: 0.8rem 1.5rem;
              border-radius: 6px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            "
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M18 6L6 18M6 6L18 18"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Cancelar
          </button>
          <button
            onclick="confirmarRenovacion()"
            style="
              background: var(--ok);
              color: white;
              border: none;
              padding: 0.8rem 1.5rem;
              border-radius: 6px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            "
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M20 6L9 17L4 12"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Confirmar Renovaci√≥n
          </button>
        </div>
      </div>
    </div>

    <script>
      /******************** STATE Y UTILIDADES ********************/
      const EL = (sel) => document.querySelector(sel);
      const NOW = () => new Date();
      const fmtDate = (d) =>
        new Date(d).toLocaleDateString("es-EC", {
          year: "numeric",
          month: "short",
          day: "2-digit",
        });
      const fmtTime = (d) =>
        new Date(d).toLocaleTimeString("es-EC", {
          hour: "2-digit",
          minute: "2-digit",
        });
      const daysDiff = (a, b) =>
        Math.ceil((new Date(a) - new Date(b)) / (1000 * 60 * 60 * 24));
      const uuid = () => crypto.randomUUID();

      const DB = {
        load() {
          const data = JSON.parse(localStorage.getItem("gymdb_v1") || "{}");
          this.users = data.users || seedUsers();
          this.memberships = data.memberships || seedMemberships();
          this.attendance = data.attendance || []; // {id, clientId, type:'entrada'|'salida', at}
          this.payments = data.payments || []; // {id, clientId, amount, bank, note, at, user}
          this.entrenamientos = data.entrenamientos || []; // {id, clienteId, cedula, genero, secciones, fechaAsignacion, sucursal}
          this.plantillasWhatsApp =
            data.plantillasWhatsApp || seedPlantillasWhatsApp(); // {id, titulo, mensaje, categoria, activa, fechaCreacion}
          this.descuentos = data.descuentos || seedDescuentos(); // {id, nombre, monto, activo, fechaCreacion}
          this.settings = data.settings || {
            sucursal: "Matriz",
            theme: "dark",
          };
          save();
        },
        users: [],
        memberships: [],
        attendance: [],
        payments: [],
        entrenamientos: [],
        plantillasWhatsApp: [],
        descuentos: [],
        settings: {},
      };
      const save = () =>
        localStorage.setItem(
          "gymdb_v1",
          JSON.stringify({
            users: DB.users,
            memberships: DB.memberships,
            attendance: DB.attendance,
            payments: DB.payments,
            settings: DB.settings,
            entrenamientos: DB.entrenamientos || [],
            plantillasWhatsApp: DB.plantillasWhatsApp || [],
            descuentos: DB.descuentos || [],
          })
        );

      function seedMemberships() {
        return [
          {
            id: "m1",
            nombre: "Mensual",
            frecuencia: "30 d√≠as",
            monto: 25,
            sucursal: "Matriz",
            detalle: "Acceso ilimitado 30 d√≠as",
          },
          {
            id: "m2",
            nombre: "Trimestral",
            frecuencia: "90 d√≠as",
            monto: 65,
            sucursal: "Matriz",
            detalle: "Ahorra 13%",
          },
          {
            id: "m3",
            nombre: "Anual",
            frecuencia: "365 d√≠as",
            monto: 220,
            sucursal: "Norte",
            detalle: "Mejor precio",
          },
        ];
      }
      function seedUsers() {
        const now = NOW();
        const d = (n) => new Date(now.getTime() - n * 86400000);
        return [
          {
            id: "u1",
            nombres: "Mar√≠a",
            apellidos: "L√≥pez",
            cedula: "1102345678",
            nacimiento: "1995-08-22",
            email: "maria@mail.com",
            telefono: "+593991112223",
            direccion: "Av. Amazonas",
            genero: "Mujer",
            foto: "",
            obraSocial: "IESS",
            notas: "Prefiere ma√±anas",
            tipo: "Cliente",
            activo: true,
            membresia: "m1",
            inscritoPrimera: d(190),
            membresiaInicio: d(20),
            membresiaFin: d(-10),
            saldo: 0,
            ultimoIngreso: d(1),
            creadoAt: d(2),
          },
          {
            id: "u2",
            nombres: "Juan",
            apellidos: "P√©rez",
            cedula: "1712345678",
            nacimiento: "1990-11-10",
            email: "juan@mail.com",
            telefono: "+593997778889",
            direccion: "La Floresta",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "",
            tipo: "Cliente",
            activo: true,
            membresia: "m2",
            inscritoPrimera: d(400),
            membresiaInicio: d(50),
            membresiaFin: d(-40),
            saldo: 10,
            ultimoIngreso: d(45),
            creadoAt: d(10),
          },
          {
            id: "u3",
            nombres: "Ana",
            apellidos: "G√≥mez",
            cedula: "0609876543",
            nacimiento: "2000-08-05",
            email: "ana@mail.com",
            telefono: "+593995551111",
            direccion: "Centro",
            genero: "Mujer",
            foto: "",
            obraSocial: "Privada",
            notas: "",
            tipo: "Cliente",
            activo: true,
            membresia: "m1",
            inscritoPrimera: d(10),
            membresiaInicio: d(5),
            membresiaFin: d(-25),
            saldo: 0,
            ultimoIngreso: d(0),
            creadoAt: d(0),
          },
          {
            id: "u4",
            nombres: "Pedro",
            apellidos: "Cede√±o",
            cedula: "0912345678",
            nacimiento: "1988-08-29",
            email: "pedro@mail.com",
            telefono: "+593994443333",
            direccion: "Sur",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "Requiere asesor√≠as",
            tipo: "Cliente",
            activo: false,
            membresia: "m1",
            inscritoPrimera: d(800),
            membresiaInicio: d(120),
            membresiaFin: d(30),
            saldo: 50,
            ultimoIngreso: d(61),
            creadoAt: d(120),
          },
          // Usuarios con membres√≠as caducadas
          {
            id: "u5",
            nombres: "Carlos",
            apellidos: "Mendoza",
            cedula: "1203456789",
            nacimiento: "1992-03-15",
            email: "carlos@mail.com",
            telefono: "+593998887776",
            direccion: "Norte",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "Cliente frecuente",
            tipo: "Cliente",
            activo: true,
            membresia: "m2",
            inscritoPrimera: d(300),
            membresiaInicio: d(100),
            membresiaFin: d(-15),
            saldo: 25,
            ultimoIngreso: d(20),
            creadoAt: d(100),
          },
          {
            id: "u6",
            nombres: "Sofia",
            apellidos: "Vargas",
            cedula: "1304567890",
            nacimiento: "1997-12-08",
            email: "sofia@mail.com",
            telefono: "+593997776665",
            direccion: "Este",
            genero: "Mujer",
            foto: "",
            obraSocial: "IESS",
            notas: "Prefiere clases de yoga",
            tipo: "Cliente",
            activo: true,
            membresia: "m1",
            inscritoPrimera: d(150),
            membresiaInicio: d(35),
            membresiaFin: d(-8),
            saldo: 0,
            ultimoIngreso: d(10),
            creadoAt: d(35),
          },
          {
            id: "u7",
            nombres: "Roberto",
            apellidos: "Herrera",
            cedula: "1405678901",
            nacimiento: "1985-07-22",
            email: "roberto@mail.com",
            telefono: "+593996665554",
            direccion: "Oeste",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "Entrenador personal",
            tipo: "Cliente",
            activo: true,
            membresia: "m3",
            inscritoPrimera: d(500),
            membresiaInicio: d(400),
            membresiaFin: d(-30),
            saldo: 75,
            ultimoIngreso: d(45),
            creadoAt: d(400),
          },
          {
            id: "u8",
            nombres: "Carmen",
            apellidos: "Torres",
            cedula: "1506789012",
            nacimiento: "1993-09-14",
            email: "carmen@mail.com",
            telefono: "+593995554443",
            direccion: "Centro Norte",
            genero: "Mujer",
            foto: "",
            obraSocial: "Privada",
            notas: "Cliente VIP",
            tipo: "Cliente",
            activo: true,
            membresia: "m2",
            inscritoPrimera: d(200),
            membresiaInicio: d(95),
            membresiaFin: d(-5),
            saldo: 15,
            ultimoIngreso: d(2),
            creadoAt: d(95),
          },
          // Usuarios con membres√≠as por caducar (‚â§5 d√≠as)
          {
            id: "u9",
            nombres: "Diego",
            apellidos: "Morales",
            cedula: "1607890123",
            nacimiento: "1991-05-30",
            email: "diego@mail.com",
            telefono: "+593994443332",
            direccion: "Sur Este",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "Nuevo cliente",
            tipo: "Cliente",
            activo: true,
            membresia: "m1",
            inscritoPrimera: d(30),
            membresiaInicio: d(25),
            membresiaFin: d(2),
            saldo: 0,
            ultimoIngreso: d(1),
            creadoAt: d(25),
          },
          {
            id: "u10",
            nombres: "Patricia",
            apellidos: "Rojas",
            cedula: "1708901234",
            nacimiento: "1989-11-18",
            email: "patricia@mail.com",
            telefono: "+593993332221",
            direccion: "Norte Oeste",
            genero: "Mujer",
            foto: "",
            obraSocial: "IESS",
            notas: "Cliente regular",
            tipo: "Cliente",
            activo: true,
            membresia: "m2",
            inscritoPrimera: d(180),
            membresiaInicio: d(85),
            membresiaFin: d(3),
            saldo: 30,
            ultimoIngreso: d(5),
            creadoAt: d(85),
          },
          {
            id: "u11",
            nombres: "Fernando",
            apellidos: "Silva",
            cedula: "1809012345",
            nacimiento: "1994-02-25",
            email: "fernando@mail.com",
            telefono: "+593992221110",
            direccion: "Centro Sur",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "Interesado en crossfit",
            tipo: "Cliente",
            activo: true,
            membresia: "m1",
            inscritoPrimera: d(28),
            membresiaInicio: d(23),
            membresiaFin: d(1),
            saldo: 0,
            ultimoIngreso: d(0),
            creadoAt: d(23),
          },
          {
            id: "u12",
            nombres: "Valeria",
            apellidos: "Castro",
            cedula: "1900123456",
            nacimiento: "1996-06-12",
            email: "valeria@mail.com",
            telefono: "+593991110009",
            direccion: "Este Norte",
            genero: "Mujer",
            foto: "",
            obraSocial: "Privada",
            notas: "Cliente premium",
            tipo: "Cliente",
            activo: true,
            membresia: "m3",
            inscritoPrimera: d(350),
            membresiaInicio: d(360),
            membresiaFin: d(4),
            saldo: 45,
            ultimoIngreso: d(3),
            creadoAt: d(360),
          },
          {
            id: "u13",
            nombres: "Luis",
            apellidos: "Guzm√°n",
            cedula: "2001234567",
            nacimiento: "1987-04-03",
            email: "luis@mail.com",
            telefono: "+593990009998",
            direccion: "Oeste Sur",
            genero: "Hombre",
            foto: "",
            obraSocial: "",
            notas: "Cliente deportista",
            tipo: "Cliente",
            activo: true,
            membresia: "m2",
            inscritoPrimera: d(170),
            membresiaInicio: d(80),
            membresiaFin: d(5),
            saldo: 20,
            ultimoIngreso: d(4),
            creadoAt: d(80),
          },
          {
            id: "u14",
            nombres: "Gabriela",
            apellidos: "Flores",
            cedula: "2102345678",
            nacimiento: "1998-10-20",
            email: "gabriela@mail.com",
            telefono: "+593998887776",
            direccion: "Centro Este",
            genero: "Mujer",
            foto: "",
            obraSocial: "IESS",
            notas: "Cliente joven",
            tipo: "Cliente",
            activo: true,
            membresia: "m1",
            inscritoPrimera: d(26),
            membresiaInicio: d(21),
            membresiaFin: d(0),
            saldo: 0,
            ultimoIngreso: d(1),
            creadoAt: d(21),
          },
        ];
      }

      /******************** AUTENTICACI√ìN (DEMO) ********************/
      function doLogin() {
        const email = EL("#loginEmail").value.trim();
        const pass = EL("#loginPass").value.trim();
        if (email === "admin@gym.com" && pass === "admin123") {
          sessionStorage.setItem("auth", "ok");
          EL("#loginView").classList.add("hidden");
          EL("#appView").classList.remove("hidden");
          initApp();
        } else {
          alert("Credenciales incorrectas");
        }
      }
      function logout() {
        sessionStorage.removeItem("auth");
        location.reload();
      }

      /******************** APP INIT ********************/
      const SECTIONS = [
        { id: "ingreso", label: "Ingreso de clientes" },
        {
          id: "clientes",
          label: "Clientes",
          submenu: [
            { id: "todos-clientes", label: "Ver todos los clientes" },
            { id: "membresias-caducar", label: "Membres√≠as a caducar" },
            { id: "nuevos", label: "Nuevos clientes" },
            { id: "inactivos", label: "Clientes inactivos" },
            { id: "deudores", label: "Deudores" },
            { id: "cumples", label: "Cumplea√±os" },
            { id: "registro", label: "Registrar nuevo cliente" },
          ],
        },
        {
          id: "asignacion-entrenamiento",
          label: "Asignaci√≥n de Entrenamiento",
        },
        {
          id: "gestion",
          label: "Gesti√≥n",
          submenu: [
            { id: "plantillas-whatsapp", label: "Plantillas de WhatsApp" },
            { id: "descuentos", label: "Descuentos" },
          ],
        },
        { id: "export", label: "Exportar datos" },
        { id: "membresias", label: "Membres√≠as" },
        { id: "pagos", label: "Informe de pago" },
      ];
      let active = "ingreso";
      let currentClientDetail = null; // Para la vista detallada del cliente

      function initApp() {
        DB.load();
        EL("#todayInfo").textContent = new Date().toLocaleString("es-EC", {
          weekday: "long",
          day: "2-digit",
          month: "short",
        });
        EL("#sucursalActual").textContent = DB.settings.sucursal;
        // Menu
        const nav = EL("#menu");
        nav.innerHTML = "";
        SECTIONS.forEach((s) => {
          if (s.submenu) {
            // Crear men√∫ con submen√∫s
            const menuGroup = document.createElement("div");
            menuGroup.className = "menu-group";
            menuGroup.style.cssText = "margin-bottom: 1rem;";

            // Bot√≥n principal del grupo
            const mainBtn = document.createElement("button");
            mainBtn.className = "btn menu-group-btn";
            mainBtn.style.cssText =
              "width: 100%; text-align: left; justify-content: space-between; margin-bottom: 0.5rem;";
            mainBtn.innerHTML = `
              <span>${s.label}</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-arrow">
                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            `;

            // Submen√∫
            const submenu = document.createElement("div");
            submenu.className = "submenu";
            submenu.style.cssText = "display: none;";

            s.submenu.forEach((subItem) => {
              const subBtn = document.createElement("button");
              subBtn.className =
                "btn submenu-btn" + (active === subItem.id ? " primary" : "");
              subBtn.style.cssText =
                "width: 100%; text-align: left; font-size: 0.8rem; padding: 0.5rem 1rem; margin-bottom: 0.2rem; justify-content: flex-start;";
              subBtn.textContent = subItem.label;
              subBtn.onclick = () => {
                active = subItem.id;
                // Remover clase primary de todos los botones
                document
                  .querySelectorAll(".btn")
                  .forEach((x) => x.classList.remove("primary"));
                subBtn.classList.add("primary");
                render();
                closeSidebar();
              };
              submenu.appendChild(subBtn);
            });

            // Toggle del submen√∫
            mainBtn.onclick = () => {
              const isOpen = submenu.style.display === "block";
              submenu.style.display = isOpen ? "none" : "block";
              mainBtn.querySelector(".menu-arrow").style.transform = isOpen
                ? "rotate(0deg)"
                : "rotate(180deg)";
            };

            menuGroup.appendChild(mainBtn);
            menuGroup.appendChild(submenu);
            nav.appendChild(menuGroup);
          } else {
            // Men√∫ normal sin submen√∫s
            const b = document.createElement("button");
            b.className = "btn" + (active === s.id ? " primary" : "");
            b.textContent = s.label;
            b.onclick = () => {
              active = s.id;
              [...nav.children].forEach((x) => x.classList.remove("primary"));
              b.classList.add("primary");
              render();
              closeSidebar();
            };
            nav.appendChild(b);
          }
        });
        render();
      }

      /******************** RENDER ************************/
      function render() {
        const root = EL("#viewRoot");
        root.innerHTML = "";
        if (active === "cliente-detalle" && currentClientDetail)
          return renderClienteDetalle(root, currentClientDetail);
        if (active === "ingreso") return renderIngreso(root);
        if (active === "todos-clientes") return renderClientes(root);
        if (active === "membresias-caducar") return renderCaducar(root);
        if (active === "nuevos") return renderNuevos(root);
        if (active === "inactivos") return renderInactivos(root);
        if (active === "deudores") return renderDeudores(root);
        if (active === "cumples") return renderCumples(root);
        if (active === "registro") return renderRegistro(root);
        if (active === "asignacion-entrenamiento")
          return renderAsignacionEntrenamiento(root);
        if (active === "plantillas-whatsapp")
          return renderPlantillasWhatsApp(root);
        if (active === "descuentos") return renderDescuentos(root);
        if (active === "export") return renderExport(root);
        if (active === "membresias") return renderMembresias(root);
        if (active === "pagos") return renderPagos(root);
      }

      /******************** SECCI√ìN 1: INGRESO ********************/
      function renderIngreso(root) {
        const wrap = document.createElement("div");
        wrap.className = "grid cols-2 qr-layout";

        // Col 1: Esc√°ner QR y B√∫squeda por c√©dula
        const c1 = document.createElement("div");
        c1.className = "card";
        c1.innerHTML = `
    <h3 class="section-title">Esc√°ner QR</h3>
    <video id="cam" class="video" playsinline></video>
    <div class="row" style="margin-top:.6rem">
      <button class="btn" id="btnIniciarCam" onclick="startCam()">Iniciar c√°mara</button>
      <button class="btn ghost" id="btnDetenerCam" onclick="stopCam()" disabled>Detener</button>
    </div>
    
    <div class="sep" style="margin: 1.5rem 0;"></div>
    
    <h3 class="section-title">Buscar por c√©dula</h3>
    <div style="position: relative; display: flex; align-items: center;">
      <input class="input" id="searchCedula" placeholder="Ingrese c√©dula (10 d√≠gitos)" maxlength="10" oninput="validarCedula(this.value)" style="flex: 1;" />
      <button class="btn" onclick="limpiarCedula()" style="position: absolute; right: 8px; background: none; border: none; color: var(--sub); padding: 0.5rem; cursor: pointer;" title="Limpiar">
        üóëÔ∏è
      </button>
    </div>
    <div id="resultCedula" style="margin-top:.6rem"></div>
  `;

        // Col 2: Info del cliente con acciones r√°pidas
        const c2 = document.createElement("div");
        c2.className = "card";
        c2.innerHTML = `
    <h3 class="section-title">Informaci√≥n del cliente</h3>
    <div id="infoCliente">
      <div class="muted" style="text-align: center; padding: 2rem; font-size: 1.1rem; color: var(--sub);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.5;">
          <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9ZM19 9H14V4H5V21H19V9Z" fill="currentColor"/>
        </svg>
        <div>Escanee el c√≥digo QR o busque por c√©dula</div>
    </div>
    </div>
    <div class="sep"></div>
    <div id="asistenciasHoy" style="margin-top:1rem"></div>
  `;

        wrap.append(c1, c2);
        root.append(wrap);
      }

      let mediaStream = null;
      let currentClient = null;
      let cameraActive = false;

      function startCam() {
        stopCam();
        navigator.mediaDevices
          ?.getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            mediaStream = stream;
            cameraActive = true;
            const v = EL("#cam");
            v.srcObject = stream;
            v.play();

            // Actualizar estado de botones
            EL("#btnIniciarCam").disabled = true;
            EL("#btnDetenerCam").disabled = false;
          })
          .catch(() => alert("No se pudo acceder a la c√°mara"));
      }

      function stopCam() {
        if (mediaStream) {
          mediaStream.getTracks().forEach((t) => t.stop());
          mediaStream = null;
          cameraActive = false;
          EL("#cam").srcObject = null;

          // Actualizar estado de botones
          EL("#btnIniciarCam").disabled = false;
          EL("#btnDetenerCam").disabled = true;
        }
      }

      function validarCedula(cedula) {
        // Solo permitir n√∫meros y m√°ximo 10 d√≠gitos
        const cedulaLimpia = cedula.replace(/\D/g, "");
        EL("#searchCedula").value = cedulaLimpia.slice(0, 10);

        // Si la c√©dula tiene 10 d√≠gitos, buscar autom√°ticamente
        if (cedulaLimpia.length === 10) {
          buscarPorCedula();
        } else {
          // Limpiar resultado si la c√©dula no est√° completa
          EL("#resultCedula").innerHTML = "";
        }
      }

      function buscarPorCedula() {
        const cedula = EL("#searchCedula").value.trim();
        if (!cedula) return;
        if (cedula.length !== 10) return;

        const u = DB.users.find((x) => x.cedula === cedula);
        if (!u) {
          EL("#resultCedula").innerHTML =
            '<div style="color: var(--danger); padding: 0.5rem; background: rgba(239, 83, 80, 0.1); border-radius: 6px;">Cliente no encontrado</div>';
          return;
        }

        // Mostrar el nombre del cliente como elemento clickeable
        EL("#resultCedula").innerHTML =
          '<div style="color: var(--text); padding: 0.5rem; background: #E0E0E0; border-radius: 4px; cursor: pointer;" onclick="mostrarInfoCliente(\'' +
          u.id +
          "')\">" +
          u.nombres +
          " " +
          u.apellidos +
          "</div>";

        // Mostrar informaci√≥n del cliente inmediatamente
        mostrarInfoCliente(u.id);
      }

      function limpiarCedula() {
        EL("#searchCedula").value = "";
        EL("#resultCedula").innerHTML = "";
      }

      function buscarIngreso(q) {
        q = q.toLowerCase();
        const res = DB.users.filter(
          (u) =>
            (u.nombres + " " + u.apellidos).toLowerCase().includes(q) ||
            u.cedula.includes(q)
        );
        const cont = EL("#resultIngreso");
        cont.innerHTML = res
          .slice(0, 10)
          .map(
            (
              u
            ) => `<div class="row" style="justify-content:space-between;align-items:center;margin:.3rem 0">
    <div>${u.nombres} ${u.apellidos} <span class="muted mini">(${u.cedula})</span></div>
    <button class="btn" onclick='showClienteById("${u.id}")'>Seleccionar</button>
  </div>`
          )
          .join("");
      }

      function limpiarIngreso() {
        currentClient = null;
        EL("#infoCliente").innerHTML = `
          <div class="muted" style="text-align: center; padding: 2rem; font-size: 1.1rem; color: var(--sub);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.5;">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9ZM19 9H14V4H5V21H19V9Z" fill="currentColor"/>
            </svg>
            <div>Escanee el c√≥digo QR o busque por c√©dula</div>
          </div>`;

        // Limpiar campos de b√∫squeda
        limpiarCedula();
      }
      function showClienteById(id) {
        const u = DB.users.find((x) => x.id === id);
        if (u) showCliente(u);
      }
      function showCliente(u) {
        currentClient = u;
        currentClientDetail = u;
        active = "cliente-detalle";
        render();
      }

      function mostrarInfoCliente(id) {
        const u = DB.users.find((x) => x.id === id);
        if (!u) return;

        currentClient = u;

        // Obtener informaci√≥n de membres√≠a
        const m = DB.memberships.find((mem) => mem.id === u.membresia);
        const diasRest = daysDiff(u.membresiaFin, NOW());

        // Calcular d√≠as restantes de membres√≠a
        const diasRestantes = Math.max(0, diasRest);

        // Funci√≥n para formatear fechas
        const fmtDate = (d) => {
          if (!d) return "-";
          return new Date(d).toLocaleDateString("es-EC", {
            year: "numeric",
            month: "short",
            day: "2-digit",
          });
        };

        // Renderizar informaci√≥n del cliente en la secci√≥n derecha
        EL("#infoCliente").innerHTML = `
          <!-- Bot√≥n para limpiar informaci√≥n -->
          <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
            <button class="btn" onclick="limpiarIngreso()" style="
              background: var(--panel);
              color: var(--text);
              border: 1px solid var(--muted);
              padding: 0.5rem 1rem;
              border-radius: 6px;
              cursor: pointer;
              font-size: 0.9rem;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            " title="Limpiar informaci√≥n del cliente">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Limpiar
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1rem;">
            <!-- Columna izquierda: Informaci√≥n del cliente -->
            <div>
              <!-- Informaci√≥n de perfil mejorada -->
              <div style="background: var(--card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; font-size: 0.95rem;">
                  <div>
                    <div class="muted mini" style="margin-bottom: 0.3rem; font-weight: 600; color: var(--sub);">C√©dula</div>
                    <div style="color: var(--text); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--muted);">${
                      u.cedula
                    }</div>
                  </div>
                  <div>
                    <div class="muted mini" style="margin-bottom: 0.3rem; font-weight: 600; color: var(--sub);">Tel√©fono</div>
                    <div style="color: var(--text); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--muted);">${
                      u.telefono || "-"
                    }</div>
                  </div>
                  <div>
                    <div class="muted mini" style="margin-bottom: 0.3rem; font-weight: 600; color: var(--sub);">Email</div>
                    <div style="color: var(--text); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--muted);">${
                      u.email || "-"
                    }</div>
                  </div>
                  <div>
                    <div class="muted mini" style="margin-bottom: 0.3rem; font-weight: 600; color: var(--sub);">G√©nero</div>
                    <div style="color: var(--text); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--muted);">${
                      u.genero || "-"
                    }</div>
                  </div>
                  <div style="grid-column: 1 / -1;">
                    <div class="muted mini" style="margin-bottom: 0.3rem; font-weight: 600; color: var(--sub);">Direcci√≥n</div>
                    <div style="color: var(--text); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--muted);">${
                      u.direccion || "-"
                    }</div>
                  </div>
                  <div>
                    <div class="muted mini" style="margin-bottom: 0.3rem; font-weight: 600; color: var(--sub);">Tipo de Usuario</div>
                    <div style="color: var(--text); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--muted);">${
                      u.tipoUsuario || "Cliente Regular"
                    }</div>
                  </div>
                </div>
                
                <!-- Botones de acci√≥n en la tarjeta de datos -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                  <button class="btn" style="padding: 0.5rem; background: var(--card); color: var(--text); border: 1px solid var(--muted); border-radius: 6px; font-size: 1.1rem;" onclick='editarCliente("${
                    u.id
                  }")' title="Editar Informaci√≥n">‚úè</button>
                  <button class="btn" style="padding: 0.5rem; background: var(--card); color: var(--text); border: 1px solid var(--muted); border-radius: 6px; font-size: 1.1rem;" onclick='abrirPagos("${
                    u.id
                  }")' title="Ver Pagos">üí∞</button>
                  <button class="btn" style="padding: 0.5rem; background: var(--card); color: #22c55e; border: 1px solid var(--muted); border-radius: 6px; font-size: 1.1rem;" onclick="registrar('entrada')" id="btnEntrada" title="Registrar Entrada">‚úÖ</button>
                  <button class="btn" style="padding: 0.5rem; background: var(--card); color: #ef4444; border: 1px solid var(--muted); border-radius: 6px; font-size: 1.1rem;" onclick="registrar('salida')" id="btnSalida" title="Registrar Salida">‚ùå</button>
                  <button class="btn" style="padding: 0.5rem; background: var(--card); color: var(--text); border: 1px solid var(--muted); border-radius: 6px; font-size: 1.1rem;" onclick="verAsistenciasHoy()" title="Historial de Asistencias">üìã</button>
                </div>
              </div>
            </div>
            
            <!-- Columna derecha: Foto del cliente -->
            <div style="text-align: center;">
              <img class="avatar" src="${
                u.foto ||
                "https://i.pinimg.com/1200x/18/46/68/1846687bddac97ce0d0c949348e3f74f.jpg"
              }" alt="avatar" style="width: 280px; height: 310px; border-radius: 12px; object-fit: cover; border: 3px solid var(--brand); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);">
              
              <!-- Nombre del cliente debajo de la foto -->
              <div style="font-weight: 700; font-size: 1.4rem; color: var(--text); margin-top: 1rem; margin-bottom: 1rem;">${
                u.nombres
              } ${u.apellidos}</div>
              
              <!-- Informaci√≥n de sucursal -->
              <div style="margin-top: 1rem; padding: 0.8rem; background: var(--card); border-radius: 8px; border: 1px solid var(--muted);">
                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.3rem; font-size: 0.9rem;">Sucursal</div>
                <div style="color: var(--brand); font-weight: 700; font-size: 1rem;">${
                  u.sucursal || DB.settings.sucursal || "Matriz"
                }</div>
              </div>
            </div>
          </div>

          <!-- Estad√≠sticas del cliente -->
          <div class="client-stats" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="stat-card" style="background: var(--card); border: 2px solid var(--brand); border-radius: var(--radius); padding: 1rem; text-align: center;">
              <div class="muted mini" style="margin-bottom: 0.5rem; font-size: 0.85rem;">Membres√≠a</div>
              <div style="color: var(--text); font-weight: 600; font-size: 1.1rem;">${
                m?.nombre || "-"
              }</div>
              <div style="color: var(--sub); font-size: 0.85rem;">${
                m?.frecuencia || ""
              }</div>
            </div>
            <div class="stat-card" style="background: var(--card); border: 2px solid ${
              u.saldo && u.saldo > 0 ? "var(--danger)" : "var(--brand)"
            }; border-radius: var(--radius); padding: 1rem; text-align: center;">
              <div class="muted mini" style="margin-bottom: 0.5rem; font-size: 0.85rem;">Saldo</div>
              <div style="color: ${
                u.saldo && u.saldo > 0 ? "var(--danger)" : "var(--text)"
              }; font-weight: ${
          u.saldo && u.saldo > 0 ? "800" : "600"
        }; font-size: 1.1rem;">$ ${u.saldo?.toFixed(2) || "0.00"}</div>
              <div style="color: var(--sub); font-size: 0.85rem;">Disponible</div>
            </div>
            <div class="stat-card" style="background: rgba(255, 192, 203, 0.2); border: 2px solid var(--brand); border-radius: var(--radius); padding: 1rem; text-align: center;">
              <div style="margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text); font-weight: 600;">‚è≥ D√≠as Restantes</div>
              <div style="font-weight: 800; font-size: 1.8rem; color: var(--text);">${diasRestantes}</div>
              <div style="font-size: 0.85rem; color: var(--text); font-weight: 600;">d√≠as</div>
            </div>
          </div>

          <!-- Informaci√≥n de fechas -->
          <div class="client-dates" style="background: var(--card); border: 1px solid var(--muted); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.8rem; font-size: 0.95rem;">Informaci√≥n de Fechas</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div style="text-align: center;">
                <div class="muted mini" style="margin-bottom: 0.3rem; font-size: 0.8rem;">Primera inscripci√≥n</div>
                <div style="color: var(--text); font-weight: 500; font-size: 0.9rem;">${fmtDate(
                  u.inscritoPrimera
                )}</div>
              </div>
              <div style="text-align: center;">
                <div class="muted mini" style="margin-bottom: 0.3rem; font-size: 0.8rem;">Inicio membres√≠a</div>
                <div style="color: var(--text); font-weight: 500; font-size: 0.9rem;">${fmtDate(
                  u.membresiaInicio
                )}</div>
              </div>
              <div style="text-align: center;">
                <div class="muted mini" style="margin-bottom: 0.3rem; font-size: 0.8rem;">Fin membres√≠a</div>
                <div style="color: var(--text); font-weight: 500; font-size: 0.9rem;">${fmtDate(
                  u.membresiaFin
                )}</div>
              </div>
            </div>
          </div>
        `;

        // Actualizar estado de botones despu√©s de mostrar la informaci√≥n
        setTimeout(() => {
          const btnEntrada = EL("#btnEntrada");
          const btnSalida = EL("#btnSalida");

          if (btnEntrada && btnSalida) {
            // Verificar registros del d√≠a de hoy
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const registrosHoy = DB.attendance.filter((a) => {
              const registroDate = new Date(a.at);
              return (
                a.clientId === u.id &&
                registroDate >= today &&
                registroDate < tomorrow
              );
            });

            const tieneEntrada = registrosHoy.some((r) => r.type === "entrada");
            const tieneSalida = registrosHoy.some((r) => r.type === "salida");

            // Actualizar estado de botones
            btnEntrada.disabled = tieneEntrada;
            btnSalida.disabled = !tieneEntrada || tieneSalida;

            // Actualizar tooltips
            if (tieneEntrada && tieneSalida) {
              btnEntrada.title = "Registro del d√≠a de hoy exitoso";
              btnSalida.title = "Registro del d√≠a de hoy exitoso";
            } else if (tieneEntrada) {
              btnEntrada.title = "Entrada ya registrada hoy";
              btnSalida.title = "Registrar Salida";
            } else {
              btnEntrada.title = "Registrar Entrada";
              btnSalida.title = "Debe registrar entrada primero";
            }
          }
        }, 100);
      }
      function registrar(type) {
        if (!currentClient) return alert("Seleccione un cliente");
        DB.attendance.push({
          id: uuid(),
          clientId: currentClient.id,
          type,
          at: new Date().toISOString(),
        });
        if (type === "entrada")
          currentClient.ultimoIngreso = new Date().toISOString();
        save();
        alert("Registrado con √©xito");

        // Actualizar estado de botones despu√©s del registro
        setTimeout(() => {
          const btnEntrada = EL("#btnEntrada");
          const btnSalida = EL("#btnSalida");

          if (btnEntrada && btnSalida) {
            // Verificar registros del d√≠a de hoy
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const registrosHoy = DB.attendance.filter((a) => {
              const registroDate = new Date(a.at);
              return (
                a.clientId === currentClient.id &&
                registroDate >= today &&
                registroDate < tomorrow
              );
            });

            const tieneEntrada = registrosHoy.some((r) => r.type === "entrada");
            const tieneSalida = registrosHoy.some((r) => r.type === "salida");

            // Actualizar estado de botones
            btnEntrada.disabled = tieneEntrada;
            btnSalida.disabled = !tieneEntrada || tieneSalida;

            // Actualizar tooltips
            if (tieneEntrada && tieneSalida) {
              btnEntrada.title = "Registro del d√≠a de hoy exitoso";
              btnSalida.title = "Registro del d√≠a de hoy exitoso";
            } else if (tieneEntrada) {
              btnEntrada.title = "Entrada ya registrada hoy";
              btnSalida.title = "Registrar Salida";
            } else {
              btnEntrada.title = "Registrar Entrada";
              btnSalida.title = "Debe registrar entrada primero";
            }
          }
        }, 100);
      }
      function verAsistenciasHoy() {
        if (!currentClient) {
          alert("Seleccione un cliente primero");
          return;
        }

        const rows = DB.attendance
          .filter((a) => a.clientId === currentClient.id)
          .sort((a, b) => new Date(b.at) - new Date(a.at)) // Ordenar por fecha m√°s reciente
          .map((a) => {
            return `<tr>
              <td style="padding: 0.8rem; border-bottom: 1px solid var(--muted);">${fmtDate(
                a.at
              )} ${fmtTime(a.at)}</td>
              <td style="padding: 0.8rem; border-bottom: 1px solid var(--muted);">${
                a.type === "entrada" ? "üö™‚Üí Entrada" : "‚Üêüö™ Salida"
              }</td>
            </tr>`;
          })
          .join("");

        // Crear modal con historial de asistencias del cliente
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.5rem;">Historial de Asistencias - ${
                currentClient.nombres
              } ${currentClient.apellidos}</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--card);">
                  <th style="padding: 0.8rem; text-align: left; border-bottom: 2px solid var(--muted); color: var(--text);">Fecha y Hora</th>
                  <th style="padding: 0.8rem; text-align: left; border-bottom: 2px solid var(--muted); color: var(--text);">Tipo</th>
                </tr>
              </thead>
              <tbody>
                ${
                  rows ||
                  '<tr><td colspan=2 style="text-align: center; padding: 1rem; color: var(--sub);">Sin registros de asistencia</td></tr>'
                }
              </tbody>
            </table>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      /******************** SECCI√ìN 2: CLIENTES ********************/
      function renderClientes(root) {
        const card = document.createElement("div");
        card.className = "card";
        const rows = DB.users
          .map((u) => {
            const mem = DB.memberships.find((m) => m.id === u.membresia);
            const last = u.ultimoIngreso
              ? fmtDate(u.ultimoIngreso) + " " + fmtTime(u.ultimoIngreso)
              : "-";
            return `<tr>
      <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
      <td>${mem?.nombre || "-"}</td>
      <td>${last}</td>
      <td style="color: ${u.saldo && u.saldo > 0 ? "#ef4444" : "inherit"};">$ ${
              u.saldo?.toFixed(2) || "0.00"
            }</td>
      <td class="row">
        <button class="btn" onclick='abrirPagos("${u.id}")'>Ver pagos</button>
        <button class="btn success" onclick='registrarPago("${
          u.id
        }")'>Registrar pago</button>
        <button class="btn" onclick='abrirModalWhatsApp("${
          u.id
        }")'>WhatsApp</button>
      </td>
    </tr>`;
          })
          .join("");
        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 class="section-title" style="margin: 0;">Todos los clientes</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="font-weight: 600; color: var(--text);">Buscar por c√©dula:</label>
        <input
          type="text"
          id="buscarCedula"
          placeholder="Ingrese c√©dula..."
          style="
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            width: 200px;
          "
        />
        <button
          onclick="filtrarPorCedula()"
          style="
            background: var(--brand);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
          "
        >
          Buscar
        </button>
        <button
          onclick="limpiarBusqueda()"
          style="
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          Limpiar
        </button>
      </div>
    </div>
    <table>
      <thead><tr><th>Nombre</th><th>Membres√≠a</th><th>√öltimo ingreso</th><th>Saldo pendiente</th><th>Opciones</th></tr></thead>
      <tbody id="tablaClientes">${rows}</tbody>
    </table>`;
        root.append(card);
      }

      /******************** SECCI√ìN 3: A CADUCAR ********************/
      function renderCaducar(root) {
        const caducados = [];
        const porCaducar = [];
        DB.users.forEach((u) => {
          const d = daysDiff(u.membresiaFin, NOW());
          if (d < 0) caducados.push(u);
          else if (d <= 5) porCaducar.push(u);
        });

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 class="section-title" style="margin: 0;">Membres√≠as a caducar y caducadas</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="font-weight: 600; color: var(--text);">Buscar por c√©dula:</label>
        <input
          type="text"
          id="buscarCedulaCaducadas"
          placeholder="Ingrese c√©dula..."
          style="
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            width: 200px;
          "
        />
        <button
          onclick="filtrarCaducadas()"
          style="
            background: var(--brand);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
          "
        >
          Buscar
        </button>
        <button
          onclick="limpiarBusquedaCaducadas()"
          style="
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          Limpiar
        </button>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <!-- Secci√≥n Caducadas -->
      <div style="background: var(--card); border: 1px solid var(--muted); border-radius: 12px; padding: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
          <div style="width: 12px; height: 12px; background: var(--danger); border-radius: 50%;"></div>
          <h4 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">Caducadas (${
            caducados.length
          })</h4>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          ${
            caducados.length === 0
              ? '<div style="text-align: center; padding: 2rem; color: var(--sub);">No hay membres√≠as caducadas</div>'
              : caducados
                  .map((u) => {
                    const d = daysDiff(u.membresiaFin, NOW());
                    return `
                <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <div>
                      <div style="font-weight: 600; color: var(--text); font-size: 1rem;">${
                        u.nombres
                      } ${u.apellidos}</div>
                      <div style="font-size: 0.85rem; color: var(--sub);">C√©dula: ${
                        u.cedula
                      }</div>
                    </div>
                    <span style="background: var(--danger); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">hace ${Math.abs(
                      d
                    )} d√≠as</span>
                  </div>
                  <div style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.8rem;">
                    Vencida el: ${fmtDate(u.membresiaFin)}
                  </div>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn" onclick='abrirCuenta("${
                      u.id
                    }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                      Ver Cuenta
                    </button>
                    <button class="btn" onclick='abrirModalWhatsApp("${
                      u.id
                    }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                      WhatsApp
                    </button>
                    <button class="btn success" onclick='abrirModalRenovarMembresia("${
                      u.id
                    }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                      Renovar
                    </button>
                  </div>
                </div>
              `;
                  })
                  .join("")
          }
        </div>
      </div>

      <!-- Secci√≥n Por Caducar -->
      <div style="background: var(--card); border: 1px solid var(--muted); border-radius: 12px; padding: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
          <div style="width: 12px; height: 12px; background: #fd7e14; border-radius: 50%;"></div>
          <h4 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">Por caducar (${
            porCaducar.length
          })</h4>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          ${
            porCaducar.length === 0
              ? '<div style="text-align: center; padding: 2rem; color: var(--sub);">No hay membres√≠as por caducar</div>'
              : porCaducar
                  .map((u) => {
                    const d = daysDiff(u.membresiaFin, NOW());
                    return `
                <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <div>
                      <div style="font-weight: 600; color: var(--text); font-size: 1rem;">${
                        u.nombres
                      } ${u.apellidos}</div>
                      <div style="font-size: 0.85rem; color: var(--sub);">C√©dula: ${
                        u.cedula
                      }</div>
                    </div>
                    <span style="background: #fd7e14; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${d} d√≠as</span>
                  </div>
                  <div style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.8rem;">
                    Vence el: ${fmtDate(u.membresiaFin)}
                  </div>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn success" onclick='renovar("${
                      u.id
                    }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                      Renovar
                    </button>
                    <button class="btn" onclick='abrirModalWhatsApp("${
                      u.id
                    }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                      WhatsApp
                    </button>
                    <button class="btn" onclick='activarQR("${
                      u.id
                    }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                      QR
                    </button>
                  </div>
                </div>
              `;
                  })
                  .join("")
          }
        </div>
      </div>
    </div>`;
        root.append(card);
      }
      function renovar(id) {
        const u = DB.users.find((x) => x.id === id);
        if (!u) return;
        const mem = DB.memberships.find((m) => m.id === u.membresia);
        const hoy = new Date();
        u.membresiaInicio = hoy.toISOString();
        const dias =
          mem?.nombre === "Trimestral"
            ? 90
            : mem?.nombre === "Anual"
            ? 365
            : 30;
        const fin = new Date(hoy.getTime() + dias * 86400000);
        u.membresiaFin = fin.toISOString();
        u.activo = true;
        save();
        alert("Membres√≠a renovada");
        render();
      }
      function activarQR(id) {
        alert("QR activado para el cliente " + id + " (demo)");
      }

      /******************** SECCI√ìN 4: NUEVOS CLIENTES ********************/
      function renderNuevos(root) {
        const arr = [...DB.users].sort(
          (a, b) => new Date(b.creadoAt) - new Date(a.creadoAt)
        );
        const rows = arr
          .map(
            (u) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
              u.id
            }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
    <td>${fmtDate(u.creadoAt)} ${fmtTime(u.creadoAt)}</td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${DB.settings.sucursal}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); visualizarCliente('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üëÅÔ∏è Ver Info
        </button>
        <button class="btn success" onclick="event.stopPropagation(); editarClientePerfil('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          ‚úèÔ∏è Editar
        </button>
      </div>
    </td>
  </tr>`
          )
          .join("");
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 class="section-title" style="margin: 0;">Nuevos clientes</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <input
          type="text"
          id="buscarNuevosClientes"
          placeholder="Buscar por nombre o c√©dula..."
          style="
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            width: 250px;
          "
          oninput="filtrarNuevosClientes()"
        />
        <button
          onclick="limpiarBusquedaNuevos()"
          style="
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          Limpiar
        </button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Fecha de registro</th>
          <th>Membres√≠a</th>
          <th>Sucursal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaNuevosClientes">${rows}</tbody>
    </table>`;
        root.append(card);
      }

      /******************** SECCI√ìN 5: INACTIVOS ********************/
      function renderInactivos(root) {
        const cut = new Date();
        cut.setDate(cut.getDate() - 30);
        const arr = DB.users.filter(
          (u) =>
            (!u.ultimoIngreso || new Date(u.ultimoIngreso) < cut) &&
            new Date(u.membresiaFin) >= new Date()
        );
        const rows = arr
          .map(
            (u) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
              u.id
            }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${u.ultimoIngreso ? fmtDate(u.ultimoIngreso) : "-"}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üì± WhatsApp
        </button>
        <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí≥ Ver su cuenta
        </button>
      </div>
    </td>
  </tr>`
          )
          .join("");
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 class="section-title" style="margin: 0;">Clientes inactivos (Mas de 30 d√≠as sin venir)</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <input
          type="text"
          id="buscarInactivos"
          placeholder="Buscar por nombre o c√©dula..."
          style="
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            width: 250px;
          "
          oninput="filtrarInactivos()"
        />
        <button
          onclick="limpiarBusquedaInactivos()"
          style="
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          Limpiar
        </button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Membres√≠a</th>
          <th>√öltimo ingreso</th>
          <th>Opciones</th>
        </tr>
      </thead>
      <tbody id="tablaInactivos">${
        rows || '<tr><td colspan=4 class="muted">No hay</td></tr>'
      }</tbody>
    </table>`;
        root.append(card);
      }

      /******************** SECCI√ìN 6: DEUDORES ********************/
      function renderDeudores(root) {
        const arr = DB.users.filter((u) => (u.saldo || 0) > 0);
        const rows = arr
          .map(
            (u) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
              u.id
            }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${u.ultimoIngreso ? fmtDate(u.ultimoIngreso) : "-"}</td>
    <td style="color: var(--danger); font-weight: 600;">$ ${u.saldo.toFixed(
      2
    )}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üì± WhatsApp
        </button>
        <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí≥ Ver su cuenta
        </button>
        <button class="btn success" onclick="event.stopPropagation(); registrarPago('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí∞ Registrar pago
        </button>
      </div>
    </td>
  </tr>`
          )
          .join("");
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 class="section-title" style="margin: 0;">Deudores</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <input
          type="text"
          id="buscarDeudores"
          placeholder="Buscar por nombre o c√©dula..."
          style="
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            width: 250px;
          "
          oninput="filtrarDeudores()"
        />
        <button
          onclick="limpiarBusquedaDeudores()"
          style="
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          Limpiar
        </button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Membres√≠a</th>
          <th>√öltimo ingreso</th>
          <th>Saldo a deber</th>
          <th>Opciones</th>
        </tr>
      </thead>
      <tbody id="tablaDeudores">${
        rows || '<tr><td colspan=5 class="muted">No hay</td></tr>'
      }</tbody>
    </table>`;
        root.append(card);
      }

      /******************** SECCI√ìN 7: CUMPLEA√ëOS ********************/
      function renderCumples(root) {
        const meses = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        // Agrupar clientes por mes de cumplea√±os
        const clientesPorMes = {};

        // Inicializar todos los meses
        meses.forEach((mes, index) => {
          clientesPorMes[index] = [];
        });

        // Agrupar clientes por mes
        DB.users.forEach((u) => {
          const mesNacimiento = new Date(u.nacimiento).getMonth();
          clientesPorMes[mesNacimiento].push(u);
        });

        // Ordenar clientes por d√≠a dentro de cada mes
        Object.keys(clientesPorMes).forEach((mes) => {
          clientesPorMes[mes].sort(
            (a, b) =>
              new Date(a.nacimiento).getDate() -
              new Date(b.nacimiento).getDate()
          );
        });

        const card = document.createElement("div");
        card.className = "card";

        let contenidoHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 class="section-title" style="margin: 0;">Cumplea√±os por Mes</h3>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input
                type="text"
                id="buscarCumpleanos"
                placeholder="Buscar por nombre o c√©dula..."
                style="
                  padding: 0.5rem 0.8rem;
                  border: 1px solid var(--muted);
                  border-radius: 6px;
                  background: white;
                  width: 250px;
                "
                oninput="filtrarCumpleanos()"
              />
              <button
                onclick="limpiarBusquedaCumpleanos()"
                style="
                  background: var(--panel);
                  color: var(--text);
                  border: 1px solid var(--muted);
                  padding: 0.5rem 1rem;
                  border-radius: 6px;
                  cursor: pointer;
                "
              >
                Limpiar
              </button>
            </div>
          </div>
        `;

        // Crear secciones por mes
        meses.forEach((nombreMes, index) => {
          const clientesDelMes = clientesPorMes[index];
          const mesActual = new Date().getMonth();
          const esMesActual = index === mesActual;

          if (clientesDelMes.length > 0) {
            contenidoHTML += `
              <div style="
                background: ${
                  esMesActual ? "rgba(218, 131, 224, 0.1)" : "var(--card)"
                };
                border: 1px solid ${
                  esMesActual ? "var(--brand)" : "var(--muted)"
                };
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                ${
                  esMesActual
                    ? "box-shadow: 0 4px 12px rgba(218, 131, 224, 0.2);"
                    : ""
                }
              ">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <div style="
                    width: 12px;
                    height: 12px;
                    background: ${esMesActual ? "var(--brand)" : "var(--sub)"};
                    border-radius: 50%;
                  "></div>
                  <h4 style="
                    margin: 0;
                    color: var(--text);
                    font-size: 1.2rem;
                    font-weight: 600;
                    ${esMesActual ? "color: var(--brand);" : ""}
                  ">${nombreMes} ${esMesActual ? "(Mes Actual)" : ""}</h4>
                  <span style="
                    background: ${
                      esMesActual ? "var(--brand)" : "var(--panel)"
                    };
                    color: ${esMesActual ? "white" : "var(--text)"};
                    padding: 0.2rem 0.6rem;
                    border-radius: 12px;
                    font-size: 0.75rem;
                    font-weight: 600;
                  ">${clientesDelMes.length} ${
              clientesDelMes.length === 1 ? "cumplea√±ero" : "cumplea√±eros"
            }</span>
                </div>
                
                <div style="display: grid; gap: 0.8rem;">
                  ${clientesDelMes
                    .map((u) => {
                      const fechaCumple = new Date(u.nacimiento);
                      const dia = fechaCumple.getDate();
                      const mes = fechaCumple.getMonth();
                      const a√±o = fechaCumple.getFullYear();
                      const edad = new Date().getFullYear() - a√±o;
                      const proximoCumple = new Date(
                        new Date().getFullYear(),
                        mes,
                        dia
                      );
                      const hoy = new Date();

                      // Si ya pas√≥ el cumplea√±os este a√±o, calcular para el pr√≥ximo a√±o
                      if (proximoCumple < hoy) {
                        proximoCumple.setFullYear(hoy.getFullYear() + 1);
                      }

                      const diasRestantes = Math.ceil(
                        (proximoCumple - hoy) / (1000 * 60 * 60 * 24)
                      );
                      const esHoy = diasRestantes === 0;
                      const esProximo = diasRestantes <= 7 && diasRestantes > 0;

                      return `
                      <div style="
                        background: white;
                        border: 1px solid var(--muted);
                        border-radius: 8px;
                        padding: 1rem;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        ${
                          esHoy
                            ? "border-color: var(--ok); background: rgba(102, 187, 106, 0.1);"
                            : ""
                        }
                        ${
                          esProximo
                            ? "border-color: var(--warn); background: rgba(255, 167, 38, 0.1);"
                            : ""
                        }
                      " onclick="verClienteDetalle('${u.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text); font-size: 1rem;">
                              ${u.nombres} ${u.apellidos}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--sub); margin-top: 0.2rem;">
                              C√©dula: ${u.cedula}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--sub);">
                              ${dia} de ${meses[mes]} de ${a√±o} (${edad} a√±os)
                            </div>
                          </div>
                          <div style="text-align: right;">
                            ${
                              esHoy
                                ? `
                              <span style="
                                background: var(--ok);
                                color: white;
                                padding: 0.3rem 0.8rem;
                                border-radius: 20px;
                                font-size: 0.75rem;
                                font-weight: 600;
                              ">¬°HOY!</span>
                            `
                                : esProximo
                                ? `
                              <span style="
                                background: var(--warn);
                                color: white;
                                padding: 0.3rem 0.8rem;
                                border-radius: 20px;
                                font-size: 0.75rem;
                                font-weight: 600;
                              ">En ${diasRestantes} d√≠as</span>
                            `
                                : `
                              <span style="
                                background: var(--panel);
                                color: var(--text);
                                padding: 0.3rem 0.8rem;
                                border-radius: 20px;
                                font-size: 0.75rem;
                                font-weight: 600;
                              ">En ${diasRestantes} d√≠as</span>
                            `
                            }
                          </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                          <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
                            u.id
                          }')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                            üì± WhatsApp
                          </button>
                          <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
                            u.id
                          }')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                            üí≥ Ver cuenta
                          </button>
                          ${
                            esHoy || esProximo
                              ? `
                            <button class="btn success" onclick="event.stopPropagation(); enviarFelicitacion('${u.id}')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                              üéâ Felicitar
                            </button>
                          `
                              : ""
                          }
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>
              </div>
            `;
          }
        });

        // Si no hay cumplea√±os en ning√∫n mes
        const totalCumpleanos = Object.values(clientesPorMes).reduce(
          (total, clientes) => total + clientes.length,
          0
        );
        if (totalCumpleanos === 0) {
          contenidoHTML += `
            <div style="
              text-align: center;
              padding: 3rem;
              color: var(--sub);
              background: var(--panel);
              border-radius: 12px;
            ">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üéÇ</div>
              <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No hay cumplea√±os registrados</div>
              <div style="font-size: 0.9rem;">Los cumplea√±os aparecer√°n aqu√≠ cuando se registren clientes con fechas de nacimiento</div>
            </div>
          `;
        }

        card.innerHTML = contenidoHTML;
        root.append(card);
      }

      /******************** SECCI√ìN 8: REGISTRAR NUEVO CLIENTE ********************/
      function renderRegistro(root) {
        const card = document.createElement("div");
        card.className = "card";
        const memOpts = DB.memberships
          .map(
            (m) => `<option value="${m.id}">${m.nombre} ‚Äì $${m.monto}</option>`
          )
          .join("");
        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h3 class="section-title" style="margin: 0;">Registrar un nuevo cliente</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="color: var(--text); font-weight: 600;">* Campos obligatorios</span>
      </div>
        </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <!-- Columna izquierda: Informaci√≥n personal -->
      <div>
        <h4 style="margin: 0 0 1.5rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Informaci√≥n Personal
        </h4>
        
        <div style="display: grid; gap: 1rem;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Nombres *</label>
              <input id="r_nombres" class="input" placeholder="Ingrese nombres" style="width: 100%;" required />
      </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Apellidos *</label>
              <input id="r_apellidos" class="input" placeholder="Ingrese apellidos" style="width: 100%;" required />
    </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">C√©dula *</label>
              <input id="r_cedula" class="input" placeholder="Ingrese c√©dula" style="width: 100%;" required />
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Fecha de nacimiento</label>
              <input id="r_nac" class="date" type="date" style="width: 100%;" />
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Email</label>
              <input id="r_email" class="input" type="email" placeholder="ejemplo@email.com" style="width: 100%;" />
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Tel√©fono</label>
              <input id="r_tel" class="input" placeholder="+593 99 123 4567" style="width: 100%;" />
            </div>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Direcci√≥n</label>
            <input id="r_dir" class="input" placeholder="Ingrese direcci√≥n completa" style="width: 100%;" />
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">G√©nero</label>
              <select id="r_gen" class="select" style="width: 100%;">
                <option value="">Seleccionar g√©nero</option>
                <option value="Hombre">Hombre</option>
                <option value="Mujer">Mujer</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Obra Social</label>
              <input id="r_obra" class="input" placeholder="IESS, Privada, etc." style="width: 100%;" />
            </div>
          </div>
        </div>
      </div>
      
      <!-- Columna derecha: Foto y configuraci√≥n -->
      <div>
        <h4 style="margin: 0 0 1.5rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Foto y Configuraci√≥n
        </h4>
        
        <!-- √Årea de foto -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Foto del cliente</label>
          <div id="fotoPreview" style="
            width: 150px;
            height: 150px;
            border: 2px dashed var(--muted);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--panel);
            margin-bottom: 1rem;
          " onclick="document.getElementById('r_foto_file').click()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub); margin-bottom: 0.5rem;">
              <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div style="color: var(--sub); font-size: 0.9rem; text-align: center;">
              <div>Haz clic para</div>
              <div>subir foto</div>
            </div>
          </div>
          <input id="r_foto_file" type="file" accept="image/*" style="display: none;" onchange="previewFoto(this)" />
          <input id="r_foto" type="hidden" />
          <div style="font-size: 0.8rem; color: var(--sub);">
            Formatos: JPG, PNG, GIF. M√°ximo 5MB
          </div>
        </div>
        
        <!-- Configuraci√≥n de membres√≠a -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Tipo de membres√≠a *</label>
          <select id="r_mem" class="select" style="width: 100%;" required>
            <option value="">Seleccionar membres√≠a</option>
            ${memOpts}
          </select>
        </div>
        
        <!-- Tipo de usuario -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Tipo de usuario</label>
          <select id="r_tipo" class="select" style="width: 100%;" onchange="toggleCreds()">
            <option value="Cliente">Cliente</option>
            <option value="Empleado">Empleado</option>
            <option value="Ingreso">Ingreso</option>
            <option value="Administrador">Administrador</option>
          </select>
        </div>
        
        <!-- Notas -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Notas adicionales</label>
          <textarea id="r_notas" class="input" placeholder="Informaci√≥n adicional del cliente..." rows="3" style="width: 100%; resize: vertical;"></textarea>
        </div>
        
        <!-- Credenciales (solo para empleados) -->
        <div id="credBox" style="display:none; background: var(--panel); border-radius: 8px; padding: 1rem; border: 1px solid var(--muted);">
          <h5 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">Credenciales de acceso</h5>
          <div style="display: grid; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Contrase√±a</label>
              <input id="r_clave" class="input" type="password" placeholder="Ingrese contrase√±a" style="width: 100%;" />
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Estado</label>
              <select id="r_activo" class="select" style="width: 100%;">
                <option value="si">Activo</option>
                <option value="no">Inactivo</option>
              </select>
            </div>
          </div>
          <p class="muted mini" style="margin: 1rem 0 0 0;">Solo para roles: Empleado, Ingreso, Administrador</p>
        </div>
      </div>
    </div>
    
    <!-- Botones de acci√≥n -->
    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--muted);">
      <button class="btn" onclick="limpiarFormulario()" style="
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--muted);
        padding: 0.8rem 2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      ">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Limpiar
      </button>
      <button class="btn success" onclick="saveNuevo()" style="
        background: var(--ok);
        color: white;
        border: none;
        padding: 0.8rem 2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      ">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H16L21 8V19C21 20.1046 20.1046 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <polyline points="17,21 17,13 7,13 7,21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <polyline points="7,3 7,8 15,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Guardar Cliente
      </button>
    </div>`;
        root.append(card);
      }
      function toggleCreds() {
        const v = EL("#r_tipo").value;
        EL("#credBox").style.display = v !== "Cliente" ? "block" : "none";
      }

      function previewFoto(input) {
        const file = input.files[0];
        const preview = EL("#fotoPreview");

        if (file) {
          // Validar tama√±o (5MB m√°ximo)
          if (file.size > 5 * 1024 * 1024) {
            alert("La imagen es demasiado grande. M√°ximo 5MB permitido.");
            input.value = "";
            return;
          }

          // Validar tipo de archivo
          if (!file.type.startsWith("image/")) {
            alert("Por favor selecciona solo archivos de imagen.");
            input.value = "";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            // Convertir a base64 y guardar en el campo oculto
            EL("#r_foto").value = e.target.result;

            // Mostrar preview
            preview.innerHTML = `
              <img src="${e.target.result}" alt="Preview" style="
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 10px;
              " />
              <div style="
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 12px;
              " onclick="removerFoto()" title="Remover foto">√ó</div>
            `;
            preview.style.position = "relative";
            preview.style.border = "2px solid var(--brand)";
            preview.style.background = "white";
          };
          reader.readAsDataURL(file);
        }
      }

      function removerFoto() {
        EL("#r_foto_file").value = "";
        EL("#r_foto").value = "";
        const preview = EL("#fotoPreview");
        preview.innerHTML = `
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub); margin-bottom: 0.5rem;">
            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div style="color: var(--sub); font-size: 0.9rem; text-align: center;">
            <div>Haz clic para</div>
            <div>subir foto</div>
          </div>
        `;
        preview.style.position = "static";
        preview.style.border = "2px dashed var(--muted)";
        preview.style.background = "var(--panel)";
      }

      function limpiarFormulario() {
        // Limpiar todos los campos
        EL("#r_nombres").value = "";
        EL("#r_apellidos").value = "";
        EL("#r_cedula").value = "";
        EL("#r_nac").value = "";
        EL("#r_email").value = "";
        EL("#r_tel").value = "";
        EL("#r_dir").value = "";
        EL("#r_gen").value = "";
        EL("#r_obra").value = "";
        EL("#r_notas").value = "";
        EL("#r_tipo").value = "Cliente";
        EL("#r_mem").value = "";
        EL("#r_clave").value = "";
        EL("#r_activo").value = "si";

        // Limpiar foto
        removerFoto();

        // Ocultar credenciales
        EL("#credBox").style.display = "none";

        // Mostrar mensaje
        alert("Formulario limpiado correctamente");
      }

      function saveNuevo() {
        // Validar campos obligatorios
        const nombres = EL("#r_nombres").value.trim();
        const apellidos = EL("#r_apellidos").value.trim();
        const cedula = EL("#r_cedula").value.trim();
        const membresia = EL("#r_mem").value;

        if (!nombres || !apellidos || !cedula || !membresia) {
          alert("Por favor complete todos los campos obligatorios (*)");
          return;
        }

        // Validar c√©dula (debe tener 10 d√≠gitos)
        if (cedula.length !== 10 || !/^\d+$/.test(cedula)) {
          alert("La c√©dula debe tener exactamente 10 d√≠gitos num√©ricos");
          return;
        }

        // Verificar si la c√©dula ya existe
        const cedulaExistente = DB.users.find((u) => u.cedula === cedula);
        if (cedulaExistente) {
          alert("Ya existe un cliente registrado con esa c√©dula");
          return;
        }

        // Validar email si se proporciona
        const email = EL("#r_email").value.trim();
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          alert("Por favor ingrese un email v√°lido");
          return;
        }

        // Validar tel√©fono si se proporciona
        const telefono = EL("#r_tel").value.trim();
        if (telefono && telefono.length < 10) {
          alert("El tel√©fono debe tener al menos 10 d√≠gitos");
          return;
        }

        // Validar credenciales si es empleado
        const tipo = EL("#r_tipo").value;
        if (tipo !== "Cliente") {
          const clave = EL("#r_clave").value.trim();
          if (!clave) {
            alert("Por favor ingrese una contrase√±a para el empleado");
            return;
          }
        }

        const u = {
          id: uuid(),
          nombres: nombres,
          apellidos: apellidos,
          cedula: cedula,
          nacimiento: EL("#r_nac").value || null,
          email: email || "",
          telefono: telefono || "",
          direccion: EL("#r_dir").value.trim() || "",
          genero: EL("#r_gen").value || "",
          foto: EL("#r_foto").value || "",
          obraSocial: EL("#r_obra").value.trim() || "",
          notas: EL("#r_notas").value.trim() || "",
          tipo: tipo,
          activo: true,
          membresia: membresia,
          saldo: 0,
          inscritoPrimera: new Date().toISOString(),
          membresiaInicio: new Date().toISOString(),
          membresiaFin: new Date(Date.now() + 30 * 86400000).toISOString(),
          ultimoIngreso: null,
          creadoAt: new Date().toISOString(),
        };

        // Agregar credenciales si es empleado
        if (tipo !== "Cliente") {
          u.clave = EL("#r_clave").value;
          u.activo = EL("#r_activo").value === "si";
        }

        DB.users.push(u);
        save();

        // Mostrar mensaje de √©xito
        alert(`¬°Cliente ${u.nombres} ${u.apellidos} registrado exitosamente!`);

        // Limpiar formulario
        limpiarFormulario();

        // Actualizar vista
        render();
      }

      /******************** SECCI√ìN 9: EXPORTAR DATOS ********************/
      function renderExport(root) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
    <h3 class="section-title">Exportar asistencias a Excel (CSV)</h3>
    <div class="row">
      <input id="ex_from" class="date" type="date" />
      <input id="ex_to" class="date" type="date" />
      <button class="btn" onclick="doExport()">Exportar</button>
    </div>
    <p class="muted mini">Solo exporta clientes con asistencia entre las fechas.</p>`;
        root.append(card);
      }
      function doExport() {
        const from = new Date(EL("#ex_from").value);
        const to = new Date(EL("#ex_to").value);
        if (!EL("#ex_from").value || !EL("#ex_to").value)
          return alert("Seleccione ambas fechas");
        to.setHours(23, 59, 59, 999);
        const rows = DB.attendance.filter(
          (a) => new Date(a.at) >= from && new Date(a.at) <= to
        );
        const lines = [["Cliente", "C√©dula", "Tipo", "Fecha", "Hora"]];
        rows.forEach((a) => {
          const u = DB.users.find((x) => x.id === a.clientId);
          lines.push([
            `${u?.nombres} ${u?.apellidos}`,
            u?.cedula,
            a.type,
            fmtDate(a.at),
            fmtTime(a.at),
          ]);
        });
        const csv = lines
          .map((r) =>
            r
              .map((x) => `"${(x ?? "").toString().replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "asistencias.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      /******************** SECCI√ìN 10: MEMBRES√çAS ********************/
      function renderMembresias(root) {
        const card = document.createElement("div");
        card.className = "card";

        // Calcular estad√≠sticas
        const totalMembresias = DB.memberships.length;
        const totalClientes = DB.users.length;
        const membresiaMasPopular = DB.memberships.reduce((prev, current) => {
          const prevCount = DB.users.filter(
            (u) => u.membresia === prev.id
          ).length;
          const currentCount = DB.users.filter(
            (u) => u.membresia === current.id
          ).length;
          return currentCount > prevCount ? current : prev;
        }, DB.memberships[0]);

        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h3 class="section-title" style="margin: 0;">Gesti√≥n de Membres√≠as</h3>
      <button class="btn success" onclick="abrirModalNuevaMembresia()" style="
        background: var(--ok);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      ">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Nueva Membres√≠a
      </button>
    </div>
    
    <!-- Estad√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
      <div style="background: var(--panel); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--muted);">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="
            width: 50px;
            height: 50px;
            background: var(--brand);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
          ">${totalMembresias}</div>
          <div>
            <div style="font-weight: 600; color: var(--text);">Total Membres√≠as</div>
            <div style="font-size: 0.9rem; color: var(--sub);">Tipos disponibles</div>
          </div>
        </div>
      </div>
      
      <div style="background: var(--panel); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--muted);">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="
            width: 50px;
            height: 50px;
            background: var(--ok);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
          ">${totalClientes}</div>
          <div>
            <div style="font-weight: 600; color: var(--text);">Total Clientes</div>
            <div style="font-size: 0.9rem; color: var(--sub);">Registrados</div>
          </div>
        </div>
      </div>
      
      <div style="background: var(--panel); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--muted);">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="
            width: 50px;
            height: 50px;
            background: var(--warn);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
          ">${
            membresiaMasPopular
              ? DB.users.filter((u) => u.membresia === membresiaMasPopular.id)
                  .length
              : 0
          }</div>
          <div>
            <div style="font-weight: 600; color: var(--text);">M√°s Popular</div>
            <div style="font-size: 0.9rem; color: var(--sub);">${
              membresiaMasPopular ? membresiaMasPopular.nombre : "N/A"
            }</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabla de membres√≠as -->
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: var(--panel);">
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Membres√≠a</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Detalle</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Clientes</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Duraci√≥n</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Sucursal</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Precio</th>
            <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${
            DB.memberships.length === 0
              ? `
            <tr>
              <td colspan="7" style="text-align: center; padding: 3rem; color: var(--sub);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üèãÔ∏è</div>
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No hay membres√≠as registradas</div>
                <div style="font-size: 0.9rem;">Haz clic en "Nueva Membres√≠a" para crear la primera</div>
              </td>
            </tr>
          `
              : DB.memberships
                  .map((m) => {
                    const clientes = DB.users.filter(
                      (u) => u.membresia === m.id
                    ).length;
                    const porcentaje =
                      totalClientes > 0
                        ? Math.round((clientes / totalClientes) * 100)
                        : 0;
                    return `
              <tr style="border-bottom: 1px solid var(--muted);">
                <td style="padding: 1rem;">
                  <div style="font-weight: 600; color: var(--text); font-size: 1rem;">${
                    m.nombre
                  }</div>
                  <div style="font-size: 0.8rem; color: var(--sub);">ID: ${
                    m.id
                  }</div>
                </td>
                <td style="padding: 1rem; color: var(--text);">${
                  m.detalle || "Sin descripci√≥n"
                }</td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="font-weight: 600; color: var(--text);">${clientes}</div>
                  <div style="font-size: 0.8rem; color: var(--sub);">${porcentaje}% del total</div>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <span style="
                    background: var(--panel);
                    color: var(--text);
                    padding: 0.3rem 0.8rem;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                  ">${m.frecuencia}</span>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <span style="
                    background: var(--brand);
                    color: white;
                    padding: 0.3rem 0.8rem;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                  ">${m.sucursal}</span>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="font-weight: 700; color: var(--text); font-size: 1.1rem;">$ ${m.monto.toFixed(
                    2
                  )}</div>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button class="btn" onclick="editarMembresia('${
                      m.id
                    }')" style="
                      background: var(--brand);
                      color: white;
                      border: none;
                      padding: 0.4rem 0.8rem;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 0.8rem;
                      font-weight: 600;
                    " title="Editar membres√≠a">
                      ‚úèÔ∏è Editar
                    </button>
                    <button class="btn danger" onclick="eliminarMembresia('${
                      m.id
                    }')" style="
                      background: var(--danger);
                      color: white;
                      border: none;
                      padding: 0.4rem 0.8rem;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 0.8rem;
                      font-weight: 600;
                    " title="Eliminar membres√≠a">
                      üóëÔ∏è Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            `;
                  })
                  .join("")
          }
        </tbody>
      </table>
    </div>`;
        root.append(card);
      }
      function abrirModalMembresia(membresiaId = null) {
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        const esEdicion = membresiaId !== null;
        const membresia = esEdicion
          ? DB.memberships.find((m) => m.id === membresiaId)
          : null;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.5rem; font-weight: 700;">
                ${esEdicion ? "Editar" : "Nueva"} Membres√≠a
              </h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>
            
            <form id="formMembresia">
              <div style="display: grid; gap: 1.5rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Nombre de la membres√≠a *</label>
                  <input type="text" id="modal_mem_nombre" value="${
                    esEdicion ? membresia.nombre : ""
                  }" placeholder="Ej: Plan Mensual, Plan Anual, etc." style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  " required>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Descripci√≥n</label>
                  <textarea id="modal_mem_detalle" placeholder="Describe los beneficios de esta membres√≠a..." rows="3" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                    resize: vertical;
                  ">${esEdicion ? membresia.detalle || "" : ""}</textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Duraci√≥n *</label>
                    <input type="text" id="modal_mem_frecuencia" value="${
                      esEdicion ? membresia.frecuencia : ""
                    }" placeholder="Ej: 30 d√≠as, 90 d√≠as, 1 a√±o" style="
                      width: 100%;
                      padding: 0.8rem;
                      border: 1px solid var(--muted);
                      border-radius: 6px;
                      background: white;
                    " required>
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Sucursal *</label>
                    <select id="modal_mem_sucursal" style="
                      width: 100%;
                      padding: 0.8rem;
                      border: 1px solid var(--muted);
                      border-radius: 6px;
                      background: white;
                    " required>
                      <option value="">Seleccionar sucursal</option>
                      <option value="Matriz" ${
                        esEdicion && membresia.sucursal === "Matriz"
                          ? "selected"
                          : ""
                      }>Matriz</option>
                      <option value="Ponciano" ${
                        esEdicion && membresia.sucursal === "Ponciano"
                          ? "selected"
                          : ""
                      }>Ponciano</option>
                      <option value="QT" ${
                        esEdicion && membresia.sucursal === "QT"
                          ? "selected"
                          : ""
                      }>QT</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Precio *</label>
                  <div style="display: flex; align-items: center;">
                    <span style="
                      background: var(--panel);
                      border: 1px solid var(--muted);
                      border-right: none;
                      border-radius: 6px 0 0 6px;
                      padding: 0.8rem;
                      font-weight: 600;
                      color: var(--text);
                    ">$</span>
                    <input type="number" id="modal_mem_monto" value="${
                      esEdicion ? membresia.monto : ""
                    }" placeholder="0.00" step="0.01" min="0" style="
                      flex: 1;
                      padding: 0.8rem;
                      border: 1px solid var(--muted);
                      border-radius: 0 6px 6px 0;
                      background: white;
                    " required>
                  </div>
                </div>
                
                ${
                  esEdicion
                    ? `
                  <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; border: 1px solid #e9ecef;">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem;">Informaci√≥n de la membres√≠a</h5>
                    <div style="font-size: 0.9rem; color: var(--sub);">
                      <div><strong>ID:</strong> ${membresia.id}</div>
                      <div><strong>Clientes actuales:</strong> ${
                        DB.users.filter((u) => u.membresia === membresia.id)
                          .length
                      }</div>
                      <div><strong>Creada:</strong> ${
                        membresia.creadoAt
                          ? fmtDate(membresia.creadoAt)
                          : "No disponible"
                      }</div>
                    </div>
                  </div>
                `
                    : ""
                }
              </div>
              
              <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--muted);">
                <button type="button" onclick="this.closest('.modal').remove()" style="
                  background: var(--panel);
                  color: var(--text);
                  border: 1px solid var(--muted);
                  padding: 0.8rem 1.5rem;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 600;
                ">
                  Cancelar
                </button>
                <button type="submit" style="
                  background: var(--ok);
                  color: white;
                  border: none;
                  padding: 0.8rem 1.5rem;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 600;
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                ">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  ${esEdicion ? "Actualizar" : "Crear"} Membres√≠a
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Guardar el ID de la membres√≠a para edici√≥n
        if (esEdicion) {
          modal.dataset.membresiaId = membresiaId;
        }

        // Manejar el env√≠o del formulario
        const form = modal.querySelector("#formMembresia");
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const nombre = EL("#modal_mem_nombre").value.trim();
          const detalle = EL("#modal_mem_detalle").value.trim();
          const frecuencia = EL("#modal_mem_frecuencia").value.trim();
          const sucursal = EL("#modal_mem_sucursal").value;
          const monto = parseFloat(EL("#modal_mem_monto").value);

          // Validaciones
          if (
            !nombre ||
            !frecuencia ||
            !sucursal ||
            isNaN(monto) ||
            monto <= 0
          ) {
            alert(
              "Por favor complete todos los campos obligatorios y un precio v√°lido"
            );
            return;
          }

          if (esEdicion) {
            // Actualizar membres√≠a existente
            const membresia = DB.memberships.find(
              (m) => m.id === modal.dataset.membresiaId
            );
            if (membresia) {
              membresia.nombre = nombre;
              membresia.detalle = detalle;
              membresia.frecuencia = frecuencia;
              membresia.sucursal = sucursal;
              membresia.monto = monto;
              membresia.actualizadoAt = new Date().toISOString();
            }
          } else {
            // Crear nueva membres√≠a
            const nuevaMembresia = {
              id: uuid(),
              nombre: nombre,
              detalle: detalle,
              frecuencia: frecuencia,
              sucursal: sucursal,
              monto: monto,
              creadoAt: new Date().toISOString(),
            };
            DB.memberships.push(nuevaMembresia);
          }

          // Guardar y actualizar
          save();
          modal.remove();

          // Mostrar mensaje de √©xito
          alert(
            esEdicion
              ? `Membres√≠a "${nombre}" actualizada exitosamente`
              : `Membres√≠a "${nombre}" creada exitosamente`
          );

          // Actualizar vista
          render();
        });

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function editarMembresia(membresiaId) {
        abrirModalMembresia(membresiaId);
      }

      function eliminarMembresia(membresiaId) {
        const membresia = DB.memberships.find((m) => m.id === membresiaId);
        if (!membresia) return;

        // Verificar si hay clientes usando esta membres√≠a
        const clientesConMembresia = DB.users.filter(
          (u) => u.membresia === membresiaId
        );

        if (clientesConMembresia.length > 0) {
          alert(
            `No se puede eliminar la membres√≠a "${membresia.nombre}" porque ${clientesConMembresia.length} cliente(s) la est√°n usando actualmente.`
          );
          return;
        }

        if (
          confirm(
            `¬øEst√°s seguro de que quieres eliminar la membres√≠a "${membresia.nombre}"?`
          )
        ) {
          DB.memberships = DB.memberships.filter((m) => m.id !== membresiaId);
          save();
          alert(`Membres√≠a "${membresia.nombre}" eliminada exitosamente`);
          render();
        }
      }

      // Funciones legacy para compatibilidad
      function addMem() {
        abrirModalMembresia();
      }

      function editMem(id) {
        editarMembresia(id);
      }

      function delMem(id) {
        eliminarMembresia(id);
      }

      /******************** SECCI√ìN 11: INFORME DE PAGO ********************/
      function renderPagos(root) {
        const card = document.createElement("div");
        card.className = "card";

        // Obtener fecha actual
        const today = new Date().toISOString().split("T")[0];

        card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h3 class="section-title" style="margin: 0;">Informar Pago</h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="color: var(--text); font-weight: 600;">* Campos obligatorios</span>
    </div>
    </div>
    
    <div style="max-width: 600px; margin: 0 auto;">
      <form id="formInformarPago" style="display: grid; gap: 1.5rem;">
        <!-- Cliente -->
        <div>
          
          <div style="position: relative;">
            
            <div style="
              position: absolute;
              right: 0.8rem;
              top: 50%;
              transform: translateY(-50%);
              pointer-events: none;
            ">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Fecha de Pago -->
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Fecha de Pago *</label>
          <div style="position: relative;">
            <input id="pay_date" type="date" value="${today}" style="
              width: 100%;
              padding: 0.8rem;
              border: 1px solid var(--muted);
              border-radius: 6px;
              background: white;
              font-size: 1rem;
            " required>
            <div style="
              position: absolute;
              right: 0.8rem;
              top: 50%;
              transform: translateY(-50%);
              width: 20px;
              height: 20px;
              background: var(--panel);
              border-radius: 4px;
              display: grid;
              place-items: center;
              cursor: pointer;
            " onclick="document.getElementById('pay_date').showPicker()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"/>
                <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"/>
                <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Banco -->
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Banco *</label>
          <div style="position: relative;">
            <select id="pay_bank" style="
              width: 100%;
              padding: 0.8rem;
              border: 1px solid var(--muted);
              border-radius: 6px;
              background: white;
              font-size: 1rem;
              appearance: none;
            " required>
              <option value="">Seleccione</option>
              <option value="Banco del Pichincha">Banco del Pichincha</option>
              <option value="Banco de Guayaquil">Banco de Guayaquil</option>
              <option value="Banco Internacional">Banco Internacional</option>
              <option value="Banco Produbanco">Banco Produbanco</option>
              <option value="Banco Bolivariano">Banco Bolivariano</option>
              <option value="Banco Pacifico">Banco Pacifico</option>
              <option value="Banco de Loja">Banco de Loja</option>
              <option value="Banco del Austro">Banco del Austro</option>
              <option value="Banco Solidario">Banco Solidario</option>
              <option value="Banco Uni√≥n">Banco Uni√≥n</option>
              <option value="Banco General Rumi√±ahui">Banco General Rumi√±ahui</option>
              <option value="Banco Comercial de Manab√≠">Banco Comercial de Manab√≠</option>
              <option value="Banco de Machala">Banco de Machala</option>
              <option value="Banco Territorial">Banco Territorial</option>
              <option value="Banco de la Producci√≥n">Banco de la Producci√≥n</option>
            </select>
            <div style="
              position: absolute;
              right: 0.8rem;
              top: 50%;
              transform: translateY(-50%);
              pointer-events: none;
            ">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Monto -->
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Monto *</label>
          <div style="display: flex; align-items: center;">
            <span style="
              background: var(--panel);
              border: 1px solid var(--muted);
              border-right: none;
              border-radius: 6px 0 0 6px;
              padding: 0.8rem;
              font-weight: 600;
              color: var(--text);
              font-size: 1rem;
            ">$</span>
            <input id="pay_amount" type="number" placeholder="Ingrese el monto..." step="0.01" min="0" style="
              flex: 1;
              padding: 0.8rem;
              border: 1px solid var(--muted);
              border-radius: 0 6px 6px 0;
              background: white;
              font-size: 1rem;
            " required>
          </div>
        </div>
        
        <!-- Detalle -->
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Detalle (Opcional)</label>
          <input id="pay_det1" type="text" placeholder="Detalle de tu pago. Ejemplo: Pago mes octubre" style="
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            font-size: 1rem;
          ">
        </div>
        
        <!-- Detalle adicional -->
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Detalle adicional (Opcional)</label>
          <input id="pay_det2" type="text" placeholder="Informaci√≥n adicional del pago" style="
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: white;
            font-size: 1rem;
          ">
        </div>
        
        <!-- Usuario que informa -->
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Creado por</label>
          <input id="pay_userName" type="text" value="${
            DB.settings.usuario || "Admin"
          }" readonly style="
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--muted);
            border-radius: 6px;
            background: var(--panel);
            color: var(--text);
            font-size: 1rem;
            cursor: not-allowed;
          ">
        </div>
        
        <!-- Mensaje informativo -->
        <div style="
          background: #e3f2fd;
          border: 1px solid #2196f3;
          border-radius: 8px;
          padding: 1rem;
          margin: 1rem 0;
        ">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="#2196f3" stroke-width="2"/>
              <path d="M12 6V12L16 14" stroke="#2196f3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span style="font-weight: 600; color: #1976d2;">Informaci√≥n importante</span>
          </div>
          <p style="margin: 0; color: #1976d2; font-size: 0.9rem; line-height: 1.4;">
            La actualizaci√≥n de su cuenta puede demorar hasta 3 d√≠as h√°biles dependiendo de su banco.
          </p>
        </div>
        
        <!-- Bot√≥n de env√≠o -->
        <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
          <button type="submit" style="
            background: var(--ok);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='#2e7d32'" onmouseout="this.style.background='var(--ok)'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Informar Pago
          </button>
        </div>
      </form>
    </div>
    
    <div class="sep" style="margin: 2rem 0;"></div>
    
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <div style="padding: 1.5rem; border-bottom: 1px solid var(--muted);">
        <h4 style="margin: 0; color: var(--text); font-size: 1.2rem; font-weight: 600;">Pagos informados</h4>
      </div>
      <div id="pagosTabla"></div>
    </div>`;
        root.append(card);

        // Agregar event listener para el formulario
        const form = card.querySelector("#formInformarPago");
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          informarPago();
        });

        drawPagosTabla();
      }
      function informarPago() {
        const id = EL("#pay_user").value;
        const amount = Number(EL("#pay_amount").value || 0);
        if (!id || !amount) return alert("Seleccione cliente y monto");
        DB.payments.push({
          id: uuid(),
          clientId: id,
          amount,
          bank: EL("#pay_bank").value,
          note: (EL("#pay_det1").value + " " + EL("#pay_det2").value).trim(),
          at: new Date(EL("#pay_date").value).toISOString(),
          user: EL("#pay_userName").value,
        });
        const u = DB.users.find((x) => x.id === id);
        if (u) {
          u.saldo = Math.max(0, (u.saldo || 0) - amount);
        }
        save();
        alert("Pago registrado");
        drawPagosTabla();
      }
      function drawPagosTabla() {
        const rows = DB.payments
          .slice()
          .reverse()
          .map((p) => {
            const u = DB.users.find((x) => x.id === p.clientId);
            return `
              <tr style="border-bottom: 1px solid var(--muted);">
                <td style="padding: 1rem; color: var(--text); font-weight: 600;">${fmtDate(
                  p.at
                )}</td>
                <td style="padding: 1rem;">
                  <div style="font-weight: 600; color: var(--text);">${
                    u?.nombres
                  } ${u?.apellidos}</div>
                  <div style="font-size: 0.8rem; color: var(--sub);">${
                    u?.cedula || ""
                  }</div>
                </td>
                <td style="padding: 1rem;">
                  <span style="
                    background: var(--brand);
                    color: white;
                    padding: 0.3rem 0.8rem;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                  ">${p.bank || "-"}</span>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="font-weight: 700; color: var(--text); font-size: 1.1rem;">$ ${p.amount.toFixed(
                    2
                  )}</div>
                </td>
                <td style="padding: 1rem; color: var(--text);">${
                  p.note || "-"
                }</td>
                <td style="padding: 1rem; text-align: center;">
                  <span style="
                    background: var(--panel);
                    color: var(--text);
                    padding: 0.3rem 0.8rem;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                  ">${p.user || "-"}</span>
                </td>
              </tr>
            `;
          })
          .join("");

        EL("#pagosTabla").innerHTML =
          DB.payments.length === 0
            ? `
          <div style="text-align: center; padding: 3rem; color: var(--sub);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üí≥</div>
            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No hay pagos registrados</div>
            <div style="font-size: 0.9rem;">Los pagos informados aparecer√°n aqu√≠</div>
          </div>
        `
            : `
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--panel);">
                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Fecha</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Cliente</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Banco</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Monto</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Detalle</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--muted);">Usuario</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      }
      function abrirPagos(id) {
        const cliente = DB.users.find((u) => u.id === id);
        if (cliente) {
          currentClientDetail = cliente;
          active = "cliente-detalle";
          render();
        }
      }
      function registrarPago(id) {
        // Obtener el cliente
        const cliente = DB.users.find((u) => u.id === id);
        if (!cliente) return;

        // Configurar el modal con los datos del cliente
        EL("#pagoFecha").value = new Date().toISOString().slice(0, 16);
        EL(
          "#pagoDetalle"
        ).value = `Pago de ${cliente.nombres} ${cliente.apellidos}`;
        EL("#pagoMonto").value = "";
        EL("#pagoMetodo").value = "Efectivo";
        EL("#pagoSucursal").value = DB.settings.sucursal || "Matriz";
        EL("#pagoNotas").value = "";

        // Guardar el ID del cliente en el modal para usarlo al guardar
        EL("#modalPago").dataset.clienteId = id;

        // Abrir el modal
        abrirModalPago();
      }
      function abrirCuenta(id) {
        const u = DB.users.find((x) => x.id === id);
        if (u) {
          currentClient = u;
          currentClientDetail = u;
          active = "cliente-detalle";
          render();
        } else {
          alert("Cliente no encontrado");
        }
      }

      /******************** EDITAR CLIENTE (B√ÅSICO) ********************/
      function editarCliente(id) {
        const u = DB.users.find((x) => x.id === id);
        if (!u) return;
        const tel = prompt("Tel√©fono", u.telefono || "");
        if (tel == null) return;
        u.telefono = tel;
        save();
        showCliente(u);
      }

      /******************** TEMA ********************/
      function toggleTheme() {
        const body = document.body;
        const dark = body.dataset.theme === "dark";
        if (dark) {
          body.dataset.theme = "light";
          document.documentElement.style.setProperty("--bg", "#f5f5f5");
          document.documentElement.style.setProperty("--panel", "#f0f0f0");
          document.documentElement.style.setProperty("--card", "#ffffff");
          document.documentElement.style.setProperty("--muted", "#e8e8e8");
          document.documentElement.style.setProperty("--text", "#000000");
          document.documentElement.style.setProperty("--sub", "#000000");
        } else {
          body.dataset.theme = "dark";
          document.documentElement.style.setProperty("--bg", "#282624");
          document.documentElement.style.setProperty("--panel", "#333333");
          document.documentElement.style.setProperty("--card", "#3a3a3a");
          document.documentElement.style.setProperty("--muted", "#444444");
          document.documentElement.style.setProperty("--text", "#ffffff");
          document.documentElement.style.setProperty("--sub", "#ffffff");
        }
      }

      // Auto-login si ya est√° la sesi√≥n (demo)
      if (sessionStorage.getItem("auth") === "ok") {
        EL("#loginView").classList.add("hidden");
        EL("#appView").classList.remove("hidden");
        initApp();
      }

      // Funci√≥n para limpiar localStorage y recargar datos (para desarrollo)
      function limpiarDatosYRecargar() {
        localStorage.removeItem("gymdb_v1");
        location.reload();
      }

      /******************** VISTA DETALLADA DEL CLIENTE ********************/
      function renderClienteDetalle(root, cliente) {
        const diasRest = daysDiff(cliente.membresiaFin, NOW());
        const estado =
          diasRest < 0
            ? `<span class='badge tag-danger'>Caducada hace ${Math.abs(
                diasRest
              )} d√≠as</span>`
            : diasRest <= 5
            ? `<span class='badge tag-warn'>${diasRest} d√≠as para caducar</span>`
            : `<span class='badge tag-success'>Vigente (${diasRest} d√≠as)</span>`;

        root.innerHTML = `
          <div style="background: var(--card); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <!-- Header del cliente -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
              <div style="display: flex; align-items: center; gap: 1.5rem;">
                <img src="${
                  cliente.foto ||
                  "https://i.pinimg.com/1200x/18/46/68/1846687bddac97ce0d0c949348e3f74f.jpg"
                }" 
                     alt="Foto del cliente" 
                     style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--brand);">
                <div>
                  <h2 style="margin: 0; color: var(--text); font-size: 1.8rem; font-weight: 700;">${
                    cliente.nombres
                  } ${cliente.apellidos}</h2>
                  <p style="margin: 0.3rem 0 0 0; color: var(--sub); font-size: 1rem;">Usuario registrado el ${fmtDate(
                    cliente.inscritoPrimera
                  )}</p>
                </div>
              </div>
              <div style="display: flex; gap: 1rem;">
                <button class="btn" onclick="visualizarCliente('${
                  cliente.id
                }')" style="background: var(--brand); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12S5 4 12 4s11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  üëÅÔ∏è Visualizar toda la informaci√≥n
                </button>
                <button class="btn success" onclick="editarClientePerfil('${
                  cliente.id
                }')" style="background: var(--ok); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  ‚úèÔ∏è Editar perfil
                </button>
                <button class="btn" onclick="abrirModalWhatsApp('${
                  cliente.id
                }')" style="background: #25D366; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  üì± Enviar WhatsApp
                </button>
              </div>
            </div>

            <!-- Barra de estado -->
            <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding: 1rem; background: var(--panel); border-radius: 8px;">
              <div style="background: var(--ok); color: white; padding: 0.4rem 1rem; border-radius: 6px; font-weight: 600;">Cuenta al d√≠a</div>
              <div style="color: var(--text); font-weight: 600;">C√©dula ${
                cliente.cedula
              }</div>
              <div style="color: var(--text);">√öltima Asistencia: hace 1 hora</div>
              
            </div>

                      <!-- Pesta√±as de navegaci√≥n -->
          <div style="display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 2px solid var(--muted);">
            <button class="tab-btn active" onclick="cambiarTabCliente('cuenta')" style="padding: 1rem 2rem; background: var(--brand); color: white; border: none; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer;">$ Cuenta Corriente</button>
            <button class="tab-btn" onclick="cambiarTabCliente('membresias')" style="padding: 1rem 2rem; background: transparent; color: var(--text); border: none; font-weight: 600; cursor: pointer;">Membres√≠as</button>
          </div>

            <!-- Contenido de las pesta√±as -->
            <div id="tab-content">
              ${renderTabCuenta(cliente)}
            </div>
          </div>
        `;
      }

      function cambiarTabCliente(tab) {
        // Actualizar botones de pesta√±as
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.style.background = "transparent";
          btn.style.color = "var(--text)";
          btn.style.borderRadius = "0";
        });
        event.target.style.background = "var(--brand)";
        event.target.style.color = "white";
        event.target.style.borderRadius = "8px 8px 0 0";

        // Actualizar contenido
        const tabContent = document.getElementById("tab-content");
        if (tab === "cuenta") {
          tabContent.innerHTML = renderTabCuenta(currentClientDetail);
        } else if (tab === "membresias") {
          tabContent.innerHTML = renderTabMembresias(currentClientDetail);
        }
      }

      function renderTabCuenta(cliente) {
        return `
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="color: var(--text);">Mostrar</span>
                <select style="border: 1px solid var(--muted); border-radius: 4px; padding: 0.3rem; background: white;">
                  <option>10</option>
                  <option>25</option>
                  <option>50</option>
                </select>
                <span style="color: var(--text);">registros</span>
              </div>
                             <div style="display: flex; gap: 1rem;">
                 <button class="btn" onclick="abrirModalCargo()" style="background: var(--danger); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                   <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                     <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                   </svg>
                   Nuevo Cargo
                 </button>
                 <button class="btn" onclick="abrirModalPago()" style="background: var(--ok); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                   <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                     <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                   </svg>
                   Nuevo Pago
                 </button>
               </div>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="color: var(--text);">Buscar:</span>
                <input type="text" placeholder="Buscar registros..." style="border: 1px solid var(--muted); border-radius: 4px; padding: 0.3rem 0.6rem; background: white;">
              </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
              <thead>
                <tr style="background: var(--panel);">
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">
                    Fecha ‚Üï
                  </th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">
                    Detalle ‚Üï
                  </th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">
                    Sucursal ‚Üï
                  </th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">
                    Usuario ‚Üï
                  </th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">
                    Monto ‚Üï
                  </th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">
                    Acciones ‚Üï
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr style="background: rgba(102, 187, 106, 0.1);">
                  <td style="padding: 1rem; color: var(--text);">21-07-2025</td>
                  <td style="padding: 1rem; color: var(--text);">TRIMESTRAL</td>
                  <td style="padding: 1rem;">
                    <span style="background: var(--brand); color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">QT</span>
                  </td>
                  <td style="padding: 1rem;">
                    <span style="background: #333; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">UQ</span>
                  </td>
                  <td style="padding: 1rem; color: var(--text); font-weight: 600;">Tarjeta $ 150,00</td>
                  <td style="padding: 1rem;">
                    <button style="background: none; border: none; cursor: pointer; color: var(--text);">‚ãÆ</button>
                  </td>
                </tr>
                <tr style="background: rgba(239, 83, 80, 0.1);">
                  <td style="padding: 1rem; color: var(--text);">21-07-2025</td>
                  <td style="padding: 1rem; color: var(--text);">trimestral QT [Julio 2025] Trimestral (3)</td>
                  <td style="padding: 1rem;">
                    <span style="background: var(--brand); color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">QT</span>
                  </td>
                  <td style="padding: 1rem;">
                    <span style="background: #333; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">PG</span>
                  </td>
                  <td style="padding: 1rem; color: var(--text); font-weight: 600;">$ 150,00</td>
                  <td style="padding: 1rem;">
                    <button style="background: none; border: none; cursor: pointer; color: var(--text);">‚ãÆ</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }

      function renderTabMembresias(cliente) {
        return `
          <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="color: var(--text); margin: 0; font-size: 1.2rem; font-weight: 600;">Membres√≠as del Cliente</h3>
              <button onclick="abrirModalMembresia()" style="background: var(--ok); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Nueva Membres√≠a
              </button>
            </div>
            
            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--panel);">
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">#</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">Membresia</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">Descuento</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">Inicio</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">Vencimiento</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">Auto-Renovaci√≥n</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--muted);">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom: 1px solid var(--muted);">
                    <td style="padding: 1rem; color: var(--text);">27558</td>
                    <td style="padding: 1rem; color: var(--text);">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        Plan Anual
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub);">
                          <path d="M9.09 9C9.3251 8.33167 9.78918 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.30197 14.92 10C14.92 12 11.92 13 11.92 13M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                    </td>
                    <td style="padding: 1rem;">
                    </td>
                    <td style="padding: 1rem; color: var(--text);">04/02/2025</td>
                    <td style="padding: 1rem;">
                      <span style="background: #17a2b8; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">VENCE EN 5 MESES</span>
                    </td>
                    <td style="padding: 1rem;">
                      <span style="background: #fd7e14; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">NO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <div style="display: flex; gap: 0.5rem;">
                        <button style="background: var(--danger); color: white; border: none; padding: 0.4rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                        <button style="background: var(--brand); color: white; border: none; padding: 0.4rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V5M16 2V5M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--muted);">
                    <td style="padding: 1rem; color: var(--text);">18473</td>
                    <td style="padding: 1rem; color: var(--text);">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        Plan Mensual
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub);">
                          <path d="M9.09 9C9.3251 8.33167 9.78918 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.30197 14.92 10C14.92 12 11.92 13 11.92 13M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                    </td>
                    <td style="padding: 1rem;">
                    </td>
                    <td style="padding: 1rem; color: var(--text);">04/02/2024</td>
                    <td style="padding: 1rem;">
                      <span style="background: var(--danger); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">VENCIDO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <span style="background: #fd7e14; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">NO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <div style="display: flex; gap: 0.5rem;">
                        <button style="background: var(--brand); color: white; border: none; padding: 0.4rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V5M16 2V5M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--muted);">
                    <td style="padding: 1rem; color: var(--text);">18472</td>
                    <td style="padding: 1rem; color: var(--text);">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        Plan Trimestral
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub);">
                          <path d="M9.09 9C9.3251 8.33167 9.78918 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.30197 14.92 10C14.92 12 11.92 13 11.92 13M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                    </td>
                    <td style="padding: 1rem;">
                    </td>
                    <td style="padding: 1rem; color: var(--text);">15/01/2024</td>
                    <td style="padding: 1rem;">
                      <span style="background: var(--danger); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">VENCIDO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <span style="background: #fd7e14; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">NO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <div style="display: flex; gap: 0.5rem;">
                        <button style="background: var(--brand); color: white; border: none; padding: 0.4rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V5M16 2V5M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--muted);">
                    <td style="padding: 1rem; color: var(--text);">18471</td>
                    <td style="padding: 1rem; color: var(--text);">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        Plan Semanal
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub);">
                          <path d="M9.09 9C9.3251 8.33167 9.78918 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.30197 14.92 10C14.92 12 11.92 13 11.92 13M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                    </td>
                    <td style="padding: 1rem;">
                    </td>
                    <td style="padding: 1rem; color: var(--text);">10/01/2024</td>
                    <td style="padding: 1rem;">
                      <span style="background: var(--danger); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">VENCIDO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <span style="background: #fd7e14; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">NO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <div style="display: flex; gap: 0.5rem;">
                        <button style="background: var(--brand); color: white; border: none; padding: 0.4rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V5M16 2V5M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td style="padding: 1rem; color: var(--text);">18470</td>
                    <td style="padding: 1rem; color: var(--text);">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        Plan Diario
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--sub);">
                          <path d="M9.09 9C9.3251 8.33167 9.78918 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.30197 14.92 10C14.92 12 11.92 13 11.92 13M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                    </td>
                    <td style="padding: 1rem;">
                    </td>
                    <td style="padding: 1rem; color: var(--text);">05/01/2024</td>
                    <td style="padding: 1rem;">
                      <span style="background: var(--danger); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">VENCIDO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <span style="background: #fd7e14; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">NO</span>
                    </td>
                    <td style="padding: 1rem;">
                      <div style="display: flex; gap: 0.5rem;">
                        <button style="background: var(--brand); color: white; border: none; padding: 0.4rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V5M16 2V5M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      /******************** FUNCIONES DE MODALES ********************/
      function abrirModalCargo() {
        const modal = document.getElementById("modalCargo");
        modal.style.display = "flex";

        // Establecer fecha y hora actual
        const now = new Date();
        const fechaHora = now.toISOString().slice(0, 16);
        document.getElementById("cargoFecha").value = fechaHora;

        // Limpiar formulario
        document.getElementById("formCargo").reset();
      }

      function cerrarModalCargo() {
        const modal = document.getElementById("modalCargo");
        modal.style.display = "none";
      }

      function abrirModalPago() {
        const modal = document.getElementById("modalPago");
        modal.style.display = "flex";

        // Establecer fecha y hora actual
        const now = new Date();
        const fechaHora = now.toISOString().slice(0, 16);
        document.getElementById("pagoFecha").value = fechaHora;

        // Limpiar formulario
        document.getElementById("formPago").reset();
      }

      function cerrarModalPago() {
        const modal = document.getElementById("modalPago");
        modal.style.display = "none";
      }

      function abrirModalWhatsApp(clienteId) {
        const modal = document.getElementById("modalWhatsApp");
        modal.style.display = "flex";

        // Obtener el cliente
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) return;

        // Configurar el tel√©fono
        let telefono = cliente.telefono || "";
        // Limpiar el tel√©fono para formato internacional
        telefono = telefono.replace(/\D/g, ""); // Solo n√∫meros
        if (telefono.startsWith("0")) telefono = telefono.substring(1);
        if (telefono.startsWith("593")) telefono = telefono;
        else if (telefono.length === 9) telefono = "593" + telefono;

        EL("#whatsappTelefono").value = telefono;
        EL("#whatsappPlantilla").value = "deudor";

        // Generar mensaje inicial
        generarMensajeWhatsApp(cliente, "deudor");

        // Guardar el ID del cliente
        modal.dataset.clienteId = clienteId;
      }

      function cerrarModalWhatsApp() {
        const modal = document.getElementById("modalWhatsApp");
        modal.style.display = "none";
      }

      function generarMensajeWhatsApp(cliente, plantilla) {
        const saldo = cliente.saldo || 0;
        const diasRest = daysDiff(cliente.membresiaFin, NOW());
        const sucursal = DB.settings.sucursal || "Matriz";

        let mensaje = "";

        // Si es una plantilla personalizada del sistema, usarla
        if (plantilla.startsWith("plantilla_")) {
          const plantillaId = plantilla.replace("plantilla_", "");
          const plantillaPersonalizada = DB.plantillasWhatsApp.find(
            (p) => p.id === plantillaId
          );

          if (plantillaPersonalizada) {
            mensaje = plantillaPersonalizada.mensaje
              .replace(/{nombre}/g, cliente.nombres)
              .replace(/{monto}/g, saldo.toFixed(2))
              .replace(
                /{fecha}/g,
                cliente.membresiaFin
                  ? new Date(cliente.membresiaFin).toLocaleDateString("es-EC")
                  : "N/A"
              )
              .replace(/{dias}/g, diasRest.toString())
              .replace(/{sucursal}/g, sucursal);
          } else {
            mensaje = `Hola ${cliente.nombres}!\n\nEsperamos que est√©s muy bien.\n\nSaludos,\nPOWERGYM UltraFitEc`;
          }
        } else {
          // Plantillas predefinidas
          switch (plantilla) {
            case "deudor":
              mensaje = `Hola, ${cliente.nombres} ${cliente.apellidos}!

Esperamos que est√©s muy bien.

Te contamos que en tu cuenta qued√≥ una deuda pendiente de $${saldo.toFixed(
                2
              )}. Pod√©s pagarla por transferencia o pasar por el gym a saldar tu cuenta.

Saludos,
POWERGYM UltraFitEc`;
              break;

            case "recordatorio":
              mensaje = `Hola ${cliente.nombres}!

Te recordamos que tienes un saldo pendiente de $${saldo.toFixed(
                2
              )} en tu cuenta.

Para evitar inconvenientes, te sugerimos regularizar tu situaci√≥n lo antes posible.

Gracias por tu comprensi√≥n.`;
              break;

            case "bienvenida":
              mensaje = `¬°Hola ${cliente.nombres}!

¬°Bienvenido/a a POWERGYM UltraFitEc!

Estamos muy contentos de que te hayas unido a nuestra familia fitness. Esperamos que disfrutes de todas nuestras instalaciones y servicios.

¬°Nos vemos en el gym! üí™`;
              break;

            case "membresia":
              const estado =
                diasRest < 0
                  ? "vencida"
                  : diasRest <= 5
                  ? "por vencer"
                  : "vigente";
              mensaje = `Hola ${cliente.nombres}!

Tu membres√≠a est√° ${estado}. ${
                diasRest < 0
                  ? `Vencida hace ${Math.abs(diasRest)} d√≠as.`
                  : diasRest <= 5
                  ? `Vence en ${diasRest} d√≠as.`
                  : `Tienes ${diasRest} d√≠as restantes.`
              }

Te invitamos a renovar para continuar disfrutando de todos nuestros servicios.

¬°Gracias por elegirnos!`;
              break;

            case "personalizado":
              mensaje = `Hola ${cliente.nombres}!

Esperamos que est√©s muy bien.

Saludos,
POWERGYM UltraFitEc`;
              break;
          }
        }

        EL("#whatsappMensaje").value = mensaje;
      }

      function abrirWhatsApp() {
        const telefono = EL("#whatsappTelefono").value.trim();
        const mensaje = EL("#whatsappMensaje").value.trim();

        if (!telefono) {
          alert("Por favor ingresa un n√∫mero de tel√©fono");
          return;
        }

        if (!mensaje) {
          alert("Por favor ingresa un mensaje");
          return;
        }

        // Limpiar el tel√©fono
        let telefonoLimpio = telefono.replace(/\D/g, "");

        // Construir la URL de WhatsApp
        const mensajeCodificado = encodeURIComponent(mensaje);
        const urlWhatsApp = `https://wa.me/${telefonoLimpio}?text=${mensajeCodificado}`;

        // Abrir WhatsApp en nueva pesta√±a
        window.open(urlWhatsApp, "_blank");

        // Cerrar el modal
        cerrarModalWhatsApp();
      }

      /******************** FUNCIONES DE B√öSQUEDA ********************/
      function filtrarPorCedula() {
        const cedulaBuscar = EL("#buscarCedula").value.trim();
        const tablaClientes = EL("#tablaClientes");

        if (!cedulaBuscar) {
          alert("Por favor ingrese una c√©dula para buscar");
          return;
        }

        // Filtrar clientes por c√©dula
        const clientesFiltrados = DB.users.filter(
          (u) => u.cedula && u.cedula.includes(cedulaBuscar)
        );

        if (clientesFiltrados.length === 0) {
          tablaClientes.innerHTML =
            '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: var(--sub);">No se encontraron clientes con esa c√©dula</td></tr>';
          return;
        }

        // Generar filas de la tabla con los clientes filtrados
        const rows = clientesFiltrados
          .map((u) => {
            const mem = DB.memberships.find((m) => m.id === u.membresia);
            const last = u.ultimoIngreso
              ? fmtDate(u.ultimoIngreso) + " " + fmtTime(u.ultimoIngreso)
              : "-";
            return `<tr>
      <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
      <td>${mem?.nombre || "-"}</td>
      <td>${last}</td>
      <td style="color: ${u.saldo && u.saldo > 0 ? "#ef4444" : "inherit"};">$ ${
              u.saldo?.toFixed(2) || "0.00"
            }</td>
      <td class="row">
        <button class="btn" onclick='abrirPagos("${u.id}")'>Ver pagos</button>
        <button class="btn success" onclick='registrarPago("${
          u.id
        }")'>Registrar pago</button>
        <button class="btn" onclick='abrirModalWhatsApp("${
          u.id
        }")'>WhatsApp</button>
      </td>
    </tr>`;
          })
          .join("");

        tablaClientes.innerHTML = rows;
      }

      function limpiarBusqueda() {
        EL("#buscarCedula").value = "";

        // Regenerar la tabla con todos los clientes
        const tablaClientes = EL("#tablaClientes");
        const rows = DB.users
          .map((u) => {
            const mem = DB.memberships.find((m) => m.id === u.membresia);
            const last = u.ultimoIngreso
              ? fmtDate(u.ultimoIngreso) + " " + fmtTime(u.ultimoIngreso)
              : "-";
            return `<tr>
      <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
      <td>${mem?.nombre || "-"}</td>
      <td>${last}</td>
      <td style="color: ${u.saldo && u.saldo > 0 ? "#ef4444" : "inherit"};">$ ${
              u.saldo?.toFixed(2) || "0.00"
            }</td>
      <td class="row">
        <button class="btn" onclick='abrirPagos("${u.id}")'>Ver pagos</button>
        <button class="btn success" onclick='registrarPago("${
          u.id
        }")'>Registrar pago</button>
        <button class="btn" onclick='abrirModalWhatsApp("${
          u.id
        }")'>WhatsApp</button>
      </td>
    </tr>`;
          })
          .join("");

        tablaClientes.innerHTML = rows;
      }

      /******************** FUNCIONES DE B√öSQUEDA PARA CADUCADAS ********************/
      function filtrarCaducadas() {
        const cedulaBuscar = EL("#buscarCedulaCaducadas").value.trim();

        if (!cedulaBuscar) {
          alert("Por favor ingrese una c√©dula para buscar");
          return;
        }

        // Filtrar clientes por c√©dula en ambas categor√≠as
        const caducados = [];
        const porCaducar = [];

        DB.users.forEach((u) => {
          const d = daysDiff(u.membresiaFin, NOW());
          if (u.cedula && u.cedula.includes(cedulaBuscar)) {
            if (d < 0) caducados.push(u);
            else if (d <= 5) porCaducar.push(u);
          }
        });

        // Actualizar la vista con los resultados filtrados
        actualizarVistaCaducadas(caducados, porCaducar);
      }

      function limpiarBusquedaCaducadas() {
        EL("#buscarCedulaCaducadas").value = "";

        // Regenerar la vista original
        const caducados = [];
        const porCaducar = [];
        DB.users.forEach((u) => {
          const d = daysDiff(u.membresiaFin, NOW());
          if (d < 0) caducados.push(u);
          else if (d <= 5) porCaducar.push(u);
        });

        actualizarVistaCaducadas(caducados, porCaducar);
      }

      function actualizarVistaCaducadas(caducados, porCaducar) {
        // Buscar el contenedor de caducadas
        const contenedorCaducadas = document.querySelector(
          '[style*="background: var(--card)"][style*="border-radius: 12px"]'
        );
        if (!contenedorCaducadas) return;

        // Actualizar secci√≥n de caducadas
        const seccionCaducadas = contenedorCaducadas
          .querySelector(
            '[style*="background: var(--danger)"][style*="border-radius: 50%"]'
          )
          .closest('[style*="background: var(--card)"]');
        if (seccionCaducadas) {
          const contadorCaducadas = seccionCaducadas.querySelector("h4");
          const contenidoCaducadas = seccionCaducadas.querySelector(
            '[style*="max-height: 400px"]'
          );

          if (contadorCaducadas)
            contadorCaducadas.textContent = `Caducadas (${caducados.length})`;

          if (contenidoCaducadas) {
            contenidoCaducadas.innerHTML =
              caducados.length === 0
                ? '<div style="text-align: center; padding: 2rem; color: var(--sub);">No se encontraron membres√≠as caducadas</div>'
                : caducados
                    .map((u) => {
                      const d = daysDiff(u.membresiaFin, NOW());
                      return `
                  <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <div>
                        <div style="font-weight: 600; color: var(--text); font-size: 1rem;">${
                          u.nombres
                        } ${u.apellidos}</div>
                        <div style="font-size: 0.85rem; color: var(--sub);">C√©dula: ${
                          u.cedula
                        }</div>
                      </div>
                      <span style="background: var(--danger); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">hace ${Math.abs(
                        d
                      )} d√≠as</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.8rem;">
                      Vencida el: ${fmtDate(u.membresiaFin)}
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                      <button class="btn success" onclick='renovar("${
                        u.id
                      }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        Renovar
                      </button>
                      <button class="btn" onclick='abrirModalWhatsApp("${
                        u.id
                      }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        WhatsApp
                      </button>
                      <button class="btn" onclick='activarQR("${
                        u.id
                      }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        QR
                      </button>
                    </div>
                  </div>
                `;
                    })
                    .join("");
          }
        }

        // Actualizar secci√≥n de por caducar
        const seccionPorCaducar = contenedorCaducadas.nextElementSibling;
        if (seccionPorCaducar) {
          const contadorPorCaducar = seccionPorCaducar.querySelector("h4");
          const contenidoPorCaducar = seccionPorCaducar.querySelector(
            '[style*="max-height: 400px"]'
          );

          if (contadorPorCaducar)
            contadorPorCaducar.textContent = `Por caducar (${porCaducar.length})`;

          if (contenidoPorCaducar) {
            contenidoPorCaducar.innerHTML =
              porCaducar.length === 0
                ? '<div style="text-align: center; padding: 2rem; color: var(--sub);">No se encontraron membres√≠as por caducar</div>'
                : porCaducar
                    .map((u) => {
                      const d = daysDiff(u.membresiaFin, NOW());
                      return `
                  <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                      <div>
                        <div style="font-weight: 600; color: var(--text); font-size: 1rem;">${
                          u.nombres
                        } ${u.apellidos}</div>
                        <div style="font-size: 0.85rem; color: var(--sub);">C√©dula: ${
                          u.cedula
                        }</div>
                      </div>
                      <span style="background: #fd7e14; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${d} d√≠as</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--sub); margin-bottom: 0.8rem;">
                      Vence el: ${fmtDate(u.membresiaFin)}
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                      <button class="btn success" onclick='renovar("${
                        u.id
                      }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        Renovar
                      </button>
                      <button class="btn" onclick='abrirModalWhatsApp("${
                        u.id
                      }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        WhatsApp
                      </button>
                      <button class="btn" onclick='activarQR("${
                        u.id
                      }")' style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        QR
                      </button>
                    </div>
                  </div>
                `;
                    })
                    .join("");
          }
        }
      }

      /******************** FUNCIONES PARA NUEVOS CLIENTES ********************/
      function filtrarNuevosClientes() {
        const busqueda = EL("#buscarNuevosClientes").value.toLowerCase().trim();
        const tablaNuevosClientes = EL("#tablaNuevosClientes");

        if (!busqueda) {
          // Si no hay b√∫squeda, mostrar todos los clientes
          const arr = [...DB.users].sort(
            (a, b) => new Date(b.creadoAt) - new Date(a.creadoAt)
          );
          const rows = arr
            .map(
              (
                u
              ) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
                u.id
              }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
                u.cedula
              }</div></td>
    <td>${fmtDate(u.creadoAt)} ${fmtTime(u.creadoAt)}</td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${DB.settings.sucursal}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); visualizarCliente('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üëÅÔ∏è Ver Info
        </button>
        <button class="btn success" onclick="event.stopPropagation(); editarClientePerfil('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          ‚úèÔ∏è Editar
        </button>
      </div>
    </td>
  </tr>`
            )
            .join("");
          tablaNuevosClientes.innerHTML = rows;
          return;
        }

        // Filtrar clientes por nombre o c√©dula
        const clientesFiltrados = DB.users.filter(
          (u) =>
            (u.nombres + " " + u.apellidos).toLowerCase().includes(busqueda) ||
            (u.cedula && u.cedula.includes(busqueda))
        );

        if (clientesFiltrados.length === 0) {
          tablaNuevosClientes.innerHTML =
            '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: var(--sub);">No se encontraron clientes</td></tr>';
          return;
        }

        // Generar filas de la tabla con los clientes filtrados
        const rows = clientesFiltrados
          .map(
            (u) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
              u.id
            }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
    <td>${fmtDate(u.creadoAt)} ${fmtTime(u.creadoAt)}</td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${DB.settings.sucursal}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); visualizarCliente('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üëÅÔ∏è Ver Info
        </button>
        <button class="btn success" onclick="event.stopPropagation(); editarClientePerfil('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          ‚úèÔ∏è Editar
        </button>
      </div>
    </td>
  </tr>`
          )
          .join("");

        tablaNuevosClientes.innerHTML = rows;
      }

      function limpiarBusquedaNuevos() {
        EL("#buscarNuevosClientes").value = "";
        filtrarNuevosClientes();
      }

      function verClienteDetalle(clienteId) {
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (cliente) {
          currentClientDetail = cliente;
          active = "cliente-detalle";
          render();
        }
      }

      function visualizarCliente(clienteId) {
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) return;

        const mem = DB.memberships.find((m) => m.id === cliente.membresia);
        const diasRest = daysDiff(cliente.membresiaFin, NOW());
        const estado =
          diasRest < 0 ? "Caducada" : diasRest <= 5 ? "Por caducar" : "Vigente";

        // Crear modal de visualizaci√≥n
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.5rem; font-weight: 700;">Informaci√≥n Completa del Cliente</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              <!-- Informaci√≥n Personal -->
              <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600;">Informaci√≥n Personal</h4>
                <div style="display: grid; gap: 0.8rem;">
                  <div>
                    <strong style="color: var(--text);">Nombre completo:</strong>
                    <div style="color: var(--sub);">${cliente.nombres} ${
          cliente.apellidos
        }</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">C√©dula:</strong>
                    <div style="color: var(--sub);">${cliente.cedula}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Fecha de nacimiento:</strong>
                    <div style="color: var(--sub);">${fmtDate(
                      cliente.nacimiento
                    )}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">G√©nero:</strong>
                    <div style="color: var(--sub);">${cliente.genero}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Email:</strong>
                    <div style="color: var(--sub);">${
                      cliente.email || "No registrado"
                    }</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Tel√©fono:</strong>
                    <div style="color: var(--sub);">${
                      cliente.telefono || "No registrado"
                    }</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Direcci√≥n:</strong>
                    <div style="color: var(--sub);">${
                      cliente.direccion || "No registrada"
                    }</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Obra social:</strong>
                    <div style="color: var(--sub);">${
                      cliente.obraSocial || "No registrada"
                    }</div>
                  </div>
                </div>
              </div>

              <!-- Informaci√≥n de Membres√≠a -->
              <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600;">Informaci√≥n de Membres√≠a</h4>
                <div style="display: grid; gap: 0.8rem;">
                  <div>
                    <strong style="color: var(--text);">Tipo de membres√≠a:</strong>
                    <div style="color: var(--sub);">${
                      mem?.nombre || "No definida"
                    }</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Estado:</strong>
                    <div style="color: ${
                      estado === "Vigente"
                        ? "var(--ok)"
                        : estado === "Por caducar"
                        ? "var(--warn)"
                        : "var(--danger)"
                    }; font-weight: 600;">${estado}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Fecha de inscripci√≥n:</strong>
                    <div style="color: var(--sub);">${fmtDate(
                      cliente.inscritoPrimera
                    )}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Inicio de membres√≠a:</strong>
                    <div style="color: var(--sub);">${fmtDate(
                      cliente.membresiaInicio
                    )}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Vencimiento:</strong>
                    <div style="color: var(--sub);">${fmtDate(
                      cliente.membresiaFin
                    )}</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">D√≠as restantes:</strong>
                    <div style="color: var(--sub);">${diasRest} d√≠as</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">Saldo pendiente:</strong>
                    <div style="color: ${
                      cliente.saldo > 0 ? "var(--danger)" : "var(--ok)"
                    }; font-weight: 600;">$ ${
          cliente.saldo?.toFixed(2) || "0.00"
        }</div>
                  </div>
                  <div>
                    <strong style="color: var(--text);">√öltimo ingreso:</strong>
                    <div style="color: var(--sub);">${
                      cliente.ultimoIngreso
                        ? fmtDate(cliente.ultimoIngreso) +
                          " " +
                          fmtTime(cliente.ultimoIngreso)
                        : "Nunca"
                    }</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notas -->
            ${
              cliente.notas
                ? `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #856404; font-size: 1.1rem;">Notas</h4>
              <div style="color: #856404; font-size: 0.9rem;">${cliente.notas}</div>
            </div>
            `
                : ""
            }

            <!-- Botones de acci√≥n -->
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
              <button onclick="editarClientePerfil('${
                cliente.id
              }'); this.closest('.modal').remove();" style="
                background: var(--brand);
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              ">
                ‚úèÔ∏è Editar Perfil
              </button>
              <button onclick="abrirModalWhatsApp('${
                cliente.id
              }'); this.closest('.modal').remove();" style="
                background: #25D366;
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              ">
                üì± Enviar WhatsApp
              </button>
              <button onclick="this.closest('.modal').remove()" style="
                background: var(--panel);
                color: var(--text);
                border: 1px solid var(--muted);
                padding: 0.8rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
              ">
                Cerrar
              </button>
            </div>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function editarClientePerfil(clienteId) {
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) return;

        // Crear modal de edici√≥n
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.5rem; font-weight: 700;">Editar Perfil del Cliente</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>
            
            <form id="formEditarCliente">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Nombres</label>
                  <input type="text" id="edit_nombres" value="${
                    cliente.nombres
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  " required>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Apellidos</label>
                  <input type="text" id="edit_apellidos" value="${
                    cliente.apellidos
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  " required>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">C√©dula</label>
                  <input type="text" id="edit_cedula" value="${
                    cliente.cedula
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  " required>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Fecha de nacimiento</label>
                  <input type="date" id="edit_nacimiento" value="${
                    cliente.nacimiento
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Email</label>
                  <input type="email" id="edit_email" value="${
                    cliente.email || ""
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Tel√©fono</label>
                  <input type="text" id="edit_telefono" value="${
                    cliente.telefono || ""
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Direcci√≥n</label>
                  <input type="text" id="edit_direccion" value="${
                    cliente.direccion || ""
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">G√©nero</label>
                  <select id="edit_genero" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                    <option value="Hombre" ${
                      cliente.genero === "Hombre" ? "selected" : ""
                    }>Hombre</option>
                    <option value="Mujer" ${
                      cliente.genero === "Mujer" ? "selected" : ""
                    }>Mujer</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Obra social</label>
                  <input type="text" id="edit_obraSocial" value="${
                    cliente.obraSocial || ""
                  }" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Membres√≠a</label>
                  <select id="edit_membresia" style="
                    width: 100%;
                    padding: 0.8rem;
                    border: 1px solid var(--muted);
                    border-radius: 6px;
                    background: white;
                  ">
                    ${DB.memberships
                      .map(
                        (m) =>
                          `<option value="${m.id}" ${
                            cliente.membresia === m.id ? "selected" : ""
                          }>${m.nombre} - $${m.monto}</option>`
                      )
                      .join("")}
                  </select>
                </div>
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Notas</label>
                <textarea id="edit_notas" rows="3" style="
                  width: 100%;
                  padding: 0.8rem;
                  border: 1px solid var(--muted);
                  border-radius: 6px;
                  background: white;
                  resize: vertical;
                ">${cliente.notas || ""}</textarea>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="this.closest('.modal').remove()" style="
                  background: var(--panel);
                  color: var(--text);
                  border: 1px solid var(--muted);
                  padding: 0.8rem 1.5rem;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 600;
                ">
                  Cancelar
                </button>
                <button type="submit" style="
                  background: var(--ok);
                  color: white;
                  border: none;
                  padding: 0.8rem 1.5rem;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: 600;
                ">
                  Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar el env√≠o del formulario
        const form = modal.querySelector("#formEditarCliente");
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          // Actualizar datos del cliente
          cliente.nombres = EL("#edit_nombres").value;
          cliente.apellidos = EL("#edit_apellidos").value;
          cliente.cedula = EL("#edit_cedula").value;
          cliente.nacimiento = EL("#edit_nacimiento").value;
          cliente.email = EL("#edit_email").value;
          cliente.telefono = EL("#edit_telefono").value;
          cliente.direccion = EL("#edit_direccion").value;
          cliente.genero = EL("#edit_genero").value;
          cliente.obraSocial = EL("#edit_obraSocial").value;
          cliente.membresia = EL("#edit_membresia").value;
          cliente.notas = EL("#edit_notas").value;

          // Guardar en la base de datos
          save();

          // Cerrar modal
          modal.remove();

          // Mostrar mensaje de √©xito
          alert("Perfil actualizado exitosamente");

          // Actualizar la vista si estamos en la secci√≥n de cliente detalle
          if (
            active === "cliente-detalle" &&
            currentClientDetail &&
            currentClientDetail.id === clienteId
          ) {
            currentClientDetail = cliente;
            render();
          }

          // Actualizar la vista si estamos en la secci√≥n de nuevos clientes
          if (active === "nuevos") {
            render();
          }
        });

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      /******************** FUNCIONES PARA CLIENTES INACTIVOS ********************/
      function filtrarInactivos() {
        const busqueda = EL("#buscarInactivos").value.toLowerCase().trim();
        const tablaInactivos = EL("#tablaInactivos");

        if (!busqueda) {
          // Si no hay b√∫squeda, mostrar todos los clientes inactivos
          const cut = new Date();
          cut.setDate(cut.getDate() - 30);
          const arr = DB.users.filter(
            (u) =>
              (!u.ultimoIngreso || new Date(u.ultimoIngreso) < cut) &&
              new Date(u.membresiaFin) >= new Date()
          );
          const rows = arr
            .map(
              (
                u
              ) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
                u.id
              }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
                u.cedula
              }</div></td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${u.ultimoIngreso ? fmtDate(u.ultimoIngreso) : "-"}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üì± WhatsApp
        </button>
        <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí≥ Ver su cuenta
        </button>
      </div>
    </td>
  </tr>`
            )
            .join("");
          tablaInactivos.innerHTML =
            rows || '<tr><td colspan=4 class="muted">No hay</td></tr>';
          return;
        }

        // Filtrar clientes inactivos por nombre o c√©dula
        const cut = new Date();
        cut.setDate(cut.getDate() - 30);
        const clientesInactivos = DB.users.filter(
          (u) =>
            (!u.ultimoIngreso || new Date(u.ultimoIngreso) < cut) &&
            new Date(u.membresiaFin) >= new Date()
        );

        const clientesFiltrados = clientesInactivos.filter(
          (u) =>
            (u.nombres + " " + u.apellidos).toLowerCase().includes(busqueda) ||
            (u.cedula && u.cedula.includes(busqueda))
        );

        if (clientesFiltrados.length === 0) {
          tablaInactivos.innerHTML =
            '<tr><td colspan="4" style="text-align: center; padding: 1rem; color: var(--sub);">No se encontraron clientes inactivos</td></tr>';
          return;
        }

        // Generar filas de la tabla con los clientes filtrados
        const rows = clientesFiltrados
          .map(
            (u) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
              u.id
            }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${u.ultimoIngreso ? fmtDate(u.ultimoIngreso) : "-"}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üì± WhatsApp
        </button>
        <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí≥ Ver su cuenta
        </button>
      </div>
    </td>
  </tr>`
          )
          .join("");

        tablaInactivos.innerHTML = rows;
      }

      function limpiarBusquedaInactivos() {
        EL("#buscarInactivos").value = "";
        filtrarInactivos();
      }

      /******************** FUNCIONES PARA DEUDORES ********************/
      function filtrarDeudores() {
        const busqueda = EL("#buscarDeudores").value.toLowerCase().trim();
        const tablaDeudores = EL("#tablaDeudores");

        if (!busqueda) {
          // Si no hay b√∫squeda, mostrar todos los deudores
          const arr = DB.users.filter((u) => (u.saldo || 0) > 0);
          const rows = arr
            .map(
              (
                u
              ) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
                u.id
              }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
                u.cedula
              }</div></td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${u.ultimoIngreso ? fmtDate(u.ultimoIngreso) : "-"}</td>
    <td style="color: var(--danger); font-weight: 600;">$ ${u.saldo.toFixed(
      2
    )}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üì± WhatsApp
        </button>
        <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí≥ Ver su cuenta
        </button>
        <button class="btn success" onclick="event.stopPropagation(); registrarPago('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí∞ Registrar pago
        </button>
      </div>
    </td>
  </tr>`
            )
            .join("");
          tablaDeudores.innerHTML =
            rows || '<tr><td colspan=5 class="muted">No hay</td></tr>';
          return;
        }

        // Filtrar deudores por nombre o c√©dula
        const deudores = DB.users.filter((u) => (u.saldo || 0) > 0);
        const deudoresFiltrados = deudores.filter(
          (u) =>
            (u.nombres + " " + u.apellidos).toLowerCase().includes(busqueda) ||
            (u.cedula && u.cedula.includes(busqueda))
        );

        if (deudoresFiltrados.length === 0) {
          tablaDeudores.innerHTML =
            '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: var(--sub);">No se encontraron deudores</td></tr>';
          return;
        }

        // Generar filas de la tabla con los deudores filtrados
        const rows = deudoresFiltrados
          .map(
            (u) => `<tr style="cursor: pointer;" onclick="verClienteDetalle('${
              u.id
            }')">
    <td><b>${u.nombres} ${u.apellidos}</b><div class="muted mini">${
              u.cedula
            }</div></td>
    <td>${DB.memberships.find((m) => m.id === u.membresia)?.nombre || "-"}</td>
    <td>${u.ultimoIngreso ? fmtDate(u.ultimoIngreso) : "-"}</td>
    <td style="color: var(--danger); font-weight: 600;">$ ${u.saldo.toFixed(
      2
    )}</td>
    <td>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üì± WhatsApp
        </button>
        <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí≥ Ver su cuenta
        </button>
        <button class="btn success" onclick="event.stopPropagation(); registrarPago('${
          u.id
        }')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
          üí∞ Registrar pago
        </button>
      </div>
    </td>
  </tr>`
          )
          .join("");

        tablaDeudores.innerHTML = rows;
      }

      function limpiarBusquedaDeudores() {
        EL("#buscarDeudores").value = "";
        filtrarDeudores();
      }

      /******************** FUNCIONES PARA CUMPLEA√ëOS ********************/
      function filtrarCumpleanos() {
        const busqueda = EL("#buscarCumpleanos").value.toLowerCase().trim();

        if (!busqueda) {
          // Si no hay b√∫squeda, recargar la vista completa
          render();
          return;
        }

        // Filtrar clientes por nombre o c√©dula
        const clientesFiltrados = DB.users.filter(
          (u) =>
            (u.nombres + " " + u.apellidos).toLowerCase().includes(busqueda) ||
            (u.cedula && u.cedula.includes(busqueda))
        );

        if (clientesFiltrados.length === 0) {
          // Mostrar mensaje de no encontrados
          const card = document.querySelector(".card");
          if (card) {
            card.innerHTML = `
               <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                 <h3 class="section-title" style="margin: 0;">Cumplea√±os por Mes</h3>
                 <div style="display: flex; align-items: center; gap: 0.5rem;">
                   <input
                     type="text"
                     id="buscarCumpleanos"
                     placeholder="Buscar por nombre o c√©dula..."
                     style="
                       padding: 0.5rem 0.8rem;
                       border: 1px solid var(--muted);
                       border-radius: 6px;
                       background: white;
                       width: 250px;
                     "
                     oninput="filtrarCumpleanos()"
                   />
                   <button
                     onclick="limpiarBusquedaCumpleanos()"
                     style="
                       background: var(--panel);
                       color: var(--text);
                       border: 1px solid var(--muted);
                       padding: 0.5rem 1rem;
                       border-radius: 6px;
                       cursor: pointer;
                     "
                   >
                     Limpiar
                   </button>
                 </div>
               </div>
               <div style="
                 text-align: center;
                 padding: 3rem;
                 color: var(--sub);
                 background: var(--panel);
                 border-radius: 12px;
               ">
                 <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                 <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No se encontraron cumplea√±os</div>
                 <div style="font-size: 0.9rem;">Intenta con otro nombre o c√©dula</div>
               </div>
             `;
          }
          return;
        }

        // Mostrar solo los clientes filtrados
        const meses = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        // Agrupar clientes filtrados por mes
        const clientesPorMes = {};
        meses.forEach((mes, index) => {
          clientesPorMes[index] = [];
        });

        clientesFiltrados.forEach((u) => {
          const mesNacimiento = new Date(u.nacimiento).getMonth();
          clientesPorMes[mesNacimiento].push(u);
        });

        // Ordenar por d√≠a
        Object.keys(clientesPorMes).forEach((mes) => {
          clientesPorMes[mes].sort(
            (a, b) =>
              new Date(a.nacimiento).getDate() -
              new Date(b.nacimiento).getDate()
          );
        });

        // Generar HTML filtrado
        let contenidoHTML = `
           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
             <h3 class="section-title" style="margin: 0;">Cumplea√±os por Mes</h3>
             <div style="display: flex; align-items: center; gap: 0.5rem;">
               <input
                 type="text"
                 id="buscarCumpleanos"
                 value="${busqueda}"
                 placeholder="Buscar por nombre o c√©dula..."
                 style="
                   padding: 0.5rem 0.8rem;
                   border: 1px solid var(--muted);
                   border-radius: 6px;
                   background: white;
                   width: 250px;
                 "
                 oninput="filtrarCumpleanos()"
               />
               <button
                 onclick="limpiarBusquedaCumpleanos()"
                 style="
                   background: var(--panel);
                   color: var(--text);
                   border: 1px solid var(--muted);
                   padding: 0.5rem 1rem;
                   border-radius: 6px;
                   cursor: pointer;
                 "
               >
                 Limpiar
               </button>
             </div>
           </div>
         `;

        // Crear secciones por mes solo para los filtrados
        meses.forEach((nombreMes, index) => {
          const clientesDelMes = clientesPorMes[index];

          if (clientesDelMes.length > 0) {
            contenidoHTML += `
               <div style="
                 background: var(--card);
                 border: 1px solid var(--muted);
                 border-radius: 12px;
                 padding: 1.5rem;
                 margin-bottom: 1.5rem;
               ">
                 <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                   <div style="
                     width: 12px;
                     height: 12px;
                     background: var(--sub);
                     border-radius: 50%;
                   "></div>
                   <h4 style="
                     margin: 0;
                     color: var(--text);
                     font-size: 1.2rem;
                     font-weight: 600;
                   ">${nombreMes}</h4>
                   <span style="
                     background: var(--panel);
                     color: var(--text);
                     padding: 0.2rem 0.6rem;
                     border-radius: 12px;
                     font-size: 0.75rem;
                     font-weight: 600;
                   ">${clientesDelMes.length} ${
              clientesDelMes.length === 1 ? "cumplea√±ero" : "cumplea√±eros"
            }</span>
                 </div>
                 
                 <div style="display: grid; gap: 0.8rem;">
                   ${clientesDelMes
                     .map((u) => {
                       const fechaCumple = new Date(u.nacimiento);
                       const dia = fechaCumple.getDate();
                       const mes = fechaCumple.getMonth();
                       const a√±o = fechaCumple.getFullYear();
                       const edad = new Date().getFullYear() - a√±o;
                       const proximoCumple = new Date(
                         new Date().getFullYear(),
                         mes,
                         dia
                       );
                       const hoy = new Date();

                       if (proximoCumple < hoy) {
                         proximoCumple.setFullYear(hoy.getFullYear() + 1);
                       }

                       const diasRestantes = Math.ceil(
                         (proximoCumple - hoy) / (1000 * 60 * 60 * 24)
                       );
                       const esHoy = diasRestantes === 0;
                       const esProximo =
                         diasRestantes <= 7 && diasRestantes > 0;

                       return `
                       <div style="
                         background: white;
                         border: 1px solid var(--muted);
                         border-radius: 8px;
                         padding: 1rem;
                         cursor: pointer;
                         transition: all 0.2s ease;
                         ${
                           esHoy
                             ? "border-color: var(--ok); background: rgba(102, 187, 106, 0.1);"
                             : ""
                         }
                         ${
                           esProximo
                             ? "border-color: var(--warn); background: rgba(255, 167, 38, 0.1);"
                             : ""
                         }
                       " onclick="verClienteDetalle('${u.id}')">
                         <div style="display: flex; justify-content: space-between; align-items: center;">
                           <div style="flex: 1;">
                             <div style="font-weight: 600; color: var(--text); font-size: 1rem;">
                               ${u.nombres} ${u.apellidos}
                             </div>
                             <div style="font-size: 0.85rem; color: var(--sub); margin-top: 0.2rem;">
                               C√©dula: ${u.cedula}
                             </div>
                             <div style="font-size: 0.85rem; color: var(--sub);">
                               ${dia} de ${meses[mes]} de ${a√±o} (${edad} a√±os)
                             </div>
                           </div>
                           <div style="text-align: right;">
                             ${
                               esHoy
                                 ? `
                               <span style="
                                 background: var(--ok);
                                 color: white;
                                 padding: 0.3rem 0.8rem;
                                 border-radius: 20px;
                                 font-size: 0.75rem;
                                 font-weight: 600;
                               ">¬°HOY!</span>
                             `
                                 : esProximo
                                 ? `
                               <span style="
                                 background: var(--warn);
                                 color: white;
                                 padding: 0.3rem 0.8rem;
                                 border-radius: 20px;
                                 font-size: 0.75rem;
                                 font-weight: 600;
                               ">En ${diasRestantes} d√≠as</span>
                             `
                                 : `
                               <span style="
                                 background: var(--panel);
                                 color: var(--text);
                                 padding: 0.3rem 0.8rem;
                                 border-radius: 20px;
                                 font-size: 0.75rem;
                                 font-weight: 600;
                               ">En ${diasRestantes} d√≠as</span>
                             `
                             }
                           </div>
                         </div>
                         <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                           <button class="btn" onclick="event.stopPropagation(); abrirModalWhatsApp('${
                             u.id
                           }')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                             üì± WhatsApp
                           </button>
                           <button class="btn" onclick="event.stopPropagation(); abrirCuenta('${
                             u.id
                           }')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                             üí≥ Ver cuenta
                           </button>
                           ${
                             esHoy || esProximo
                               ? `
                             <button class="btn success" onclick="event.stopPropagation(); enviarFelicitacion('${u.id}')" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                               üéâ Felicitar
                             </button>
                           `
                               : ""
                           }
                         </div>
                       </div>
                     `;
                     })
                     .join("")}
                 </div>
               </div>
             `;
          }
        });

        const card = document.querySelector(".card");
        if (card) {
          card.innerHTML = contenidoHTML;
        }
      }

      function limpiarBusquedaCumpleanos() {
        EL("#buscarCumpleanos").value = "";
        render();
      }

      function enviarFelicitacion(clienteId) {
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) return;

        const fechaCumple = new Date(cliente.nacimiento);
        const dia = fechaCumple.getDate();
        const mes = fechaCumple.getMonth();
        const a√±o = fechaCumple.getFullYear();
        const edad = new Date().getFullYear() - a√±o;
        const proximoCumple = new Date(new Date().getFullYear(), mes, dia);
        const hoy = new Date();

        if (proximoCumple < hoy) {
          proximoCumple.setFullYear(hoy.getFullYear() + 1);
        }

        const diasRestantes = Math.ceil(
          (proximoCumple - hoy) / (1000 * 60 * 60 * 24)
        );
        const esHoy = diasRestantes === 0;

        // Configurar el modal de WhatsApp con mensaje de felicitaci√≥n
        EL("#whatsappTelefono").value = cliente.telefono || "";
        EL("#whatsappPlantilla").value = "personalizado";

        let mensaje = "";
        if (esHoy) {
          mensaje = `¬°Feliz cumplea√±os ${cliente.nombres}! üéÇüéâ

Esperamos que tengas un d√≠a maravilloso lleno de alegr√≠a y buenos momentos.

Que este nuevo a√±o de vida est√© lleno de salud, √©xito y muchas bendiciones.

¬°Te deseamos lo mejor en tu d√≠a especial! üéàüéÅ

Saludos,
POWERGYM UltraFitEc`;
        } else {
          mensaje = `¬°Hola ${cliente.nombres}! üéÇ

Te recordamos que tu cumplea√±os est√° muy cerca (${diasRestantes} d√≠as).

Queremos ser los primeros en desearte un feliz cumplea√±os por adelantado.

¬°Que tengas un d√≠a maravilloso cuando llegue! üéàüéÅ

Saludos,
POWERGYM UltraFitEc`;
        }

        EL("#whatsappMensaje").value = mensaje;

        // Abrir el modal de WhatsApp
        abrirModalWhatsApp(clienteId);
      }

      /******************** FUNCIONES DE MODAL RENOVAR MEMBRES√çA ********************/
      function abrirModalRenovarMembresia(clienteId) {
        const modal = document.getElementById("modalRenovarMembresia");
        const contenido = document.getElementById("contenidoModalRenovar");

        // Obtener el cliente
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) return;

        // Obtener la membres√≠a actual
        const membresiaActual = DB.memberships.find(
          (m) => m.id === cliente.membresia
        );
        const diasRest = daysDiff(cliente.membresiaFin, NOW());

        // Generar el contenido del modal
        contenido.innerHTML = `
          <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--text);">Informaci√≥n del Cliente</h4>
            <div style="font-size: 0.9rem; color: var(--sub);">
              <div><strong>Nombre:</strong> ${cliente.nombres} ${
          cliente.apellidos
        }</div>
              <div><strong>C√©dula:</strong> ${cliente.cedula}</div>
              <div><strong>Tel√©fono:</strong> ${
                cliente.telefono || "No registrado"
              }</div>
            </div>
          </div>
          
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #856404;">Estado Actual de la Membres√≠a</h4>
            <div style="font-size: 0.9rem; color: #856404;">
              <div><strong>Tipo:</strong> ${
                membresiaActual?.nombre || "No definida"
              }</div>
              <div><strong>Frecuencia:</strong> ${
                membresiaActual?.frecuencia || "No definida"
              }</div>
              <div><strong>Precio:</strong> $${
                membresiaActual?.monto || 0
              }</div>
              <div><strong>Fecha de vencimiento:</strong> ${fmtDate(
                cliente.membresiaFin
              )}</div>
              <div><strong>Estado:</strong> <span style="color: var(--danger); font-weight: 600;">Caducada hace ${Math.abs(
                diasRest
              )} d√≠as</span></div>
            </div>
          </div>
          
          <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #155724;">Renovaci√≥n Propuesta</h4>
            <div style="font-size: 0.9rem; color: #155724;">
              <div><strong>Nueva fecha de inicio:</strong> ${fmtDate(
                new Date()
              )}</div>
              <div><strong>Nueva fecha de vencimiento:</strong> ${fmtDate(
                new Date(
                  Date.now() +
                    (membresiaActual?.nombre === "Trimestral"
                      ? 90
                      : membresiaActual?.nombre === "Anual"
                      ? 365
                      : 30) *
                      86400000
                )
              )}</div>
              <div><strong>Duraci√≥n:</strong> ${
                membresiaActual?.nombre === "Trimestral"
                  ? "90 d√≠as"
                  : membresiaActual?.nombre === "Anual"
                  ? "365 d√≠as"
                  : "30 d√≠as"
              }</div>
              <div><strong>Monto a pagar:</strong> $${
                membresiaActual?.monto || 0
              }</div>
            </div>
          </div>
        `;

        // Guardar el ID del cliente en el modal
        modal.dataset.clienteId = clienteId;

        // Mostrar el modal
        modal.style.display = "flex";
      }

      function cerrarModalRenovarMembresia() {
        const modal = document.getElementById("modalRenovarMembresia");
        modal.style.display = "none";
      }

      function confirmarRenovacion() {
        const modal = document.getElementById("modalRenovarMembresia");
        const clienteId = modal.dataset.clienteId;

        if (!clienteId) {
          alert("Error: No se encontr√≥ el cliente");
          return;
        }

        // Obtener el cliente
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) {
          alert("Error: Cliente no encontrado");
          return;
        }

        // Obtener la membres√≠a
        const mem = DB.memberships.find((m) => m.id === cliente.membresia);
        if (!mem) {
          alert("Error: Membres√≠a no encontrada");
          return;
        }

        // Calcular nueva fecha de vencimiento
        const hoy = new Date();
        const dias =
          mem.nombre === "Trimestral" ? 90 : mem.nombre === "Anual" ? 365 : 30;
        const fin = new Date(hoy.getTime() + dias * 86400000);

        // Actualizar la membres√≠a del cliente
        cliente.membresiaInicio = hoy.toISOString();
        cliente.membresiaFin = fin.toISOString();
        cliente.activo = true;

        // Guardar en la base de datos
        save();

        // Cerrar el modal
        cerrarModalRenovarMembresia();

        // Mostrar mensaje de √©xito
        alert(
          `Membres√≠a renovada exitosamente para ${cliente.nombres} ${cliente.apellidos}`
        );

        // Actualizar la vista
        render();
      }

      // Event listeners para los formularios
      document.addEventListener("DOMContentLoaded", function () {
        // Formulario de cargo
        document
          .getElementById("formCargo")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            guardarCargo();
          });

        // Formulario de pago
        document
          .getElementById("formPago")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            guardarPago();
          });

        // Cerrar modales al hacer clic fuera de ellos
        document
          .getElementById("modalCargo")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              cerrarModalCargo();
            }
          });

        document
          .getElementById("modalPago")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              cerrarModalPago();
            }
          });

        // Formulario de membres√≠a
        document
          .getElementById("formMembresia")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            guardarMembresia();
          });

        // Cerrar modal de membres√≠a al hacer clic fuera de √©l
        document
          .getElementById("modalMembresia")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              cerrarModalMembresia();
            }
          });

        // Modal de WhatsApp
        document
          .getElementById("modalWhatsApp")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              cerrarModalWhatsApp();
            }
          });

        // Cambio de plantilla de WhatsApp
        document
          .getElementById("whatsappPlantilla")
          .addEventListener("change", function (e) {
            const clienteId =
              document.getElementById("modalWhatsApp").dataset.clienteId;
            const cliente = DB.users.find((u) => u.id === clienteId);
            if (cliente) {
              generarMensajeWhatsApp(cliente, e.target.value);
            }
          });

        // Modal de Renovar Membres√≠a
        document
          .getElementById("modalRenovarMembresia")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              cerrarModalRenovarMembresia();
            }
          });

        // B√∫squeda por c√©dula - Enter key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && document.getElementById("buscarCedula")) {
            filtrarPorCedula();
          }
          if (
            e.key === "Enter" &&
            document.getElementById("buscarCedulaCaducadas")
          ) {
            filtrarCaducadas();
          }
        });
      });

      function guardarCargo() {
        const fecha = document.getElementById("cargoFecha").value;
        const detalle = document.getElementById("cargoDetalle").value;
        const monto = document.getElementById("cargoMonto").value;
        const sucursal = document.getElementById("cargoSucursal").value;
        const notas = document.getElementById("cargoNotas").value;
        const registrarPago =
          document.getElementById("cargoRegistrarPago").checked;

        if (!detalle || !monto) {
          alert("Por favor complete los campos obligatorios");
          return;
        }

        // Aqu√≠ se guardar√≠a el cargo en la base de datos
        console.log("Guardando cargo:", {
          fecha,
          detalle,
          monto,
          sucursal,
          notas,
          registrarPago,
        });

        // Si est√° marcado registrar pago, abrir modal de pago
        if (registrarPago) {
          cerrarModalCargo();
          setTimeout(() => {
            abrirModalPago();
            document.getElementById("pagoMonto").value = monto;
            document.getElementById("pagoDetalle").value =
              "Pago por cargo: " + detalle;
          }, 300);
        } else {
          cerrarModalCargo();
          alert("Cargo registrado exitosamente");
        }
      }

      function guardarPago() {
        const fecha = document.getElementById("pagoFecha").value;
        const detalle = document.getElementById("pagoDetalle").value;
        const monto = parseFloat(document.getElementById("pagoMonto").value);
        const metodo = document.getElementById("pagoMetodo").value;
        const sucursal = document.getElementById("pagoSucursal").value;
        const notas = document.getElementById("pagoNotas").value;
        const esProducto = document.getElementById("pagoEsProducto").checked;
        const clienteId =
          document.getElementById("modalPago").dataset.clienteId;

        if (!detalle || !monto || monto <= 0) {
          alert("Por favor complete los campos obligatorios y un monto v√°lido");
          return;
        }

        // Obtener el cliente
        const cliente = DB.users.find((u) => u.id === clienteId);
        if (!cliente) {
          alert("Cliente no encontrado");
          return;
        }

        // Crear el registro de pago
        const pago = {
          id: uuid(),
          clientId: clienteId,
          fecha: fecha || new Date().toISOString(),
          detalle: detalle,
          monto: monto,
          metodo: metodo,
          sucursal: sucursal,
          notas: notas,
          esProducto: esProducto,
          createdAt: new Date().toISOString(),
        };

        // Agregar el pago a la base de datos
        DB.payments.push(pago);

        // Actualizar el saldo del cliente
        if (!cliente.saldo) cliente.saldo = 0;
        cliente.saldo -= monto; // Reducir el saldo (pago reduce la deuda)

        // Guardar en localStorage
        save();

        console.log("Pago registrado:", pago);
        console.log("Saldo actualizado del cliente:", cliente.saldo);

        cerrarModalPago();
        alert("Pago registrado exitosamente");

        // Actualizar la vista si estamos en la secci√≥n de cliente detalle
        if (
          active === "cliente-detalle" &&
          currentClient &&
          currentClient.id === clienteId
        ) {
          render();
        }
      }

      function abrirModalNuevaMembresia() {
        const modal = document.createElement("div");
        modal.style.cssText = `
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(0, 0, 0, 0.5);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 2000;
         `;

        modal.innerHTML = `
           <div style="
             background: white;
             border-radius: 12px;
             padding: 2rem;
             max-width: 600px;
             width: 90%;
             max-height: 90vh;
             overflow-y: auto;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
           ">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
               <h3 style="margin: 0; color: var(--text); font-size: 1.5rem; font-weight: 700;">
                 Crear Nueva Membres√≠a
               </h3>
               <button onclick="this.closest('.modal').remove()" style="
                 background: none;
                 border: none;
                 font-size: 1.5rem;
                 cursor: pointer;
                 color: var(--sub);
                 padding: 0.5rem;
               ">‚úï</button>
             </div>
             
             <form id="formNuevaMembresia">
               <div style="display: grid; gap: 1.5rem;">
                 <div>
                   <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Nombre de la membres√≠a *</label>
                   <input type="text" id="nueva_mem_nombre" placeholder="Ej: Plan Mensual, Plan Anual, Plan Premium" style="
                     width: 100%;
                     padding: 0.8rem;
                     border: 1px solid var(--muted);
                     border-radius: 6px;
                     background: white;
                   " required>
                 </div>
                 
                 <div>
                   <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Descripci√≥n</label>
                   <textarea id="nueva_mem_detalle" placeholder="Describe los beneficios y caracter√≠sticas de esta membres√≠a..." rows="3" style="
                     width: 100%;
                     padding: 0.8rem;
                     border: 1px solid var(--muted);
                     border-radius: 6px;
                     background: white;
                     resize: vertical;
                   "></textarea>
                 </div>
                 
                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                   <div>
                     <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Duraci√≥n *</label>
                     <select id="nueva_mem_frecuencia" style="
                       width: 100%;
                       padding: 0.8rem;
                       border: 1px solid var(--muted);
                       border-radius: 6px;
                       background: white;
                     " required>
                       <option value="">Seleccionar duraci√≥n</option>
                       <option value="7 d√≠as">7 d√≠as</option>
                       <option value="15 d√≠as">15 d√≠as</option>
                       <option value="30 d√≠as">30 d√≠as</option>
                       <option value="60 d√≠as">60 d√≠as</option>
                       <option value="90 d√≠as">90 d√≠as</option>
                       <option value="6 meses">6 meses</option>
                       <option value="1 a√±o">1 a√±o</option>
                     </select>
                   </div>
                   
                   <div>
                     <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Sucursal *</label>
                     <select id="nueva_mem_sucursal" style="
                       width: 100%;
                       padding: 0.8rem;
                       border: 1px solid var(--muted);
                       border-radius: 6px;
                       background: white;
                     " required>
                       <option value="">Seleccionar sucursal</option>
                       <option value="Matriz">Matriz</option>
                       <option value="Ponciano">Ponciano</option>
                       <option value="QT">QT</option>
                     </select>
                   </div>
                 </div>
                 
                 <div>
                   <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Precio *</label>
                   <div style="display: flex; align-items: center;">
                     <span style="
                       background: var(--panel);
                       border: 1px solid var(--muted);
                       border-right: none;
                       border-radius: 6px 0 0 6px;
                       padding: 0.8rem;
                       font-weight: 600;
                       color: var(--text);
                     ">$</span>
                     <input type="number" id="nueva_mem_monto" placeholder="0.00" step="0.01" min="0" style="
                       flex: 1;
                       padding: 0.8rem;
                       border: 1px solid var(--muted);
                       border-radius: 0 6px 6px 0;
                       background: white;
                     " required>
                   </div>
                 </div>
                 
                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                   <div>
                     <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Estado</label>
                     <select id="nueva_mem_estado" style="
                       width: 100%;
                       padding: 0.8rem;
                       border: 1px solid var(--muted);
                       border-radius: 6px;
                       background: white;
                     ">
                       <option value="activa">Activa</option>
                       <option value="inactiva">Inactiva</option>
                     </select>
                   </div>
                   
                   <div>
                     <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Tipo de membres√≠a</label>
                     <select id="nueva_mem_tipo" style="
                       width: 100%;
                       padding: 0.8rem;
                       border: 1px solid var(--muted);
                       border-radius: 6px;
                       background: white;
                     ">
                       <option value="regular">Regular</option>
                       <option value="premium">Premium</option>
                       <option value="vip">VIP</option>
                       <option value="estudiante">Estudiante</option>
                       <option value="senior">Senior</option>
                     </select>
                   </div>
                 </div>
                 
                 <div>
                   <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Caracter√≠sticas especiales</label>
                   <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                     <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                       <input type="checkbox" id="nueva_mem_acceso_24h" style="margin: 0;">
                       <span style="font-size: 0.9rem;">Acceso 24/7</span>
                     </label>
                     <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                       <input type="checkbox" id="nueva_mem_clases_grupales" style="margin: 0;">
                       <span style="font-size: 0.9rem;">Clases grupales incluidas</span>
                     </label>
                     <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                       <input type="checkbox" id="nueva_mem_entrenador_personal" style="margin: 0;">
                       <span style="font-size: 0.9rem;">Entrenador personal</span>
                     </label>
                     <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                       <input type="checkbox" id="nueva_mem_estacionamiento" style="margin: 0;">
                       <span style="font-size: 0.9rem;">Estacionamiento gratuito</span>
                     </label>
                   </div>
                 </div>
               </div>
               
               <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--muted);">
                 <button type="button" onclick="this.closest('.modal').remove()" style="
                   background: var(--panel);
                   color: var(--text);
                   border: 1px solid var(--muted);
                   padding: 0.8rem 1.5rem;
                   border-radius: 6px;
                   cursor: pointer;
                   font-weight: 600;
                 ">
                   Cancelar
                 </button>
                 <button type="submit" style="
                   background: var(--ok);
                   color: white;
                   border: none;
                   padding: 0.8rem 1.5rem;
                   border-radius: 6px;
                   cursor: pointer;
                   font-weight: 600;
                   display: flex;
                   align-items: center;
                   gap: 0.5rem;
                 ">
                   <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                     <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                   </svg>
                   Crear Membres√≠a
                 </button>
               </div>
             </form>
           </div>
         `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar el env√≠o del formulario
        const form = modal.querySelector("#formNuevaMembresia");
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const nombre = EL("#nueva_mem_nombre").value.trim();
          const detalle = EL("#nueva_mem_detalle").value.trim();
          const frecuencia = EL("#nueva_mem_frecuencia").value;
          const sucursal = EL("#nueva_mem_sucursal").value;
          const monto = parseFloat(EL("#nueva_mem_monto").value);
          const estado = EL("#nueva_mem_estado").value;
          const tipo = EL("#nueva_mem_tipo").value;

          // Caracter√≠sticas especiales
          const caracteristicas = [];
          if (EL("#nueva_mem_acceso_24h").checked)
            caracteristicas.push("Acceso 24/7");
          if (EL("#nueva_mem_clases_grupales").checked)
            caracteristicas.push("Clases grupales incluidas");
          if (EL("#nueva_mem_entrenador_personal").checked)
            caracteristicas.push("Entrenador personal");
          if (EL("#nueva_mem_estacionamiento").checked)
            caracteristicas.push("Estacionamiento gratuito");

          // Validaciones
          if (
            !nombre ||
            !frecuencia ||
            !sucursal ||
            isNaN(monto) ||
            monto <= 0
          ) {
            alert(
              "Por favor complete todos los campos obligatorios y un precio v√°lido"
            );
            return;
          }

          // Crear nueva membres√≠a
          const nuevaMembresia = {
            id: uuid(),
            nombre: nombre,
            detalle: detalle,
            frecuencia: frecuencia,
            sucursal: sucursal,
            monto: monto,
            estado: estado,
            tipo: tipo,
            caracteristicas: caracteristicas,
            creadoAt: new Date().toISOString(),
          };

          DB.memberships.push(nuevaMembresia);
          save();
          modal.remove();

          // Mostrar mensaje de √©xito
          alert(`Membres√≠a "${nombre}" creada exitosamente`);

          // Actualizar vista
          render();
        });

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // Funciones legacy para compatibilidad
      function abrirModalMembresia() {
        abrirModalNuevaMembresia();
      }

      function cerrarModalMembresia() {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => modal.remove());
      }

      function guardarMembresia() {
        // Esta funci√≥n ahora usa el nuevo modal
        abrirModalNuevaMembresia();
      }

      /******************** SIDEBAR CONTROL ********************/
      function toggleSidebar() {
        const sidebar = EL(".sidebar");
        const overlay = EL(".sidebar-overlay");

        if (sidebar.classList.contains("closed")) {
          // Abrir el sidebar
          sidebar.classList.remove("closed");
          sidebar.classList.add("open");
          overlay.classList.add("open");
        } else {
          // Cerrar el sidebar
          sidebar.classList.remove("open");
          sidebar.classList.add("closed");
          overlay.classList.remove("open");
        }
      }

      function closeSidebar() {
        const sidebar = EL(".sidebar");
        const overlay = EL(".sidebar-overlay");
        sidebar.classList.remove("open");
        sidebar.classList.add("closed");
        overlay.classList.remove("open");
      }

      // Funciones para el selector de sucursal
      function toggleSucursalDropdown() {
        const dropdown = EL("#sucursalDropdown");
        if (
          dropdown.style.display === "none" ||
          dropdown.style.display === ""
        ) {
          dropdown.style.display = "block";
        } else {
          dropdown.style.display = "none";
        }
      }

      function cambiarSucursal(nuevaSucursal) {
        // Actualizar la sucursal en la configuraci√≥n
        DB.settings.sucursal = nuevaSucursal;
        save();

        // Actualizar el texto del bot√≥n
        EL("#sucursalActual").textContent = nuevaSucursal;

        // Cerrar el dropdown
        EL("#sucursalDropdown").style.display = "none";

        // Mostrar mensaje de confirmaci√≥n
        alert(`Sucursal cambiada a: ${nuevaSucursal}`);

        // Recargar la vista para aplicar los cambios
        render();
      }

      // Cerrar dropdown al hacer clic fuera
      document.addEventListener("click", function (e) {
        const dropdown = EL("#sucursalDropdown");
        const selector = EL(".sucursal-selector");

        if (dropdown && !selector.contains(e.target)) {
          dropdown.style.display = "none";
        }
      });

      // Actualizar la sucursal actual al cargar la p√°gina
      function actualizarSucursalActual() {
        const sucursalActual = EL("#sucursalActual");
        if (sucursalActual && DB.settings.sucursal) {
          sucursalActual.textContent = DB.settings.sucursal;
        }
      }

      // Llamar a la funci√≥n cuando se carga la p√°gina
      document.addEventListener("DOMContentLoaded", actualizarSucursalActual);

      /******************** ASIGNACI√ìN DE ENTRENAMIENTO ********************/

      // Base de datos de ejercicios por g√©nero y tipo
      const EJERCICIOS_DB = {
        Hombre: {
          Pecho: [
            "Press de banca con barra",
            "Press de banca con mancuernas",
            "Press inclinado con barra",
            "Press inclinado con mancuernas",
            "Press declinado",
            "Aperturas con mancuernas",
            "Aperturas en polea",
            "Flexiones de pecho",
            "Press de pecho en m√°quina",
            "Pullover con mancuerna",
          ],
          Dorsales: [
            "Dominadas",
            "Remo con barra",
            "Remo con mancuernas",
            "Remo en polea baja",
            "Pull-down en polea alta",
            "Remo invertido",
            "Pull-over con barra",
            "Remo en m√°quina",
            "Superman",
            "Remo con banda el√°stica",
          ],
          Hombros: [
            "Press militar con barra",
            "Press militar con mancuernas",
            "Elevaciones laterales",
            "Elevaciones frontales",
            "Elevaciones posteriores",
            "Remo vertical",
            "Press Arnold",
            "Elevaciones en Y",
            "Rotaciones externas",
            "Shrugs con barra",
          ],
          B√≠ceps: [
            "Curl con barra",
            "Curl con mancuernas",
            "Curl martillo",
            "Curl concentrado",
            "Curl en polea",
            "Curl 21",
            "Curl predicador",
            "Curl spider",
            "Curl con banda el√°stica",
            "Curl Zottman",
          ],
          Tr√≠ceps: [
            "Press de banca cerrado",
            "Extensiones con barra",
            "Extensiones con mancuernas",
            "Fondos en paralelas",
            "Extensiones en polea",
            "Patada de burro",
            "Extensiones tras nuca",
            "Press franc√©s",
            "Extensiones con banda el√°stica",
            "Dips en banco",
          ],
          Piernas: [
            "Sentadillas con barra",
            "Sentadillas con mancuernas",
            "Peso muerto",
            "Extensiones de cu√°driceps",
            "Curl de femoral",
            "Prensa de piernas",
            "Zancadas con mancuernas",
            "Elevaciones de gemelos",
            "Sentadillas b√∫lgaras",
            "Hip thrust",
          ],
          Abdominales: [
            "Crunches",
            "Plancha",
            "Elevaciones de piernas",
            "Russian twists",
            "Bicycle crunches",
            "Mountain climbers",
            "Leg raises",
            "Ab wheel rollout",
            "Plank con rotaci√≥n",
            "Dead bug",
          ],
        },
        Mujer: {
          Pecho: [
            "Press de banca con mancuernas",
            "Aperturas con mancuernas",
            "Press inclinado con mancuernas",
            "Flexiones de pecho modificadas",
            "Press de pecho en m√°quina",
            "Aperturas en polea",
            "Push-ups con rodillas",
            "Press declinado con mancuernas",
            "Pullover con mancuerna",
            "Chest fly en m√°quina",
          ],
          Dorsales: [
            "Remo con mancuernas",
            "Remo en polea baja",
            "Pull-down en polea alta",
            "Remo invertido",
            "Superman",
            "Remo con banda el√°stica",
            "Pull-over con mancuerna",
            "Remo en m√°quina",
            "Lat pulldown",
            "Remo sentado",
          ],
          Hombros: [
            "Press militar con mancuernas",
            "Elevaciones laterales",
            "Elevaciones frontales",
            "Elevaciones posteriores",
            "Press Arnold",
            "Elevaciones en Y",
            "Rotaciones externas",
            "Shrugs con mancuernas",
            "Elevaciones con banda el√°stica",
            "Press con mancuernas sentado",
          ],
          B√≠ceps: [
            "Curl con mancuernas",
            "Curl martillo",
            "Curl concentrado",
            "Curl en polea",
            "Curl con banda el√°stica",
            "Curl predicador",
            "Curl spider",
            "Curl 21",
            "Curl Zottman",
            "Curl alternado",
          ],
          Tr√≠ceps: [
            "Extensiones con mancuernas",
            "Extensiones en polea",
            "Patada de burro",
            "Extensiones tras nuca",
            "Extensiones con banda el√°stica",
            "Dips en banco",
            "Press de banca cerrado",
            "Extensiones con barra",
            "Fondos modificados",
            "Kickbacks",
          ],
          Piernas: [
            "Sentadillas con mancuernas",
            "Zancadas con mancuernas",
            "Prensa de piernas",
            "Extensiones de cu√°driceps",
            "Curl de femoral",
            "Elevaciones de gemelos",
            "Sentadillas b√∫lgaras",
            "Hip thrust",
            "Step-ups",
            "Glute bridges",
          ],
          Abdominales: [
            "Crunches",
            "Plancha",
            "Elevaciones de piernas",
            "Russian twists",
            "Bicycle crunches",
            "Mountain climbers",
            "Leg raises",
            "Plank con rotaci√≥n",
            "Dead bug",
            "Bird dog",
          ],
        },
      };

      // Variables globales para el entrenamiento
      let clienteSeleccionado = null;
      let entrenamientoActual = {
        clienteId: null,
        cedula: "",
        genero: "",
        secciones: [],
      };

      function renderAsignacionEntrenamiento(root) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3 class="section-title">Asignaci√≥n de Entrenamiento</h3>
          
          <!-- Paso 1: B√∫squeda por c√©dula -->
          <div style="background: var(--card); border: 1px solid var(--muted); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">Paso 1: Buscar Cliente</h4>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="text" 
                id="cedulaBusqueda" 
                placeholder="Ingrese c√©dula del cliente (10 d√≠gitos)" 
                maxlength="10"
                style="flex: 1; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                oninput="validarCedulaBusqueda(this.value)"
              />
              <button class="btn primary" onclick="buscarClienteEntrenamiento()" style="padding: 0.8rem 1.5rem;">
                Buscar Cliente
              </button>
              <button class="btn" onclick="limpiarBusquedaEntrenamiento()" style="padding: 0.8rem 1.5rem;">
                Limpiar
              </button>
            </div>
            <div id="resultadoBusqueda" style="margin-top: 1rem;"></div>
          </div>

          <!-- Paso 2: Selecci√≥n de g√©nero (solo si se encontr√≥ cliente) -->
          <div id="pasoGenero" style="display: none; background: var(--card); border: 1px solid var(--muted); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">Paso 2: Seleccionar G√©nero</h4>
            <div style="display: flex; gap: 1rem;">
              <button class="btn" onclick="seleccionarGenero('Hombre')" id="btnHombre" style="padding: 1rem 2rem; font-size: 1rem;">
                Hombre
              </button>
              <button class="btn" onclick="seleccionarGenero('Mujer')" id="btnMujer" style="padding: 1rem 2rem; font-size: 1rem;">
                Mujer
              </button>
            </div>
          </div>

          <!-- Paso 3: Configuraci√≥n de entrenamiento -->
          <div id="pasoEntrenamiento" style="display: none;">
            <div style="background: var(--card); border: 1px solid var(--muted); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">Paso 3: Configurar Entrenamiento</h4>
              
              <!-- Informaci√≥n del cliente -->
              <div style="background: rgba(218, 131, 224, 0.1); border: 1px solid var(--brand); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Cliente Seleccionado:</div>
                <div id="infoClienteEntrenamiento" style="color: var(--sub);"></div>
              </div>

              <!-- Secciones de entrenamiento -->
              <div id="seccionesEntrenamiento">
                <!-- Las secciones se generar√°n din√°micamente -->
              </div>

              <!-- Botones para agregar/quitar secciones -->
              <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn success" onclick="agregarSeccion()" style="padding: 0.8rem 1.5rem;">
                  ‚ûï Agregar Secci√≥n
                </button>
                <button class="btn danger" onclick="quitarSeccion()" style="padding: 0.8rem 1.5rem;">
                  ‚ûñ Quitar Secci√≥n
                </button>
              </div>
            </div>

            <!-- Paso 4: Resumen y asignaci√≥n -->
            <div id="pasoResumen" style="background: var(--card); border: 1px solid var(--muted); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">Paso 4: Resumen del Entrenamiento</h4>
              <div id="resumenEntrenamiento" style="background: rgba(102, 187, 106, 0.1); border: 1px solid var(--ok); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <!-- El resumen se generar√° din√°micamente -->
              </div>
              <div style="display: flex; gap: 1rem;">
                <button class="btn primary" onclick="asignarEntrenamiento()" style="padding: 1rem 2rem; font-size: 1.1rem;">
                  ‚úÖ Asignar Entrenamiento
                </button>
                <button class="btn" onclick="limpiarEntrenamiento()" style="padding: 1rem 2rem; font-size: 1.1rem;">
                  üîÑ Nuevo Entrenamiento
                </button>
              </div>
            </div>
          </div>
        `;
        root.append(card);
      }

      function validarCedulaBusqueda(cedula) {
        // Solo permitir n√∫meros y m√°ximo 10 d√≠gitos
        const cedulaLimpia = cedula.replace(/\D/g, "");
        EL("#cedulaBusqueda").value = cedulaLimpia.slice(0, 10);
      }

      function buscarClienteEntrenamiento() {
        const cedula = EL("#cedulaBusqueda").value.trim();
        if (!cedula || cedula.length !== 10) {
          alert("Por favor ingrese una c√©dula v√°lida de 10 d√≠gitos");
          return;
        }

        const cliente = DB.users.find((u) => u.cedula === cedula);
        if (!cliente) {
          EL("#resultadoBusqueda").innerHTML = `
            <div style="color: var(--danger); padding: 0.8rem; background: rgba(239, 83, 80, 0.1); border-radius: 6px; border: 1px solid var(--danger);">
              ‚ùå Cliente no encontrado con la c√©dula ${cedula}
            </div>
          `;
          return;
        }

        clienteSeleccionado = cliente;
        entrenamientoActual.clienteId = cliente.id;
        entrenamientoActual.cedula = cliente.cedula;
        entrenamientoActual.genero = cliente.genero;

        EL("#resultadoBusqueda").innerHTML = `
          <div style="color: var(--ok); padding: 0.8rem; background: rgba(102, 187, 106, 0.1); border-radius: 6px; border: 1px solid var(--ok);">
            ‚úÖ Cliente encontrado: ${cliente.nombres} ${cliente.apellidos} (${cliente.genero})
          </div>
        `;

        // Mostrar paso 2
        EL("#pasoGenero").style.display = "block";

        // Pre-seleccionar g√©nero si est√° disponible
        if (cliente.genero) {
          setTimeout(() => seleccionarGenero(cliente.genero), 100);
        }
      }

      function limpiarBusquedaEntrenamiento() {
        EL("#cedulaBusqueda").value = "";
        EL("#resultadoBusqueda").innerHTML = "";
        EL("#pasoGenero").style.display = "none";
        EL("#pasoEntrenamiento").style.display = "none";
        clienteSeleccionado = null;
        entrenamientoActual = {
          clienteId: null,
          cedula: "",
          genero: "",
          secciones: [],
        };
      }

      function seleccionarGenero(genero) {
        entrenamientoActual.genero = genero;

        // Actualizar botones
        EL("#btnHombre").classList.remove("primary");
        EL("#btnMujer").classList.remove("primary");
        EL("#btn" + (genero === "Hombre" ? "Hombre" : "Mujer")).classList.add(
          "primary"
        );

        // Mostrar paso 3
        EL("#pasoEntrenamiento").style.display = "block";

        // Actualizar informaci√≥n del cliente
        EL("#infoClienteEntrenamiento").innerHTML = `
          <strong>${clienteSeleccionado.nombres} ${clienteSeleccionado.apellidos}</strong><br>
          C√©dula: ${clienteSeleccionado.cedula}<br>
          G√©nero: ${genero}
        `;

        // Inicializar con una secci√≥n
        entrenamientoActual.secciones = [];
        agregarSeccion();
      }

      function agregarSeccion() {
        const seccionId = entrenamientoActual.secciones.length + 1;
        const letraSeccion = String.fromCharCode(64 + seccionId); // A, B, C, etc.

        entrenamientoActual.secciones.push({
          id: seccionId,
          letra: letraSeccion,
          tiposEjercicios: [], // Array para m√∫ltiples tipos
          ejercicios: [],
        });

        renderizarSecciones();
        actualizarResumen();
      }

      function quitarSeccion() {
        if (entrenamientoActual.secciones.length > 1) {
          entrenamientoActual.secciones.pop();
          renderizarSecciones();
          actualizarResumen();
        } else {
          alert("Debe mantener al menos una secci√≥n");
        }
      }

      function renderizarSecciones() {
        const container = EL("#seccionesEntrenamiento");
        container.innerHTML = "";

        entrenamientoActual.secciones.forEach((seccion, index) => {
          const seccionDiv = document.createElement("div");
          seccionDiv.style.cssText =
            "background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;";

          seccionDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h5 style="margin: 0; color: var(--text); font-size: 1rem; font-weight: 600;">Secci√≥n ${seccion.letra}</h5>
              <span style="background: var(--brand); color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${seccion.id}</span>
            </div>

            <!-- Selecci√≥n de tipo de ejercicio -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Agregar Tipo de Ejercicio:</label>
              <select 
                id="tipoEjercicio_${seccion.id}" 
                onchange="cambiarTipoEjercicio(${seccion.id}, this.value)"
                style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
              >
                <option value="">Seleccionar tipo de ejercicio...</option>
                <option value="Pecho">Pecho</option>
                <option value="Dorsales">Dorsales</option>
                <option value="Hombros">Hombros</option>
                <option value="B√≠ceps">B√≠ceps</option>
                <option value="Tr√≠ceps">Tr√≠ceps</option>
                <option value="Piernas">Piernas</option>
                <option value="Abdominales">Abdominales</option>
              </select>
            </div>

            <!-- Tipos de ejercicios agregados -->
            <div id="tiposAgregados_${seccion.id}" style="margin-bottom: 1rem;">
              <!-- Los tipos agregados se mostrar√°n aqu√≠ -->
            </div>

            <!-- Lista de ejercicios (solo si se seleccion√≥ tipo) -->
            <div id="ejercicios_${seccion.id}" style="display: none;">
              <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Ejercicios (selecci√≥n m√∫ltiple):</label>
              <div id="listaEjercicios_${seccion.id}" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--muted); border-radius: 6px; padding: 0.5rem; background: #f8f9fa;">
                <!-- Los ejercicios se cargar√°n din√°micamente -->
              </div>
            </div>

            <!-- Ejercicios seleccionados -->
            <div id="ejerciciosSeleccionados_${seccion.id}" style="margin-top: 1rem;">
              <!-- Los ejercicios seleccionados se mostrar√°n aqu√≠ -->
            </div>
          `;

          container.appendChild(seccionDiv);

          // Mostrar tipos agregados si existen
          if (seccion.tiposEjercicios && seccion.tiposEjercicios.length > 0) {
            mostrarTiposAgregados(seccion.id);
            cargarEjercicios(
              seccion.id,
              seccion.tiposEjercicios[0],
              seccion.ejercicios
            );
          }
        });
      }

      function cambiarTipoEjercicio(seccionId, tipo) {
        const seccion = entrenamientoActual.secciones.find(
          (s) => s.id === seccionId
        );
        if (seccion) {
          // Guardar los ejercicios actuales antes de cambiar
          const ejerciciosActuales = [...seccion.ejercicios];

          // Si ya existe este tipo en la secci√≥n, no hacer nada
          if (
            seccion.tiposEjercicios &&
            seccion.tiposEjercicios.includes(tipo)
          ) {
            alert("Este tipo de ejercicio ya est√° agregado a esta secci√≥n");
            return;
          }

          // Inicializar tiposEjercicios si no existe
          if (!seccion.tiposEjercicios) {
            seccion.tiposEjercicios = [];
          }

          // Agregar el nuevo tipo
          seccion.tiposEjercicios.push(tipo);

          // Cargar ejercicios del nuevo tipo
          cargarEjercicios(seccionId, tipo, ejerciciosActuales);

          // Mostrar tipos agregados
          mostrarTiposAgregados(seccionId);
        }
        actualizarResumen();
      }

      function mostrarTiposAgregados(seccionId) {
        const seccion = entrenamientoActual.secciones.find(
          (s) => s.id === seccionId
        );
        const container = EL(`#tiposAgregados_${seccionId}`);

        if (
          seccion &&
          seccion.tiposEjercicios &&
          seccion.tiposEjercicios.length > 0
        ) {
          container.innerHTML = `
          <div style="background: rgba(218, 131, 224, 0.1); border: 1px solid var(--brand); border-radius: 6px; padding: 0.8rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Tipos agregados:</div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              ${seccion.tiposEjercicios
                .map(
                  (tipo) => `
                <span style="background: var(--brand); color: white; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.3rem;">
                  ${tipo}
                  <button onclick="quitarTipoEjercicio(${seccionId}, '${tipo}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 0.7rem; padding: 0;">‚úï</button>
                </span>
              `
                )
                .join("")}
            </div>
          </div>
        `;
        } else {
          container.innerHTML = "";
        }
      }

      function quitarTipoEjercicio(seccionId, tipo) {
        const seccion = entrenamientoActual.secciones.find(
          (s) => s.id === seccionId
        );
        if (seccion) {
          // Remover el tipo
          seccion.tiposEjercicios = seccion.tiposEjercicios.filter(
            (t) => t !== tipo
          );

          // Remover ejercicios de ese tipo
          const ejerciciosDelTipo =
            EJERCICIOS_DB[entrenamientoActual.genero][tipo] || [];
          seccion.ejercicios = seccion.ejercicios.filter(
            (ej) => !ejerciciosDelTipo.includes(ej)
          );

          // Actualizar vista
          mostrarTiposAgregados(seccionId);
          if (seccion.tiposEjercicios.length > 0) {
            cargarEjercicios(
              seccionId,
              seccion.tiposEjercicios[0],
              seccion.ejercicios
            );
          } else {
            EL(`#ejercicios_${seccionId}`).style.display = "none";
            EL(`#ejerciciosSeleccionados_${seccionId}`).innerHTML = "";
          }
          actualizarResumen();
        }
      }

      function cargarEjercicios(seccionId, tipo, ejerciciosExistentes = []) {
        const ejercicios =
          EJERCICIOS_DB[entrenamientoActual.genero][tipo] || [];
        const seccion = entrenamientoActual.secciones.find(
          (s) => s.id === seccionId
        );

        if (!seccion) return;

        // Mantener ejercicios existentes y agregar los nuevos
        if (ejerciciosExistentes.length > 0) {
          seccion.ejercicios = [...ejerciciosExistentes];
        }

        // Crear un contenedor para todos los tipos de ejercicios
        const container = EL(`#listaEjercicios_${seccionId}`);

        // Obtener todos los tipos de ejercicios de esta secci√≥n
        const todosLosTipos = seccion.tiposEjercicios || [tipo];

        let htmlCompleto = "";

        todosLosTipos.forEach((tipoEjercicio) => {
          const ejerciciosDelTipo =
            EJERCICIOS_DB[entrenamientoActual.genero][tipoEjercicio] || [];

          htmlCompleto += `
            <div style="margin-bottom: 1rem; padding: 0.8rem; background: rgba(218, 131, 224, 0.05); border-radius: 6px; border-left: 3px solid var(--brand);">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem;">${tipoEjercicio}</div>
              ${ejerciciosDelTipo
                .map((ejercicio, index) => {
                  const isChecked = seccion.ejercicios.includes(ejercicio);
                  return `
                  <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 4px; cursor: pointer; transition: background 0.2s; margin-bottom: 0.2rem;" onmouseover="this.style.background='rgba(218, 224, 131, 0.1)'" onmouseout="this.style.background='transparent'">
                    <input 
                      type="checkbox" 
                      id="ej_${seccionId}_${tipoEjercicio}_${index}"
                      value="${ejercicio}"
                      ${isChecked ? "checked" : ""}
                      onchange="toggleEjercicio(${seccionId}, '${ejercicio}', this.checked)"
                      style="margin: 0;"
                    />
                    <span style="font-size: 0.9rem;">${ejercicio}</span>
                  </label>
                `;
                })
                .join("")}
            </div>
          `;
        });

        container.innerHTML = htmlCompleto;
        EL(`#ejercicios_${seccionId}`).style.display = "block";
        actualizarEjerciciosSeleccionados(seccionId);
      }

      function toggleEjercicio(seccionId, ejercicio, seleccionado) {
        const seccion = entrenamientoActual.secciones.find(
          (s) => s.id === seccionId
        );
        if (seccion) {
          if (seleccionado) {
            if (!seccion.ejercicios.includes(ejercicio)) {
              seccion.ejercicios.push(ejercicio);
            }
          } else {
            seccion.ejercicios = seccion.ejercicios.filter(
              (e) => e !== ejercicio
            );
          }
        }
        actualizarEjerciciosSeleccionados(seccionId);
        actualizarResumen();
      }

      function actualizarEjerciciosSeleccionados(seccionId) {
        const seccion = entrenamientoActual.secciones.find(
          (s) => s.id === seccionId
        );
        const container = EL(`#ejerciciosSeleccionados_${seccionId}`);

        if (seccion && seccion.ejercicios.length > 0) {
          container.innerHTML = `
            <div style="background: rgba(102, 187, 106, 0.1); border: 1px solid var(--ok); border-radius: 6px; padding: 0.8rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Ejercicios seleccionados (${
                seccion.ejercicios.length
              }):</div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                ${seccion.ejercicios
                  .map(
                    (ejercicio) => `
                  <span style="background: var(--ok); color: white; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${ejercicio}</span>
                `
                  )
                  .join("")}
              </div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div style="background: rgba(255, 167, 38, 0.1); border: 1px solid var(--warn); border-radius: 6px; padding: 0.8rem; color: var(--warn); font-size: 0.9rem;">
              ‚ö†Ô∏è No hay ejercicios seleccionados para esta secci√≥n
            </div>
          `;
        }
      }

      function actualizarResumen() {
        const container = EL("#resumenEntrenamiento");
        const totalEjercicios = entrenamientoActual.secciones.reduce(
          (total, seccion) => total + seccion.ejercicios.length,
          0
        );

        container.innerHTML = `
          <div style="margin-bottom: 1rem;">
            <strong>Cliente:</strong> ${clienteSeleccionado.nombres} ${
          clienteSeleccionado.apellidos
        }<br>
            <strong>C√©dula:</strong> ${entrenamientoActual.cedula}<br>
            <strong>G√©nero:</strong> ${entrenamientoActual.genero}<br>
            <strong>Secciones:</strong> ${
              entrenamientoActual.secciones.length
            }<br>
            <strong>Total ejercicios:</strong> ${totalEjercicios}
          </div>
          
          <div style="max-height: 300px; overflow-y: auto;">
                         ${entrenamientoActual.secciones
                           .map(
                             (seccion) => `
                <div style="background: white; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem; margin-bottom: 0.8rem;">
                  <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Secci√≥n ${
                    seccion.letra
                  } - ${
                               seccion.tiposEjercicios &&
                               seccion.tiposEjercicios.length > 0
                                 ? seccion.tiposEjercicios.join(", ")
                                 : "Sin tipos seleccionados"
                             }</div>
                  ${
                    seccion.ejercicios.length > 0
                      ? `
                    <div style="font-size: 0.9rem; color: var(--sub);">
                      ${seccion.ejercicios
                        .map((ejercicio) => `‚Ä¢ ${ejercicio}`)
                        .join("<br>")}
                    </div>
                  `
                      : '<div style="color: var(--warn); font-size: 0.9rem;">No hay ejercicios seleccionados</div>'
                  }
                </div>
              `
                           )
                           .join("")}
          </div>
        `;
      }

      function asignarEntrenamiento() {
        // Validar que haya al menos una secci√≥n con ejercicios
        const seccionesValidas = entrenamientoActual.secciones.filter(
          (s) =>
            s.tiposEjercicios &&
            s.tiposEjercicios.length > 0 &&
            s.ejercicios.length > 0
        );

        if (seccionesValidas.length === 0) {
          alert(
            "Debe configurar al menos una secci√≥n con ejercicios antes de asignar el entrenamiento"
          );
          return;
        }

        // Guardar el entrenamiento en la base de datos
        const entrenamiento = {
          id: uuid(),
          clienteId: entrenamientoActual.clienteId,
          cedula: entrenamientoActual.cedula,
          genero: entrenamientoActual.genero,
          secciones: entrenamientoActual.secciones,
          fechaAsignacion: new Date().toISOString(),
          sucursal: DB.settings.sucursal,
        };

        // Agregar a la base de datos (si no existe, crearla)
        if (!DB.entrenamientos) {
          DB.entrenamientos = [];
        }
        DB.entrenamientos.push(entrenamiento);
        save();

        // Mostrar confirmaci√≥n
        alert(
          `‚úÖ Entrenamiento asignado exitosamente a ${
            clienteSeleccionado.nombres
          } ${clienteSeleccionado.apellidos}\n\nSecciones: ${
            seccionesValidas.length
          }\nTotal ejercicios: ${seccionesValidas.reduce(
            (total, s) => total + s.ejercicios.length,
            0
          )}`
        );

        // Limpiar formulario
        limpiarEntrenamiento();
      }

      function limpiarEntrenamiento() {
        limpiarBusquedaEntrenamiento();
        EL("#pasoGenero").style.display = "none";
        EL("#pasoEntrenamiento").style.display = "none";
      }

      /******************** GESTI√ìN DE PLANTILLAS WHATSAPP ********************/

      function seedPlantillasWhatsApp() {
        return [
          {
            id: "p1",
            titulo: "Recordatorio de Pago",
            mensaje:
              "Hola {nombre}, te recordamos que tienes un pago pendiente de ${monto}. Tu membres√≠a vence el {fecha}. Por favor, ac√©rcate a nuestra sucursal para regularizar tu situaci√≥n. ¬°Gracias!",
            categoria: "Pagos",
            activa: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "p2",
            titulo: "Bienvenida Nuevo Cliente",
            mensaje:
              "¬°Hola {nombre}! Bienvenido/a a nuestro gimnasio. Tu membres√≠a est√° activa desde hoy. Recuerda traer tu documento de identidad en tu primera visita. ¬°Nos vemos pronto!",
            categoria: "Bienvenida",
            activa: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "p3",
            titulo: "Renovaci√≥n de Membres√≠a",
            mensaje:
              "Hola {nombre}, tu membres√≠a vence en {dias} d√≠as. Te ofrecemos descuentos especiales por renovaci√≥n anticipada. ¬°No pierdas tus beneficios!",
            categoria: "Membres√≠as",
            activa: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "p4",
            titulo: "Cliente Deudor",
            mensaje:
              "Hola {nombre}, tu cuenta presenta un saldo pendiente de ${monto}. Para evitar la suspensi√≥n de tu membres√≠a, te solicitamos regularizar tu situaci√≥n lo antes posible.",
            categoria: "Deudores",
            activa: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "p5",
            titulo: "Feliz Cumplea√±os",
            mensaje:
              "¬°Feliz cumplea√±os {nombre}! üéâüéÇ En tu d√≠a especial, te regalamos una clase personalizada. ¬°Ven a celebrar con nosotros!",
            categoria: "Cumplea√±os",
            activa: true,
            fechaCreacion: new Date().toISOString(),
          },
        ];
      }

      function renderPlantillasWhatsApp(root) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 class="section-title" style="margin: 0;">Plantillas de WhatsApp</h3>
            <button class="btn primary" onclick="abrirModalNuevaPlantilla()" style="padding: 0.8rem 1.5rem;">
              ‚ûï Nueva Plantilla
            </button>
          </div>

          <!-- Filtros -->
          <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <select id="filtroCategoria" onchange="filtrarPlantillas()" style="padding: 0.5rem; border: 1px solid var(--muted); border-radius: 6px; background: white;">
              <option value="">Todas las categor√≠as</option>
              <option value="Pagos">Pagos</option>
              <option value="Bienvenida">Bienvenida</option>
              <option value="Membres√≠as">Membres√≠as</option>
              <option value="Deudores">Deudores</option>
              <option value="Cumplea√±os">Cumplea√±os</option>
              <option value="General">General</option>
            </select>
            <select id="filtroEstado" onchange="filtrarPlantillas()" style="padding: 0.5rem; border: 1px solid var(--muted); border-radius: 6px; background: white;">
              <option value="">Todos los estados</option>
              <option value="activa">Activas</option>
              <option value="inactiva">Inactivas</option>
            </select>
            <input 
              type="text" 
              id="buscarPlantilla" 
              placeholder="Buscar plantilla..." 
              oninput="filtrarPlantillas()"
              style="padding: 0.5rem; border: 1px solid var(--muted); border-radius: 6px; background: white; flex: 1; min-width: 200px;"
            />
          </div>

          <!-- Lista de plantillas -->
          <div id="listaPlantillas" style="display: grid; gap: 1rem;">
            <!-- Las plantillas se cargar√°n din√°micamente -->
          </div>
        `;
        root.append(card);
        cargarPlantillas();
      }

      function cargarPlantillas() {
        const container = EL("#listaPlantillas");
        const plantillas = DB.plantillasWhatsApp || [];

        if (plantillas.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--sub);">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.5;">
                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9ZM19 9H14V4H5V21H19V9Z" fill="currentColor"/>
              </svg>
              <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No hay plantillas creadas</div>
              <div style="font-size: 0.9rem;">Crea tu primera plantilla de WhatsApp</div>
            </div>
          `;
          return;
        }

        const html = plantillas
          .map(
            (plantilla) => `
          <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1.5rem; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">${
                    plantilla.titulo
                  }</h4>
                  <span style="background: ${
                    plantilla.activa ? "var(--ok)" : "var(--sub)"
                  }; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                    ${plantilla.activa ? "Activa" : "Inactiva"}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem;">
                  <span style="background: var(--brand); color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${
                    plantilla.categoria
                  }</span>
                  <span style="color: var(--sub); font-size: 0.8rem;">Creada: ${new Date(
                    plantilla.fechaCreacion
                  ).toLocaleDateString("es-EC")}</span>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="editarPlantilla('${
                  plantilla.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn" onclick="togglePlantilla('${
                  plantilla.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="${
              plantilla.activa ? "Desactivar" : "Activar"
            }">
                  ${plantilla.activa ? "üî¥" : "üü¢"}
                </button>
                <button class="btn danger" onclick="eliminarPlantilla('${
                  plantilla.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            
            <div style="background: #f8f9fa; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem;">Mensaje:</div>
              <div style="color: var(--sub); font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;">${
                plantilla.mensaje
              }</div>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn" onclick="copiarPlantilla('${
                plantilla.id
              }')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                üìã Copiar
              </button>
              <button class="btn success" onclick="usarPlantilla('${
                plantilla.id
              }')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                üì± Usar
              </button>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
      }

      function filtrarPlantillas() {
        const categoria = EL("#filtroCategoria").value;
        const estado = EL("#filtroEstado").value;
        const busqueda = EL("#buscarPlantilla").value.toLowerCase();

        const plantillas = DB.plantillasWhatsApp || [];
        const plantillasFiltradas = plantillas.filter((plantilla) => {
          const cumpleCategoria =
            !categoria || plantilla.categoria === categoria;
          const cumpleEstado =
            !estado ||
            (estado === "activa" && plantilla.activa) ||
            (estado === "inactiva" && !plantilla.activa);
          const cumpleBusqueda =
            !busqueda ||
            plantilla.titulo.toLowerCase().includes(busqueda) ||
            plantilla.mensaje.toLowerCase().includes(busqueda) ||
            plantilla.categoria.toLowerCase().includes(busqueda);

          return cumpleCategoria && cumpleEstado && cumpleBusqueda;
        });

        const container = EL("#listaPlantillas");
        if (plantillasFiltradas.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--sub);">
              <div style="font-size: 1rem;">No se encontraron plantillas con los filtros aplicados</div>
            </div>
          `;
          return;
        }

        const html = plantillasFiltradas
          .map(
            (plantilla) => `
          <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1.5rem; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">${
                    plantilla.titulo
                  }</h4>
                  <span style="background: ${
                    plantilla.activa ? "var(--ok)" : "var(--sub)"
                  }; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                    ${plantilla.activa ? "Activa" : "Inactiva"}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem;">
                  <span style="background: var(--brand); color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${
                    plantilla.categoria
                  }</span>
                  <span style="color: var(--sub); font-size: 0.8rem;">Creada: ${new Date(
                    plantilla.fechaCreacion
                  ).toLocaleDateString("es-EC")}</span>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="editarPlantilla('${
                  plantilla.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn" onclick="togglePlantilla('${
                  plantilla.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="${
              plantilla.activa ? "Desactivar" : "Activar"
            }">
                  ${plantilla.activa ? "üî¥" : "üü¢"}
                </button>
                <button class="btn danger" onclick="eliminarPlantilla('${
                  plantilla.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            
            <div style="background: #f8f9fa; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem;">Mensaje:</div>
              <div style="color: var(--sub); font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;">${
                plantilla.mensaje
              }</div>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn" onclick="copiarPlantilla('${
                plantilla.id
              }')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                üìã Copiar
              </button>
              <button class="btn success" onclick="usarPlantilla('${
                plantilla.id
              }')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                üì± Usar
              </button>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
      }

      function abrirModalNuevaPlantilla() {
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.3rem; font-weight: 700;">Nueva Plantilla de WhatsApp</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>

            <form id="formNuevaPlantilla">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">T√≠tulo de la plantilla:</label>
                <input 
                  type="text" 
                  id="plantillaTitulo" 
                  placeholder="Ej: Recordatorio de pago"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Categor√≠a:</label>
                <select 
                  id="plantillaCategoria" 
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                >
                  <option value="">Seleccionar categor√≠a...</option>
                  <option value="Pagos">Pagos</option>
                  <option value="Bienvenida">Bienvenida</option>
                  <option value="Membres√≠as">Membres√≠as</option>
                  <option value="Deudores">Deudores</option>
                  <option value="Cumplea√±os">Cumplea√±os</option>
                  <option value="General">General</option>
                </select>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Mensaje:</label>
                <textarea 
                  id="plantillaMensaje" 
                  rows="8"
                  placeholder="Escribe tu mensaje aqu√≠. Puedes usar variables como {nombre}, {monto}, {fecha}, etc."
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white; resize: vertical;"
                  required
                ></textarea>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="plantillaActiva" checked style="margin: 0;">
                  <span style="color: var(--text); font-weight: 500;">Plantilla activa</span>
                </label>
              </div>

              <div style="background: #f8f9fa; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Variables disponibles:</div>
                <div style="font-size: 0.9rem; color: var(--sub);">
                  <code>{nombre}</code> - Nombre del cliente<br>
                  <code>{monto}</code> - Monto de pago/deuda<br>
                  <code>{fecha}</code> - Fecha de vencimiento<br>
                  <code>{dias}</code> - D√≠as restantes<br>
                  <code>{sucursal}</code> - Nombre de la sucursal
                </div>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button 
                  type="button" 
                  onclick="this.closest('.modal').remove()" 
                  style="
                    background: var(--panel);
                    color: var(--text);
                    border: 1px solid var(--muted);
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  style="
                    background: var(--ok);
                    color: white;
                    border: none;
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                  "
                >
                  Guardar Plantilla
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar env√≠o del formulario
        EL("#formNuevaPlantilla").onsubmit = function (e) {
          e.preventDefault();
          guardarNuevaPlantilla();
        };

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function guardarNuevaPlantilla() {
        const titulo = EL("#plantillaTitulo").value.trim();
        const categoria = EL("#plantillaCategoria").value;
        const mensaje = EL("#plantillaMensaje").value.trim();
        const activa = EL("#plantillaActiva").checked;

        if (!titulo || !categoria || !mensaje) {
          alert("Por favor completa todos los campos obligatorios");
          return;
        }

        const nuevaPlantilla = {
          id: uuid(),
          titulo: titulo,
          mensaje: mensaje,
          categoria: categoria,
          activa: activa,
          fechaCreacion: new Date().toISOString(),
        };

        DB.plantillasWhatsApp.push(nuevaPlantilla);
        save();

        // Cerrar modal y actualizar vista
        document.querySelector(".modal").remove();
        cargarPlantillas();

        alert("‚úÖ Plantilla creada exitosamente");
      }

      function editarPlantilla(id) {
        const plantilla = DB.plantillasWhatsApp.find((p) => p.id === id);
        if (!plantilla) return;

        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.3rem; font-weight: 700;">Editar Plantilla</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>

            <form id="formEditarPlantilla">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">T√≠tulo de la plantilla:</label>
                <input 
                  type="text" 
                  id="plantillaTituloEdit" 
                  value="${plantilla.titulo}"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Categor√≠a:</label>
                <select 
                  id="plantillaCategoriaEdit" 
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                >
                  <option value="Pagos" ${
                    plantilla.categoria === "Pagos" ? "selected" : ""
                  }>Pagos</option>
                  <option value="Bienvenida" ${
                    plantilla.categoria === "Bienvenida" ? "selected" : ""
                  }>Bienvenida</option>
                  <option value="Membres√≠as" ${
                    plantilla.categoria === "Membres√≠as" ? "selected" : ""
                  }>Membres√≠as</option>
                  <option value="Deudores" ${
                    plantilla.categoria === "Deudores" ? "selected" : ""
                  }>Deudores</option>
                  <option value="Cumplea√±os" ${
                    plantilla.categoria === "Cumplea√±os" ? "selected" : ""
                  }>Cumplea√±os</option>
                  <option value="General" ${
                    plantilla.categoria === "General" ? "selected" : ""
                  }>General</option>
                </select>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Mensaje:</label>
                <textarea 
                  id="plantillaMensajeEdit" 
                  rows="8"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white; resize: vertical;"
                  required
                >${plantilla.mensaje}</textarea>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="plantillaActivaEdit" ${
                    plantilla.activa ? "checked" : ""
                  } style="margin: 0;">
                  <span style="color: var(--text); font-weight: 500;">Plantilla activa</span>
                </label>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button 
                  type="button" 
                  onclick="this.closest('.modal').remove()" 
                  style="
                    background: var(--panel);
                    color: var(--text);
                    border: 1px solid var(--muted);
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  style="
                    background: var(--ok);
                    color: white;
                    border: none;
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                  "
                >
                  Actualizar Plantilla
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar env√≠o del formulario
        EL("#formEditarPlantilla").onsubmit = function (e) {
          e.preventDefault();
          actualizarPlantilla(id);
        };

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function actualizarPlantilla(id) {
        const titulo = EL("#plantillaTituloEdit").value.trim();
        const categoria = EL("#plantillaCategoriaEdit").value;
        const mensaje = EL("#plantillaMensajeEdit").value.trim();
        const activa = EL("#plantillaActivaEdit").checked;

        if (!titulo || !categoria || !mensaje) {
          alert("Por favor completa todos los campos obligatorios");
          return;
        }

        const plantilla = DB.plantillasWhatsApp.find((p) => p.id === id);
        if (plantilla) {
          plantilla.titulo = titulo;
          plantilla.mensaje = mensaje;
          plantilla.categoria = categoria;
          plantilla.activa = activa;

          save();

          // Cerrar modal y actualizar vista
          document.querySelector(".modal").remove();
          cargarPlantillas();

          alert("‚úÖ Plantilla actualizada exitosamente");
        }
      }

      function togglePlantilla(id) {
        const plantilla = DB.plantillasWhatsApp.find((p) => p.id === id);
        if (plantilla) {
          plantilla.activa = !plantilla.activa;
          save();
          cargarPlantillas();
          alert(
            `Plantilla ${
              plantilla.activa ? "activada" : "desactivada"
            } exitosamente`
          );
        }
      }

      function eliminarPlantilla(id) {
        if (
          confirm(
            "¬øEst√°s seguro de que quieres eliminar esta plantilla? Esta acci√≥n no se puede deshacer."
          )
        ) {
          DB.plantillasWhatsApp = DB.plantillasWhatsApp.filter(
            (p) => p.id !== id
          );
          save();
          cargarPlantillas();
          alert("‚úÖ Plantilla eliminada exitosamente");
        }
      }

      function copiarPlantilla(id) {
        const plantilla = DB.plantillasWhatsApp.find((p) => p.id === id);
        if (plantilla) {
          navigator.clipboard
            .writeText(plantilla.mensaje)
            .then(() => {
              alert("‚úÖ Mensaje copiado al portapapeles");
            })
            .catch(() => {
              alert("‚ùå No se pudo copiar al portapapeles");
            });
        }
      }

      function usarPlantilla(id) {
        const plantilla = DB.plantillasWhatsApp.find((p) => p.id === id);
        if (plantilla) {
          abrirModalEnviarWhatsApp(plantilla);
        }
      }

      function abrirModalEnviarWhatsApp(plantilla) {
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.3rem; font-weight: 700;">Enviar Mensaje por WhatsApp</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <div style="background: #f8f9fa; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Plantilla: ${plantilla.titulo}</div>
                <div style="color: var(--sub); font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;">${plantilla.mensaje}</div>
              </div>
            </div>

            <form id="formEnviarWhatsApp">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">N√∫mero de tel√©fono:</label>
                <input 
                  type="tel" 
                  id="numeroWhatsApp" 
                  placeholder="Ej: 593991234567 (sin + ni espacios)"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
                <div style="font-size: 0.8rem; color: var(--sub); margin-top: 0.3rem;">
                  Formato: c√≥digo de pa√≠s + n√∫mero (ej: 593991234567)
                </div>
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Mensaje personalizado:</label>
                <textarea 
                  id="mensajePersonalizado" 
                  rows="6"
                  placeholder="Personaliza el mensaje aqu√≠..."
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white; resize: vertical;"
                >${plantilla.mensaje}</textarea>
              </div>

              <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 600; color: #2e7d32; margin-bottom: 0.5rem;">üí° Variables disponibles:</div>
                <div style="font-size: 0.9rem; color: #2e7d32;">
                  <code>{nombre}</code> - Nombre del cliente<br>
                  <code>{monto}</code> - Monto de pago/deuda<br>
                  <code>{fecha}</code> - Fecha de vencimiento<br>
                  <code>{dias}</code> - D√≠as restantes<br>
                  <code>{sucursal}</code> - Nombre de la sucursal
                </div>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button 
                  type="button" 
                  onclick="this.closest('.modal').remove()" 
                  style="
                    background: var(--panel);
                    color: var(--text);
                    border: 1px solid var(--muted);
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  style="
                    background: #25d366;
                    color: white;
                    border: none;
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                  "
                >
                  üì± Enviar por WhatsApp
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar env√≠o del formulario
        EL("#formEnviarWhatsApp").onsubmit = function (e) {
          e.preventDefault();
          enviarWhatsApp();
        };

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function enviarWhatsApp() {
        const numero = EL("#numeroWhatsApp").value.trim();
        const mensaje = EL("#mensajePersonalizado").value.trim();

        if (!numero || !mensaje) {
          alert("Por favor completa todos los campos obligatorios");
          return;
        }

        // Validar formato del n√∫mero
        const numeroLimpio = numero.replace(/\D/g, "");
        if (numeroLimpio.length < 10) {
          alert("Por favor ingresa un n√∫mero de tel√©fono v√°lido");
          return;
        }

        // Codificar el mensaje para URL
        const mensajeCodificado = encodeURIComponent(mensaje);

        // Crear URL de WhatsApp
        const urlWhatsApp = `https://wa.me/${numeroLimpio}?text=${mensajeCodificado}`;

        // Abrir WhatsApp en nueva pesta√±a
        window.open(urlWhatsApp, "_blank");

        // Cerrar modal
        document.querySelector(".modal").remove();

        alert("‚úÖ WhatsApp abierto con el mensaje listo para enviar");
      }

      /******************** GESTI√ìN DE DESCUENTOS ********************/

      function seedDescuentos() {
        return [
          {
            id: "d1",
            nombre: "Descuento Estudiantil",
            monto: 15,
            activo: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "d2",
            nombre: "Descuento Familiar",
            monto: 20,
            activo: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "d3",
            nombre: "Descuento Anual",
            monto: 25,
            activo: true,
            fechaCreacion: new Date().toISOString(),
          },
          {
            id: "d4",
            nombre: "Descuento Senior",
            monto: 10,
            activo: false,
            fechaCreacion: new Date().toISOString(),
          },
        ];
      }

      function renderDescuentos(root) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 class="section-title" style="margin: 0;">Gesti√≥n de Descuentos</h3>
            <button class="btn primary" onclick="abrirModalNuevoDescuento()" style="padding: 0.8rem 1.5rem;">
              ‚ûï Agregar Descuento
            </button>
          </div>

          <!-- Filtros -->
          <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <select id="filtroEstadoDescuento" onchange="filtrarDescuentos()" style="padding: 0.5rem; border: 1px solid var(--muted); border-radius: 6px; background: white;">
              <option value="">Todos los estados</option>
              <option value="activo">Activos</option>
              <option value="inactivo">Inactivos</option>
            </select>
            <input 
              type="text" 
              id="buscarDescuento" 
              placeholder="Buscar descuento..." 
              oninput="filtrarDescuentos()"
              style="padding: 0.5rem; border: 1px solid var(--muted); border-radius: 6px; background: white; flex: 1; min-width: 200px;"
            />
          </div>

          <!-- Lista de descuentos -->
          <div id="listaDescuentos" style="display: grid; gap: 1rem;">
            <!-- Los descuentos se cargar√°n din√°micamente -->
          </div>
        `;
        root.append(card);
        cargarDescuentos();
      }

      function cargarDescuentos() {
        const container = EL("#listaDescuentos");
        const descuentos = DB.descuentos || [];

        if (descuentos.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--sub);">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.5;">
                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9ZM19 9H14V4H5V21H19V9Z" fill="currentColor"/>
              </svg>
              <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No hay descuentos creados</div>
              <div style="font-size: 0.9rem;">Crea tu primer descuento</div>
            </div>
          `;
          return;
        }

        const html = descuentos
          .map(
            (descuento) => `
          <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1.5rem; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">${
                    descuento.nombre
                  }</h4>
                  <span style="background: ${
                    descuento.activo ? "var(--ok)" : "var(--sub)"
                  }; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                    ${descuento.activo ? "Activo" : "Inactivo"}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem;">
                  <span style="background: var(--brand); color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${
                    descuento.monto
                  }%</span>
                  <span style="color: var(--sub); font-size: 0.8rem;">Creado: ${new Date(
                    descuento.fechaCreacion
                  ).toLocaleDateString("es-EC")}</span>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="editarDescuento('${
                  descuento.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn" onclick="toggleDescuento('${
                  descuento.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="${
              descuento.activo ? "Desactivar" : "Activar"
            }">
                  ${descuento.activo ? "üî¥" : "üü¢"}
                </button>
                <button class="btn danger" onclick="eliminarDescuento('${
                  descuento.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            
            <div style="background: #f8f9fa; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem;">Detalles del descuento:</div>
              <div style="color: var(--sub); font-size: 0.9rem; line-height: 1.5;">
                <strong>Nombre:</strong> ${descuento.nombre}<br>
                <strong>Porcentaje:</strong> ${descuento.monto}%<br>
                <strong>Estado:</strong> ${
                  descuento.activo ? "Activo" : "Inactivo"
                }<br>
                <strong>Fecha de creaci√≥n:</strong> ${new Date(
                  descuento.fechaCreacion
                ).toLocaleDateString("es-EC")}
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
      }

      function filtrarDescuentos() {
        const estado = EL("#filtroEstadoDescuento").value;
        const busqueda = EL("#buscarDescuento").value.toLowerCase();

        const descuentos = DB.descuentos || [];
        const descuentosFiltrados = descuentos.filter((descuento) => {
          const cumpleEstado =
            !estado ||
            (estado === "activo" && descuento.activo) ||
            (estado === "inactivo" && !descuento.activo);
          const cumpleBusqueda =
            !busqueda ||
            descuento.nombre.toLowerCase().includes(busqueda) ||
            descuento.monto.toString().includes(busqueda);

          return cumpleEstado && cumpleBusqueda;
        });

        const container = EL("#listaDescuentos");
        if (descuentosFiltrados.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--sub);">
              <div style="font-size: 1rem;">No se encontraron descuentos con los filtros aplicados</div>
            </div>
          `;
          return;
        }

        const html = descuentosFiltrados
          .map(
            (descuento) => `
          <div style="background: white; border: 1px solid var(--muted); border-radius: 8px; padding: 1.5rem; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <h4 style="margin: 0; color: var(--text); font-size: 1.1rem; font-weight: 600;">${
                    descuento.nombre
                  }</h4>
                  <span style="background: ${
                    descuento.activo ? "var(--ok)" : "var(--sub)"
                  }; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                    ${descuento.activo ? "Activo" : "Inactivo"}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem;">
                  <span style="background: var(--brand); color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${
                    descuento.monto
                  }%</span>
                  <span style="color: var(--sub); font-size: 0.8rem;">Creado: ${new Date(
                    descuento.fechaCreacion
                  ).toLocaleDateString("es-EC")}</span>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn" onclick="editarDescuento('${
                  descuento.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn" onclick="toggleDescuento('${
                  descuento.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="${
              descuento.activo ? "Desactivar" : "Activar"
            }">
                  ${descuento.activo ? "üî¥" : "üü¢"}
                </button>
                <button class="btn danger" onclick="eliminarDescuento('${
                  descuento.id
                }')" style="padding: 0.5rem; font-size: 0.8rem;" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            
            <div style="background: #f8f9fa; border: 1px solid var(--muted); border-radius: 6px; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem;">Detalles del descuento:</div>
              <div style="color: var(--sub); font-size: 0.9rem; line-height: 1.5;">
                <strong>Nombre:</strong> ${descuento.nombre}<br>
                <strong>Porcentaje:</strong> ${descuento.monto}%<br>
                <strong>Estado:</strong> ${
                  descuento.activo ? "Activo" : "Inactivo"
                }<br>
                <strong>Fecha de creaci√≥n:</strong> ${new Date(
                  descuento.fechaCreacion
                ).toLocaleDateString("es-EC")}
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = html;
      }

      function abrirModalNuevoDescuento() {
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.3rem; font-weight: 700;">Nuevo Descuento</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>

            <form id="formNuevoDescuento">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Nombre del descuento:</label>
                <input 
                  type="text" 
                  id="descuentoNombre" 
                  placeholder="Ej: Descuento Estudiantil"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Porcentaje de descuento (%):</label>
                <input 
                  type="number" 
                  id="descuentoMonto" 
                  min="1" 
                  max="100"
                  placeholder="Ej: 15"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="descuentoActivo" checked style="margin: 0;">
                  <span style="color: var(--text); font-weight: 500;">Descuento activo</span>
                </label>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button 
                  type="button" 
                  onclick="this.closest('.modal').remove()" 
                  style="
                    background: var(--panel);
                    color: var(--text);
                    border: 1px solid var(--muted);
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  style="
                    background: var(--ok);
                    color: white;
                    border: none;
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                  "
                >
                  Guardar Descuento
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar env√≠o del formulario
        EL("#formNuevoDescuento").onsubmit = function (e) {
          e.preventDefault();
          guardarNuevoDescuento();
        };

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function guardarNuevoDescuento() {
        const nombre = EL("#descuentoNombre").value.trim();
        const monto = parseInt(EL("#descuentoMonto").value);
        const activo = EL("#descuentoActivo").checked;

        if (!nombre || !monto || monto < 1 || monto > 100) {
          alert(
            "Por favor completa todos los campos correctamente. El porcentaje debe estar entre 1% y 100%"
          );
          return;
        }

        const nuevoDescuento = {
          id: uuid(),
          nombre: nombre,
          monto: monto,
          activo: activo,
          fechaCreacion: new Date().toISOString(),
        };

        DB.descuentos.push(nuevoDescuento);
        save();

        // Cerrar modal y actualizar vista
        document.querySelector(".modal").remove();
        cargarDescuentos();

        alert("‚úÖ Descuento creado exitosamente");
      }

      function editarDescuento(id) {
        const descuento = DB.descuentos.find((d) => d.id === id);
        if (!descuento) return;

        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0; color: var(--text); font-size: 1.3rem; font-weight: 700;">Editar Descuento</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--sub);
                padding: 0.5rem;
              ">‚úï</button>
            </div>

            <form id="formEditarDescuento">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Nombre del descuento:</label>
                <input 
                  type="text" 
                  id="descuentoNombreEdit" 
                  value="${descuento.nombre}"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
              </div>

              <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Porcentaje de descuento (%):</label>
                <input 
                  type="number" 
                  id="descuentoMontoEdit" 
                  min="1" 
                  max="100"
                  value="${descuento.monto}"
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--muted); border-radius: 6px; background: white;"
                  required
                />
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="descuentoActivoEdit" ${
                    descuento.activo ? "checked" : ""
                  } style="margin: 0;">
                  <span style="color: var(--text); font-weight: 500;">Descuento activo</span>
                </label>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button 
                  type="button" 
                  onclick="this.closest('.modal').remove()" 
                  style="
                    background: var(--panel);
                    color: var(--text);
                    border: 1px solid var(--muted);
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                  "
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  style="
                    background: var(--ok);
                    color: white;
                    border: none;
                    padding: 0.8rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                  "
                >
                  Actualizar Descuento
                </button>
              </div>
            </form>
          </div>
        `;

        modal.className = "modal";
        document.body.appendChild(modal);

        // Manejar env√≠o del formulario
        EL("#formEditarDescuento").onsubmit = function (e) {
          e.preventDefault();
          actualizarDescuento(id);
        };

        // Cerrar modal al hacer clic fuera
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      function actualizarDescuento(id) {
        const nombre = EL("#descuentoNombreEdit").value.trim();
        const monto = parseInt(EL("#descuentoMontoEdit").value);
        const activo = EL("#descuentoActivoEdit").checked;

        if (!nombre || !monto || monto < 1 || monto > 100) {
          alert(
            "Por favor completa todos los campos correctamente. El porcentaje debe estar entre 1% y 100%"
          );
          return;
        }

        const descuento = DB.descuentos.find((d) => d.id === id);
        if (descuento) {
          descuento.nombre = nombre;
          descuento.monto = monto;
          descuento.activo = activo;

          save();

          // Cerrar modal y actualizar vista
          document.querySelector(".modal").remove();
          cargarDescuentos();

          alert("‚úÖ Descuento actualizado exitosamente");
        }
      }

      function toggleDescuento(id) {
        const descuento = DB.descuentos.find((d) => d.id === id);
        if (descuento) {
          descuento.activo = !descuento.activo;
          save();
          cargarDescuentos();
          alert(
            `Descuento ${
              descuento.activo ? "activado" : "desactivado"
            } exitosamente`
          );
        }
      }

      function eliminarDescuento(id) {
        if (
          confirm(
            "¬øEst√°s seguro de que quieres eliminar este descuento? Esta acci√≥n no se puede deshacer."
          )
        ) {
          DB.descuentos = DB.descuentos.filter((d) => d.id !== id);
          save();
          cargarDescuentos();
          alert("‚úÖ Descuento eliminado exitosamente");
        }
      }

      /* === FACTURACI√ìN (Prototipo POS) ============================== */
      /* Basado en los estilos existentes: .card, .grid, .input, .btn, .section-title */

      (function initFacturacionNav() {
        const menu = document.getElementById("menu");
        if (!menu || document.getElementById("btn-facturacion")) return;

        const btn = document.createElement("button");
        btn.id = "btn-facturacion";
        btn.innerHTML = "üí≥ Facturaci√≥n";
        btn.onclick = () => renderFacturacion();
        menu.appendChild(btn);
      })();

      const IVA_PORC = 0.12; // 12% Ecuador

      function renderFacturacion() {
        const viewRoot = document.getElementById("viewRoot");
        if (!viewRoot) return;

        // aspecto de 2 columnas (form + panel derecho)
        viewRoot.className = "grid cols-2";
        viewRoot.innerHTML = `
    <div class="card">
      <h3 class="section-title">Punto de Venta ‚Ä¢ Nueva Factura</h3>

      <div class="grid cols-2">
        <div>
          <label style="font-weight:600">Cliente</label>
          <input id="fc_cliente" class="input" placeholder="Nombre o Raz√≥n Social" />
        </div>
        <div>
          <label style="font-weight:600">Identificaci√≥n</label>
          <input id="fc_ident" class="input" placeholder="CI/RUC/Pasaporte" />
        </div>
        <div>
          <label style="font-weight:600">Correo</label>
          <input id="fc_email" type="email" class="input" placeholder="correo@dominio.com" />
        </div>
        <div>
          <label style="font-weight:600">Fecha</label>
          <input id="fc_fecha" type="datetime-local" class="input" />
        </div>
        <div>
          <label style="font-weight:600">Sucursal</label>
          <select id="fc_sucursal" class="select">
            <option>Matriz</option>
            <option>Ponciano</option>
            <option>QT</option>
          </select>
        </div>
        <div>
          <label style="font-weight:600">Tipo de Comprobante</label>
          <select id="fc_tipo" class="select">
            <option value="FACTURA" selected>Factura</option>
            <option value="PROFORMA">Proforma</option>
            <option value="NOTA_VENTA">Nota de venta</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <!-- √çtems -->
      <div>
        <div class="row" style="justify-content: space-between; align-items:center; margin-bottom:.5rem">
          <h4 style="margin:0">Detalle de √çtems</h4>
          <div class="row" style="gap:.5rem">
            <input id="fc_buscar" class="input" placeholder="Buscar producto (mock)" style="width:220px">
            <button class="btn" onclick="fcAddItem()">+ Agregar √çtem</button>
          </div>
        </div>

        <div style="overflow:auto; border:1px solid #e0e0e0; border-radius:8px">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px">Descripci√≥n</th>
                <th>Cant.</th>
                <th>P. Unit.</th>
                <th>Desc. %</th>
                <th>IVA</th>
                <th>Importe</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="fc_tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:1rem">
        <div class="card" style="background:#fafafa">
          <h4 style="margin-top:0">Notas</h4>
          <textarea id="fc_notas" rows="5" class="input" style="resize:vertical" placeholder="Observaciones para esta factura..."></textarea>
          <label class="row" style="gap:.5rem; margin-top:.5rem; align-items:center">
            <input id="fc_consumidorFinal" type="checkbox">
            <span>Consumidor final (sin datos de identificaci√≥n)</span>
          </label>
        </div>

        <div class="card" style="background:#fafafa">
          <h4 style="margin-top:0">Totales</h4>
          <div class="row" style="justify-content:space-between"><span>Subtotal 0%:</span><strong id="fc_sub0">$0.00</strong></div>
          <div class="row" style="justify-content:space-between"><span>Subtotal IVA:</span><strong id="fc_subIva">$0.00</strong></div>
          <div class="row" style="justify-content:space-between"><span>Descuento:</span><strong id="fc_desc">$0.00</strong></div>
          <div class="row" style="justify-content:space-between"><span>IVA (12%):</span><strong id="fc_iva">$0.00</strong></div>
          <div class="row" style="justify-content:space-between; font-size:1.15rem; margin-top:.5rem">
            <span>Total:</span><strong id="fc_total">$0.00</strong>
          </div>

          <div class="sep"></div>

          <label style="font-weight:600">M√©todo de Pago</label>
          <select id="fc_metodo" class="select" style="margin-bottom:.5rem">
            <option>Efectivo</option>
            <option>Tarjeta</option>
            <option>Transferencia</option>
            <option>Dep√≥sito</option>
            <option>Mixto</option>
          </select>

          <div class="row" style="gap:.5rem">
            <button class="btn" onclick="fcGuardarBorrador()">üíæ Guardar borrador</button>
            <button class="btn success" onclick="fcEmitir()">üöÄ Emitir</button>
            <button class="btn danger" onclick="fcAnular()">üóëÔ∏è Anular</button>
            <button class="btn ghost" onclick="fcNueva()">‚ûï Nueva</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel derecho: Historial r√°pido + Vista previa -->
    <div class="card">
      <h3 class="section-title">Historial R√°pido</h3>
      <div id="fc_hist" class="grid cols-3"></div>
      <div class="sep"></div>
      <h4>Vista previa</h4>
      <div id="fc_preview" class="card" style="background:#fff">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:800">GYM ‚Äî Facturaci√≥n</div>
            <div class="muted mini">RUC 1799999999001</div>
            <div class="muted mini">Matriz ‚Äî Quito</div>
          </div>
          <div style="text-align:right">
            <div><strong id="pv_tipo">FACTURA</strong></div>
            <div class="mini muted"># Borrador</div>
            <div class="mini muted" id="pv_fecha"></div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid cols-2">
          <div>
            <div class="mini muted">Cliente</div>
            <div id="pv_cliente"><em>‚Äî</em></div>
            <div class="mini muted">Identificaci√≥n</div>
            <div id="pv_ident"><em>‚Äî</em></div>
          </div>
          <div>
            <div class="mini muted">Correo</div>
            <div id="pv_email"><em>‚Äî</em></div>
            <div class="mini muted">Sucursal</div>
            <div id="pv_sucursal"><em>‚Äî</em></div>
          </div>
        </div>
        <div class="sep"></div>
        <div style="overflow:auto; border:1px solid #e0e0e0; border-radius:8px">
          <table>
            <thead><tr><th>Descripci√≥n</th><th class="mini">Cant.</th><th class="mini">P.Unit</th><th class="mini">Desc.%</th><th class="mini">IVA</th><th>Importe</th></tr></thead>
            <tbody id="pv_tbody"></tbody>
          </table>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:.5rem">
          <div style="min-width:260px">
            <div class="row" style="justify-content:space-between"><span class="mini muted">Subtotal 0%:</span><strong id="pv_sub0">$0.00</strong></div>
            <div class="row" style="justify-content:space-between"><span class="mini muted">Subtotal IVA:</span><strong id="pv_subIva">$0.00</strong></div>
            <div class="row" style="justify-content:space-between"><span class="mini muted">Descuento:</span><strong id="pv_desc">$0.00</strong></div>
            <div class="row" style="justify-content:space-between"><span class="mini muted">IVA 12%:</span><strong id="pv_iva">$0.00</strong></div>
            <div class="row" style="justify-content:space-between; font-size:1.05rem; margin-top:.25rem"><span>Total:</span><strong id="pv_total">$0.00</strong></div>
          </div>
        </div>
      </div>
    </div>
  `;

        // estado en memoria
        window.__FC_STATE = {
          items: [],
          historial: [],
        };

        // set defaults
        document.getElementById("fc_fecha").value = new Date()
          .toISOString()
          .slice(0, 16);
        updatePreview();
        fcRenderItems();
        fcRenderHistorial();
      }

      /* === Items ===================================================== */

      function fcAddItem() {
        const buscar = (
          document.getElementById("fc_buscar")?.value || ""
        ).trim();
        // mock r√°pido a partir del texto de b√∫squeda
        const base = buscar || "Membres√≠a Mensual";
        window.__FC_STATE.items.push({
          desc: base,
          cant: 1,
          pu: base.toLowerCase().includes("anual")
            ? 300
            : base.toLowerCase().includes("trimestral")
            ? 90
            : 35,
          descPct: 0,
          gravaIva: true,
        });
        fcRenderItems();
      }

      function fcRemoveItem(idx) {
        window.__FC_STATE.items.splice(idx, 1);
        fcRenderItems();
      }

      function fcRenderItems() {
        const tb = document.getElementById("fc_tbody");
        tb.innerHTML = "";
        window.__FC_STATE.items.forEach((it, idx) => {
          const importe = fcImporte(it);
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td><input class="input" value="${
        it.desc
      }" oninput="fcUpd(${idx},'desc',this.value)"></td>
      <td style="max-width:100px"><input class="input" type="number" min="1" value="${
        it.cant
      }" oninput="fcUpd(${idx},'cant',this.value)"></td>
      <td style="max-width:140px"><input class="input" type="number" step="0.01" value="${
        it.pu
      }" oninput="fcUpd(${idx},'pu',this.value)"></td>
      <td style="max-width:120px"><input class="input" type="number" min="0" max="100" value="${
        it.descPct
      }" oninput="fcUpd(${idx},'descPct',this.value)"></td>
      <td style="text-align:center">
        <label class="row" style="gap:.5rem; align-items:center; justify-content:center">
          <input type="checkbox" ${
            it.gravaIva ? "checked" : ""
          } onchange="fcUpd(${idx},'gravaIva',this.checked)">
          <span class="mini muted">12%</span>
        </label>
      </td>
      <td><strong>$${importe.toFixed(2)}</strong></td>
      <td><button class="btn danger" onclick="fcRemoveItem(${idx})">‚úï</button></td>
    `;
          tb.appendChild(tr);
        });
        fcRecalc();
      }

      function fcUpd(idx, field, value) {
        const it = window.__FC_STATE.items[idx];
        if (!it) return;
        if (field === "cant" || field === "pu" || field === "descPct") {
          it[field] = Number(value || 0);
        } else if (field === "gravaIva") {
          it[field] = !!value;
        } else {
          it[field] = value;
        }
        fcRenderItems();
      }

      function fcImporte(it) {
        const bruto = Number(it.cant || 0) * Number(it.pu || 0);
        const d = Math.min(100, Math.max(0, Number(it.descPct || 0)));
        return bruto * (1 - d / 100);
      }

      function fcRecalc() {
        const items = window.__FC_STATE.items;
        let sub0 = 0,
          subIva = 0,
          iva = 0,
          descTotal = 0;
        items.forEach((it) => {
          const bruto = Number(it.cant || 0) * Number(it.pu || 0);
          const d = bruto - fcImporte(it);
          descTotal += d;
          if (it.gravaIva) {
            subIva += fcImporte(it);
          } else {
            sub0 += fcImporte(it);
          }
        });
        iva = subIva * IVA_PORC;
        const total = sub0 + subIva + iva;

        // totales en panel
        setText("fc_sub0", sub0);
        setText("fc_subIva", subIva);
        setText("fc_desc", descTotal);
        setText("fc_iva", iva);
        setText("fc_total", total);

        // preview
        setText("pv_sub0", sub0);
        setText("pv_subIva", subIva);
        setText("pv_desc", descTotal);
        setText("pv_iva", iva);
        setText("pv_total", total);

        // detalle preview
        const pvt = document.getElementById("pv_tbody");
        pvt.innerHTML = "";
        items.forEach((it) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${escapeHtml(it.desc)}</td>
      <td class="mini">${it.cant}</td>
      <td class="mini">$${Number(it.pu).toFixed(2)}</td>
      <td class="mini">${Number(it.descPct).toFixed(0)}%</td>
      <td class="mini">${it.gravaIva ? "12%" : "0%"}</td>
      <td>$${fcImporte(it).toFixed(2)}</td>
    `;
          pvt.appendChild(tr);
        });

        updatePreview();
      }

      function setText(id, val) {
        const el = document.getElementById(id);
        if (el) el.textContent = `$${Number(val || 0).toFixed(2)}`;
      }

      function updatePreview() {
        const v = (id) => document.getElementById(id)?.value || "";
        const set = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text || "‚Äî";
        };
        set(
          "pv_fecha",
          (document.getElementById("fc_fecha")?.value || "").replace("T", " ")
        );
        set("pv_cliente", v("fc_cliente"));
        set("pv_ident", v("fc_ident"));
        set("pv_email", v("fc_email"));
        set("pv_sucursal", v("fc_sucursal"));
        const tipo = document.getElementById("fc_tipo")?.value || "FACTURA";
        const pvt = document.getElementById("pv_tipo");
        if (pvt) pvt.textContent = tipo;
      }

      [
        "fc_cliente",
        "fc_ident",
        "fc_email",
        "fc_sucursal",
        "fc_tipo",
        "fc_fecha",
      ].forEach((id) => {
        document.addEventListener("input", (e) => {
          if (e.target && e.target.id === id) updatePreview();
        });
        document.addEventListener("change", (e) => {
          if (e.target && e.target.id === id) updatePreview();
        });
      });

      /* === Acciones ================================================== */

      function fcGuardarBorrador() {
        const data = fcCollect();
        if (!data.items.length) {
          alert("Agrega al menos un √≠tem.");
          return;
        }
        data.estado = "BORRADOR";
        window.__FC_STATE.historial.unshift(data);
        fcRenderHistorial();
        alert("Borrador guardado (local).");
      }

      function fcEmitir() {
        const data = fcCollect();
        if (!data.items.length) {
          alert("Agrega al menos un √≠tem.");
          return;
        }

        // validaciones simples
        if (!document.getElementById("fc_consumidorFinal").checked) {
          if (!data.cliente || !data.identificacion) {
            alert(
              'Completa Cliente e Identificaci√≥n, o marca "Consumidor final".'
            );
            return;
          }
        }

        data.estado = "EMITIDA";
        window.__FC_STATE.historial.unshift(data);
        fcRenderHistorial();
        alert("Factura emitida (mock). Aqu√≠ llamar√≠as a tu backend/EFact.");
        fcNueva(false);
      }

      function fcAnular() {
        if (!confirm("¬øAnular la edici√≥n actual?")) return;
        fcNueva(false);
      }

      function fcNueva(notify = true) {
        document.getElementById("fc_cliente").value = "";
        document.getElementById("fc_ident").value = "";
        document.getElementById("fc_email").value = "";
        document.getElementById("fc_notas").value = "";
        document.getElementById("fc_consumidorFinal").checked = false;
        document.getElementById("fc_tipo").value = "FACTURA";
        document.getElementById("fc_fecha").value = new Date()
          .toISOString()
          .slice(0, 16);
        window.__FC_STATE.items = [];
        fcRenderItems();
        if (notify) alert("Limpio. Listo para una nueva factura.");
      }

      function fcCollect() {
        const items = window.__FC_STATE.items.map((i) => ({
          descripcion: i.desc,
          cantidad: Number(i.cant),
          precioUnit: Number(i.pu),
          descuentoPct: Number(i.descPct),
          gravaIva: !!i.gravaIva,
          importe: Number(fcImporte(i).toFixed(2)),
        }));
        // totales
        let sub0 = 0,
          subIva = 0;
        items.forEach((i) =>
          i.gravaIva ? (subIva += i.importe) : (sub0 += i.importe)
        );
        const iva = Number((subIva * IVA_PORC).toFixed(2));
        const total = Number((sub0 + subIva + iva).toFixed(2));
        const descuento = Number(
          items
            .reduce((a, i) => {
              const bruto = i.cantidad * i.precioUnit;
              return a + (bruto - i.importe);
            }, 0)
            .toFixed(2)
        );

        return {
          fecha: (document.getElementById("fc_fecha")?.value || "").replace(
            "T",
            " "
          ),
          tipo: document.getElementById("fc_tipo")?.value || "FACTURA",
          sucursal: document.getElementById("fc_sucursal")?.value || "Matriz",
          cliente: document.getElementById("fc_cliente")?.value || "",
          identificacion: document.getElementById("fc_ident")?.value || "",
          email: document.getElementById("fc_email")?.value || "",
          notas: document.getElementById("fc_notas")?.value || "",
          metodo: document.getElementById("fc_metodo")?.value || "Efectivo",
          items,
          totales: { sub0, subIva, descuento, iva, total },
        };
      }

      function fcRenderHistorial() {
        const cont = document.getElementById("fc_hist");
        if (!cont) return;
        cont.innerHTML = "";
        (window.__FC_STATE.historial || []).slice(0, 6).forEach((f, i) => {
          const card = document.createElement("div");
          card.className = "card";
          card.style.cursor = "pointer";
          card.onclick = () => fcCargarDesdeHist(i);
          card.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <div style="font-weight:700">${f.tipo} ‚Ä¢ ${f.sucursal}</div>
          <div class="mini muted">${f.fecha}</div>
          <div class="mini">${f.cliente || "Consumidor final"}</div>
        </div>
        <div style="text-align:right">
          <div class="badge ${
            f.estado === "EMITIDA" ? "tag-success" : "tag-warn"
          }">${f.estado}</div>
          <div style="margin-top:.25rem; font-weight:700">$${f.totales.total.toFixed(
            2
          )}</div>
        </div>
      </div>
    `;
          cont.appendChild(card);
        });
      }

      function fcCargarDesdeHist(idx) {
        const f = window.__FC_STATE.historial[idx];
        if (!f) return;
        document.getElementById("fc_cliente").value = f.cliente || "";
        document.getElementById("fc_ident").value = f.identificacion || "";
        document.getElementById("fc_email").value = f.email || "";
        document.getElementById("fc_notas").value = f.notas || "";
        document.getElementById("fc_tipo").value = f.tipo || "FACTURA";
        const iso = f.fecha
          ? f.fecha.replace(" ", "T")
          : new Date().toISOString().slice(0, 16);
        document.getElementById("fc_fecha").value = iso;
        document.getElementById("fc_sucursal").value = f.sucursal || "Matriz";

        window.__FC_STATE.items = (f.items || []).map((it) => ({
          desc: it.descripcion,
          cant: it.cantidad,
          pu: it.precioUnit,
          descPct: it.descuentoPct,
          gravaIva: it.gravaIva,
        }));
        fcRenderItems();
      }

      /* util */
      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }
    </script>
  </body>
</html>
